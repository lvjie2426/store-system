<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <title>眼睛-商品管理-调货</title>
    <!--Bootstrap样式引入开始-->
    <link rel="stylesheet" href="../resource/css/bootstrap.min.css">
    <link href="../resource/js/plugins/bootstarp-table/css/bootstrap-table.min.css" rel="stylesheet">
    <link href="../resource/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">
    <link href="../resource/layui/css/layui.css" rel="stylesheet">
    <!--字体样式文件引用开始-->
    <link rel="stylesheet" href="../resource/fonts/iconfont.css">
    <!--字体样式文件引用结束-->
    <!--标签样式重置开始-->
    <link rel="stylesheet" href="../resource/css/reset.css">
    <link rel="stylesheet" href="../resource/css/style.css">
    <link rel="stylesheet" href="../resource/css/common.css">
    <!--标签样式重置结束-->
    <!--本页面样式开始-->
    <link rel="stylesheet" href="../resource/css/yanjing/goodsManage.css">
    <link rel="stylesheet" href="../resource/css/yanjing/diaohuo.css">
    <link rel="stylesheet" href="../resource/css/yanjing/chuku.css">
    <link rel="stylesheet" href="../resource/css/yanjing/statistics.css">

    <!--本页面样式结束-->
    <style>
        body {
            background-color: #ECECF3;
        }
    </style>
</head>
<body>
<div class="yj-header">
    <ul class="tab-ul">
        <li onclick="choose(this,1)" class="active">发起的调货</li>
        <li onclick="choose(this,2)">调货请求</li>
    </ul>
    <div class="yj-header-right">
        <button class="btn btn-primary" onclick="addGoods()">新增调货</button>
    </div>
</div>
<div class="goods-header">
    <div class="selectBox" id="select-form">
        <div class="yj-header-time" id="select-date">
            <div class="yj-date">
                <span>开始时间-结束时间</span><i class="iconfont icon-ico_calendar"></i>
            </div>
        </div>
    </div>
</div>
<div class="goods-body">
    <ul class="contUl" id="showUl">

    </ul>
    <table id="yj-table" data-toggle="table" class="table table-border"></table>
</div>

<div class="content-view content-view-outbound content-view-enter" id="addDom">

</div>



<!--查看调货单开始-->
<div class="content-cargo-view content-view">
    <div class="cargo-content" id="diaohuoDom">

    </div>
    <div class="log-false">
        <div class="selectBox" id="yj-log">
            <div class="select-box-header">
                <span class="text">物流服务商</span> <i class="iconfont icon-ico_arrow_down" id=""></i>
            </div>
            <div class="optionBox">
                <ul class="optionUL">
                    <li value="圆通">圆通</li>
                    <li value="申通">申通</li>
                    <li value="顺丰">顺丰</li>
                    <li value="邮政">邮政</li>
                </ul>
            </div>
        </div>
        <input type="number" class="log-num" placeholder="物流单号" />
    </div>
    <div class="log-true">
        顺丰: 2397186457839
    </div>
</div>
<!--查看调货单结束-->
<!--删除调货开始-->
<div class="delete-cargo">
    <div class="del-cargo-header">删除调货</div>
    <div class="del-cargo-content">确定删除调货？</div>
    <div class="del-cargo-bot">
        <div class="btn-y">确定</div>
        <div class="btn-n" onclick="layer.closeAll()">取消</div>
    </div>
</div>
<!--删除调货结束-->

<!--js依赖开始-->
<!--bootstrap依赖于jQuery，jQuery.js必须放在BS.js之前-->
<script src="../resource/js/jquery.min.js"></script>
<script src="../resource/js/bootstrap.js"></script>
<!--js依赖结束-->

<!-- Bootstrap table -->
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table.js"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table-zh-CN.min.js"></script>

<script src="../resource/js/plugins/layer/layer.js"></script>
<script src="../resource/layui/layui.js"></script>


<script src="../resource/js/lib/quakooLib/QuakooBase-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooConfig-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooBasePc-1.0.0.js"></script>
<script src="../resource/js/lib/quakoo/Config.js"></script>
<script src="../resource/js/lib/quakoo/project.js"></script>
<script src="../resource/common/common.js?" +Math.random()></script>

<script src="../resource/js/yanjing/yanjing.js"></script>
<script src="../resource/js/yanjing/daterange.js"></script>
<script src="../resource/js/template-native.js"></script>


<!--下拉选择模板-->
<script type="text/html" id="selectTagTmp">
    <div class="select-box-header">
        <span class="text"><%=title%></span> <i class="iconfont icon-ico_arrow_down"></i>
    </div>
    <div class="optionBox">
        <ul class="optionUL">
            <%for(var i=0;i< list.length;i++){%>
            <li value="<%=list[i].id%>" data-pnid="<%if(list[i].pnid){%><%=list[i].pnid%><%}%>">
                <%if(list[i].name){%><%=list[i].name%><%}else{%><%=list[i].content%><%}%>
            </li>
            <%}%>
        </ul>
    </div>
</script>
<script type="text/html" id="dataTmp">
    <%for(var i=0;i< list.length;i++){%>
    <li class="item">
        <div class="head">
            <span class="mainCont-head-left"><%=list[i].time%></span>
            <span>发起人:<em><%=list[i].inUserName%></em></span>
        </div>
        <div class="body">
            <div class="top">
                <ul>
                    <%if(list[i].clientItems.length>5){%>
                    <%for(var j=0;j< list[i].clientItems.length;j++){%>
                    <%if(j< 4 ){%>
                    <li>
                        <span class="txtOverflow"><%=list[i].clientItems[j].seriesName%><%=list[i].clientItems[j].code%></span>
                        <span>X<%=list[i].clientItems[j].num%></span>
                    </li>
                    <%}%>
                    <%}%>
                    <li style="color:#828297">
                        ...
                    </li>
                    <%}else{%>
                    <%for(var j=0;j< list[i].clientItems.length;j++){%>
                    <li>
                        <span class="txtOverflow"><%=list[i].clientItems[j].seriesName%><%=list[i].clientItems[j].code%></span>
                        <span>X<%=list[i].clientItems[j].num%></span>
                    </li>
                    <%}%>
                    <%}%>
                </ul>
            </div>
            <div class="bottom">
                <div>共<%=list[i].clientItems.length%>种商品</div>
                <div>数量总计:<%=list[i].clientItemsNum%></div>
            </div>
        </div>
        <div class="foot">
            <%if(list[i].did){%>
            <span class="txt"><%=list[i].did%></span>
            <%}else{%>
            <span class="txt">暂无单号</span>
            <%}%>
            <%if(list[i].status==0){%>
            <button class="btn btn-danger" style="margin-left: 10px;" type="button" onclick="delDiaohuo('<%=list[i].id%>')">删除</button>
            <button class="btn btn-primary" type="button" onclick="addGoods('<%=list[i].id%>')">编辑</button>
            <%}else if(list[i].status==1){%>
                <%if(diaohuotype==1){%>
                <button class="btn btn-danger" type="button" onclick="lookRepertory('<%=list[i].id%>',false)">等待确认</button>
                <%}else{%>
                <button class="btn btn-danger" type="button" onclick="lookRepertory('<%=list[i].id%>',false)">确认调货</button>
                <%}%>
            <%}else if(list[i].status==2){%>
            <button class="btn btn-order" type="button" onclick="lookRepertory('<%=list[i].id%>',true)">查看</button>
            <%}%>
        </div>
    </li>
    <%}%>
</script>
<script type="text/html" id="addTmp">
    <div class="leftBox">
        <div class="body">
            <ul class="tab-ul" id="yj-category">
                <%for(var i=0;i< categoryData.length;i++){%>
                <%if(categoryData[i].name!='特殊商品'){%>
                <li id="category<%=categoryData[i].id%>" onclick="chooseGoodsType('<%=categoryData[i].id%>')"><%=categoryData[i].name%></li>
                <%}%>
                <%}%>
            </ul>
            <ul class="tab-content-list">
                <li class="tab-content-item active">
                    <div class="outbound-left-body">
                        <div class="outbound-body-option">
                            <div class="selectBox" id="out-brand">
                                <div class="select-box-header">
                                    <span class="text">品牌</span> <i class="iconfont icon-ico_arrow_down"></i>
                                </div>
                                <div class="optionBox" style="display: none;">
                                    <ul class="optionUL">
                                        <%for(var i=0;i< brandData.length;i++){%>
                                        <li value="<%=brandData[i].id%>"><%=brandData[i].name%></li>
                                        <%}%>
                                    </ul>
                                </div>
                            </div>
                            <div class="selectBox" id="out-series">
                                <div class="select-box-header">
                                    <span class="text">系列</span> <i class="iconfont icon-ico_arrow_down"></i>
                                </div>
                                <div class="optionBox" style="display: none;">
                                    <ul class="optionUL">

                                    </ul>
                                </div>
                            </div>
                            <div class="selectBox" id="out-provider">
                                <div class="select-box-header">
                                    <span class="text">供应商</span> <i class="iconfont icon-ico_arrow_down"></i>
                                </div>
                                <div class="optionBox" style="display: none;">
                                    <ul class="optionUL">
                                        <%for(var i=0;i< providerData.length;i++){%>
                                        <li value="<%=providerData[i].id%>"><%=providerData[i].name%></li>
                                        <%}%>
                                    </ul>
                                </div>
                            </div>
                            <div class="selectBox" id="out-type">
                                <div class="select-box-header">
                                    <span class="text">常规商品</span> <i class="iconfont icon-ico_arrow_down"></i>
                                </div>
                                <div class="optionBox" style="display: none;">
                                    <ul class="optionUL">
                                        <li value="0">常规商品</li>
                                        <li value="1">积分商品</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="selectBox jj-box" id="out-caizhi">
                                <div class="select-box-header">
                                    <span class="text">材质</span> <i class="iconfont icon-ico_arrow_down"></i>
                                </div>
                                <div class="optionBox">
                                    <ul class="optionUL">
                                        <li value="01">材质A</li>
                                        <li value="05">材质E</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="btn btn-info" style="float: right" onclick="getSpu()">查询</div>


                        </div>
                        <div class="outbound-body-tag">
                            <div class="tag-list">A品牌A系列</div>
                            <div class="tag-list">B品牌$系列</div>
                            <div class="tag-list">F品牌0系列</div>
                        </div>
                        <div class="outbound-body-content outbound-body-top-hidden">
                            <span class="jp-box text-default">请先选择门店、品牌和系列</span>
                            <input class="jp-no-box" type="number" placeholder="搜索关键字">
                            <div class="btn btn-info fr" onclick="addToList()">添加至出库单</div>
                        </div>
                        <div class="outbound-body-top-show clearfix">
                            <div class="text-end clearfix">
                                <span>A品牌A系列</span>
                                <ul class="tab-lr clearfix">
                                    <li class="tab-lr-item active">右</li>
                                    <li class="tab-lr-item">左</li>
                                </ul>
                            </div>
                            <div class="btn btn-info">添加至出库单</div>
                        </div>
                    </div>
                </li>

            </ul>

            <div class="out-table1">
                <table class="layui-hide yj-layui-table" id="outboundTable" lay-filter="outboundEvent"></table>
            </div>
            <div class="out-table2">
                <table class="table table-self" id="out-table" lay-filter="in-table"></table>
            </div>

        </div>
    </div>
    <!--右边-->
    <div class="rightBox">
        <div class="body" id="outListDom">

        </div>
    </div>
</script>
<script type="text/html" id="outListTmp">
    <%for(var i in list){%>
    <%if(list[i].data.length>0){%>
    <!--<div class="itemDiv">-->
    <div class="itemDiv _scroll">
        <p class="name"><%=list[i].name%></p>
        <div class="box">
            <div class="thead">
                <span>产品编码</span>
                <span>品牌</span>
                <span>系列</span>
                <span>商品类型</span>
                <span>数量</span>
                <%if(showTool){%>
                <span class="removeLi">操作</span>
                <%}%>
            </div>
            <ul class="tbody">
                <%for(var j=0;j< list[i].data.length;j++){%>
                <li>
                    <span><%=list[i].data[j].code%></span>
                    <span><%=list[i].data[j].brandName%></span>
                    <span><%=list[i].data[j].seriesName%></span>
                    <%if(list[i].data[j].type==0){%>
                    <span>常规商品</span>
                    <%}else{%>
                    <span>积分商品</span>
                    <%}%>
                    <span><%=list[i].data[j].num%></span>
                    <%if(showTool){%>
                    <span class="remove" onclick="removeOutLi('<%=i%>','<%=j%>')">移除</span>
                    <%}%>
                </li>
                <%}%>
            </ul>
        </div>
    </div>
    <%}%>
    <%}%>
</script>
<script>

    var subid = quakooUser.getUserInfo().psid;//企业/公司id
    var shopId = quakooDb.getItem('sel_ShopId');//门店id

    var diaohuotype = 1;//1发起的调货，  2调货请求
    var shopData = [];//门店数据
    var allData = {};//页面请求回来的所有数据

    var categoryData = [];//一级类目数据
    var brandData = [];//品牌数据
    var providerData = [];//供应商数据
    var ballData = [];//球数据
    var columnData = [];//柱数据
    var peopleData = [];//员工数据
    var cid;            //一级类目id
    var allOutList = {};//全部数据
    var peopleId;//发起人id
    var selectSid;//筛选的门店id

    var startTime;//筛选时间开始时间
    var endTime;//筛选时间结束时间

    var pid;//添加入库时的供应商id
    var bid;//添加入库时的品牌id
    var sid = -1;
    var type = 0;// 0常规商品，1积分商品

    var nowGoodData;//查询出来的sku数据
    var brandName = '';
    var seriesName = '';
    var providerName = '';
    var reqUrl = config.getUrl_inventoryInvokeBill_getCreatePager();



    var selectDate = new dateRange("#select-date");
    selectDate.init()
    $('#select-date button').click(function () {
        startTime = selectDate.getTime()[2];
        endTime = selectDate.getTime()[3];
        getInData()
    })

    //获取一级类目
    quakooData.ajaxGetData(config.getUrl_productCategory_getSubAllList(),{subid:subid},function (ret) {
        if(ret && ret.success){
            categoryData = ret.data;
        }
    })
    //获取品牌数据
    quakooData.ajaxGetData(config.getUrl_productBrand_getSubAllList(),{},function (ret) {
        if(ret && ret.success){
            brandData = ret.data;
        }
    })
    //获取属性-球
    quakooData.ajaxGetData(config.getUrl_productPropertyvalue_getAllList(),{pnid:15},function (ret) {
        if(ret && ret.success){
            ballData = ret.data.sort(function (a,b) {
                return b.content-a.content;
            });
        }
    })
    //获取供应商
    function getSupplier(shopId){
        quakooData.ajaxGetData(config.getUrl_productProvider_getSubAllList(),{subid:shopId},function (ret) {
            if(ret && ret.success){
                providerData = ret.data;
            }
        })
    }
    getSupplier(shopId);
    //获取属性-柱
    quakooData.ajaxGetData(config.getUrl_productPropertyvalue_getAllList(),{pnid:16},function (ret) {
        if(ret && ret.success){
            columnData = ret.data.sort(function (a,b) {
                return b.content-a.content;
            });
        }
    })
    //获取门店所有顾客-不分页
    quakooData.ajaxGetData(config.getUrl_user_getAllUser(), {sid: shopId, userType: 1}, function (ret) {
        if (ret && ret.success) {
            peopleData = ret.data;
        }
    })
    //获取当前企业下门店列表
    quakooData.ajaxGetData(config.getUrl_subordinate_getSubordinateStore(),{sid:subid},function (ret) {
        if(ret&&ret.success){
            if(quakooUtils.isNotBlack(ret.data)){
                shopData = ret.data;
            }
        }
    });

    getInData()
    //获取数据
    function getInData() {
        $("#yj-table").bootstrapTable('destroy');
        $("#yj-table").bootstrapTable({
            url: reqUrl,
            classes: "table",
            pagination: true,        //是否显示分页
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 6,
            pageList: [6, 12, 18],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            // paginationLoop:false,        //分页是否可以循环
            columns: [],
            queryParams: function (param) {
                if(reqUrl==config.getUrl_inventoryInvokeBill_getCreatePager()){
                    param.createUid = quakooUser.getUserInfo().id;
                }else{
                    param.subid = shopId;
                }
                param.token = quakooUser.getUserInfo().token;
                if (startTime) {
                    param.startTime = startTime;
                }
                if (endTime) {
                    param.endTime = endTime;
                }
                return param
            },
            onPreBody: function (data) {
                console.log(data)
                var arr = [];
                for (var i = (this.pageNumber - 1) * this.pageSize; i < this.pageNumber * this.pageSize; i++) {
                    if (this.data[i]) {
                        this.data[i].time = quakooUtils.formatTimeToDateDian(this.data[i].ctime);
                        this.data[i].clientItemsNum = 0;
                        for (var j = 0; j < this.data[i].clientItems.length; j++) {
                            this.data[i].clientItemsNum += this.data[i].clientItems[j].num;
                        }
                        arr.push(this.data[i])
                        allData[this.data[i].id] = this.data[i]
                    }
                }
                var html = template('dataTmp', {list: arr,diaohuotype:diaohuotype})
                $("#showUl").html(html);
            }
        });
    }

    //0发起调货   1调货请求
    function choose(self, value) {
        diaohuotype = value;
        if(value == 1){
            reqUrl = config.getUrl_inventoryInvokeBill_getCreatePager();
        }else{
            reqUrl = config.getUrl_inventoryInvokeBill_getCheckPager();
        }
        getInData()
        $(self).addClass('active').siblings().removeClass('active')
    }

    /**
     * 打开新增调货弹窗
     * */
    function addGoods(id) {
        allOutList = {};
        var outSubName = '门店';
        var inUserName = '发起人';
        if(id){
            inUserName = allData[id].inUserName;
            outSubName = allData[id].outSubName;
            selectSid = allData[id].outSubid;
            peopleId = allData[id].inUid;
            for(var i=0;i<allData[id].clientItems.length;i++){
                if(allOutList[allData[id].clientItems[i].cid]){
                    allOutList[allData[id].clientItems[i].cid].data.push(allData[id].clientItems[i]);
                }else{
                    allOutList[allData[id].clientItems[i].cid] = {cid:allData[id].clientItems[i].cid,name:allData[id].clientItems[i].categoryName,data:[allData[id].clientItems[i]]}
                }
            }
        }else{
            selectSid = '';
            peopleId = '';
        }

        var html = [];
        html.push('<div class="leftBox leftBoxTitle leftSetGoods"> <div class="head"> <span class="title" style="width: auto">添加调货单</span>');
        html.push('<div class="selectBox" id="out-shop"><div class="select-box-header"><span class="text">'+outSubName+'</span><i class="iconfont icon-ico_arrow_down" id="jt"></i>')
        html.push('</div><div class="optionBox"><ul class="optionUL">')
        for (var i = 0; i < shopData.length; i++) {
            if(shopId!=shopData[i].id){
                html.push('<li value="' + shopData[i].id + '">' + shopData[i].name + '</li>');
            }
        }
        html.push('</ul></div></div><span class="person">选择门店</span>')
        html.push('</div></div>')
        html.push('<div class="rightBox leftBoxTitle"> <div class="head"> <span class="title">调货单</span> ');
        html.push('<div class="selectBox" id="out-people">')
        html.push('<div class="select-box-header"><span class="text">'+inUserName+'</span> <i class="iconfont icon-ico_arrow_down"></i></div><div class="optionBox"><ul class="optionUL">')
        for (var i = 0; i < peopleData.length; i++) {
            html.push('<li value="' + peopleData[i].id + '">' + peopleData[i].name + '</li>');
        }
        html.push('</ul></div></div><span class="person">发起人:</span></div></div>')
        layer.open({
            type: 1, shade: 0.01, title: html.join(''),
            skin: 'layui-layer-outbound  content-view-enter-tan', //样式类名
            area: ['960px', '560px'],
            anim: 0,
            move: '.title',
            closeBtn: 0, //不显示关闭按钮
            resize: false,
            shadeClose: true, //开启遮罩关闭
            content: $('.content-view-outbound'),
            btn: ['关闭窗口', '确认调货'],
            success: function (layero, index) {
                var html = [];
                html.push('<div class="leftBox"><div class="foot"><a class="layui-layer-btn0">关闭窗口</a></div></div>')
                html.push('<div class="rightBox"><div class="foot"><a class="layui-layer-btn1">确认调货</a></div></div>')
                $('.content-view-enter-tan .layui-layer-btn').html(html.join(''))

                addRepertorySuccess(index,id)
            }
        });
    }
    function addRepertorySuccess(index,id) {
        var html = template('addTmp',{brandData:brandData,categoryData:categoryData,ballData:ballData,columnData:columnData,providerData:providerData})
        $('#addDom').html(html);

        //编辑的话，赋初值
        if(id){
            $("#outListDom").html(template('outListTmp',{list:allOutList,showTool:true}))
        }

        $('.content-view-enter-tan .layui-layer-btn .layui-layer-btn0').click(function () {
            addOutList(0,index,id);
        });
        $('.content-view-enter-tan .layui-layer-btn .layui-layer-btn1').click(function () {
            addOutList(1,index,id)
        });
        $('#yj-category li').eq(0).click()
        selectTag($("#out-brand"), function (ret) {
            if(ret.value){
                bid = ret.value;
                brandName = ret.text;
                sid = -1;
                $('#out-series').html('');
                //获取品牌下的系列列表
                quakooData.ajaxGetData(config.getUrl_productSeries_getSubAllList(),{bid:ret.value},function (ret1) {
                    if(ret1 && ret1.success){
                        var html2 = template('selectTagTmp',{title:'系列',list:ret1.data});
                        $('#out-series').html(html2).show();
                        selectTag($("#out-series"),function (series) {
                            sid = series.value;
                            seriesName = series.text;
                        })
                    }
                })
            }
        })
        //门店
        selectTag($("#out-shop"), function (ret) {
            selectSid = ret.value;
            getSupplier(selectSid);
        })
        //调货人
        selectTag($("#out-people"), function (ret) {
            peopleId = ret.value;
        })
        //供应商
        selectTag($("#out-provider"), function (ret) {
            pid = ret.value;
            providerName = ret.text;
        })
        //商品类型
        selectTag($("#out-type"), function (ret) {
            type = ret.value;
        })
    }

    //选择一级类目
    function chooseGoodsType(value){
        cid = value;
        if(!allOutList[cid]){
            allOutList[cid] = {cid:cid,name:$('#category'+value).text(),data:[]}
        }
        $('#category'+value).addClass('active').siblings().removeClass('active');
        if($('#category'+value).text()=='镜片'){
            $('.out-table1').show();
            $('.out-table2').hide();
            $('.jj-box').hide();
            $('.jp-box').show();
            $('.jp-no-box').hide();

        }else{
            $('.out-table1').hide();
            $('.out-table2').show();
            $('.jp-box').hide();
            $('.jp-no-box').show();
            if($('#category'+value).text()=='镜架' || $('#category'+value).text()=='太阳镜' || $('#category'+value).text()=='护理产品'){
                $('.jj-box').show();
            }else{
                $('.jj-box').hide();
            }
            $("#out-table").bootstrapTable('destroy');
        }
    }
    var skuObj;//镜片所需要的sku集合   键 是球+柱
    // 获取一个商品的SPU，返回需要确定的所有SKU属性
    function getSpu() {
        if(!selectSid){
            layer.msg('请选择门店')
            return
        }
        if(!bid){
            layer.msg('请选择品牌')
            return
        }
        if(!pid){
            layer.msg('请选择供应商')
            return
        }
        quakooData.ajaxGetData(config.getUrl_inventoryInvokeBill_select(),{subid:selectSid,type:type,cid:cid,pid:pid,bid:bid,sid:sid},function (ret) {
            if(ret && ret.success){
                console.log(ret)
                nowGoodData = ret.data;
                skuObj = {};
                for(var j=0;j<nowGoodData.length;j++){
                    if(nowGoodData[j].p_properties){
                        nowGoodData[j].properties = nowGoodData[j].p_properties;
                    }
                    nowGoodData[j].code = nowGoodData[j].p_code;
                    nowGoodData[j].type = nowGoodData[j].p_type;
                    if(nowGoodData[j].properties){
                        skuObj[nowGoodData[j].properties[15]+''+nowGoodData[j].properties[16]] = nowGoodData[j];
                    }
                }
                if(ret.data){
                    if($('#category'+cid).text()=='镜片'){
                        var cols = [[], []];//球
                        var rangeData = [];//柱
                        cols[0].push({field:'num',rowspan:2,unresize:true, minWidth:60,align:'center', title: '<div class="yj-layui-table-header"><span>球</span><span>柱</span></div>', fixed: 'left'})
                        for(var i=0;i<ballData.length;i++){
                            (function (i) {
                                cols[0].push({align: 'center', title:ballData[i].content, colspan: 2,unresize:true})
                                cols[1].push({field: '', title: '库存', width: 60,unresize:true ,templet: function (value,row,index) {
                                        if(skuObj[ballData[i].content + '' + value.num]){
                                            return skuObj[ballData[i].content + '' + value.num].num
                                        }else{
                                            return '-'
                                        }
                                    }})
                                cols[1].push({field: '', title: '调货', width: 60,edit:'text',unresize:true})
                            })(i)
                        }
                        for(var i=0;i<columnData.length;i++){
                            rangeData.push({num:columnData[i].content,id:columnData[i].id})
                        }
                        layui.use('table', function () {
                            var table = layui.table;
                            table.render({
                                elem: '#outboundTable'
                                , data: rangeData
                                , width: 488
                                , height: 260
                                , unresize: true
                                , cols: cols
                            });
                            //监听单元格事件
                            table.on('edit(outboundEvent)', function (obj) { //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
                                if(parseInt($(this).parents('td').prev().find('.layui-table-cell').html())>0){
                                    var ball = ballData[Math.floor($(this).parents('td').attr('data-key').split('-')[$(this).parents('td').attr('data-key').split('-').length-1]/2)].content;
                                    var colum = obj.data.num;
                                    if(skuObj[ball + '' + colum].num>= obj.value){
                                        skuObj[ball + '' + colum].newNum = obj.value;
                                    }else{
                                        skuObj[ball + '' + colum].newNum = skuObj[ball + '' + colum].num;
                                        this.value = skuObj[ball + '' + colum].num;
                                    }
                                }else{
                                    this.value = '';
                                    layer.msg('该规格暂无库存');
                                }
                            });
                        });
                    }else {
                        var column = [
                            { field: 'code', title: '产品编码'},
                            { field: 'properties', title: '球' , formatter: function (value) {
                                    return value?value[15]:'-';
                                }  },
                            { field: 'properties', title: '柱', formatter: function (value) {
                                    return value?value[16]:'-';
                                }},
                            {field: 'num', title: '库存量' },
                            {field: '', title: '调货量'  , formatter: function (value,row,index) {
                                    return '<input type="text" class="in-yj-input" onkeyup="checkNum(this)" data-index="'+index+'" placeholder="数量">';
                                }
                            }
                        ]
                        $("#out-table").bootstrapTable('destroy');
                        $("#out-table").bootstrapTable({
                            data: nowGoodData,                 //被加载的数据。
                            classes: "table",
                            sortable: false,
                            sortOrder: "asc",
                            showColumns: true,
                            strictSearch: true,
                            locale: "zh-CN",
                            paginationHAlign: "center",
                            clickToSelect: true,
                            columns: column
                        });
                    }
                }else{
                    layer.msg('暂无商品')
                }
            }else{
                layer.msg(ret.data)
            }
        })
    }
    //添加到本地出库单
    function addToList() {
        if(quakooUtils.isBlack(nowGoodData)){
            layer.msg('请查询商品')
            return
        }
        $('.in-yj-input').each(function (index,item) {
            if(quakooUtils.isNotBlack(item.value)){
                nowGoodData[item.getAttribute('data-index')].newNum = item.value;
            }
        })
        var arr = [];
        if($('#category'+cid).text()=='镜片'){
            for(var i=0;i<nowGoodData.length;i++){
                if(nowGoodData[i].properties){
                    if(skuObj[nowGoodData[i].properties[15]+''+nowGoodData[i].properties[16]] && skuObj[nowGoodData[i].properties[15]+''+nowGoodData[i].properties[16]].newNum){
                        nowGoodData[i].num = skuObj[nowGoodData[i].properties[15]+''+nowGoodData[i].properties[16]].newNum;
                        nowGoodData[i].brandName = brandName;
                        nowGoodData[i].seriesName = seriesName;
                        nowGoodData[i].providerName = providerName;
                        arr.push(nowGoodData[i])
                    }
                }
            }
        }else{
            for(var i=0;i<nowGoodData.length;i++){
                if(nowGoodData[i].newNum){
                    nowGoodData[i].brandName = brandName;
                    nowGoodData[i].seriesName = seriesName;
                    nowGoodData[i].providerName = providerName;
                    nowGoodData[i].num = nowGoodData[i].newNum;
                    arr.push(nowGoodData[i])
                }
            }
        }
        if(arr.length<=0){
            layer.msg('请输入调货数量')
            return;
        }
        allOutList[cid].data = arr;
        var html = template('outListTmp',{list:allOutList,showTool:true})
        $("#outListDom").html(html)
    }
    //添加调货单
    function addOutList(status,index,id) {
        var closeFlag = true;
        for(var i in allOutList){
            if(allOutList[i].data.length>0){
                closeFlag = false;
                break ;
            }
        }
        if(closeFlag){
            layer.close(index)
            return ;
        }
        if(!peopleId){
            layer.msg('选择发起人');
            return
        }
        var params = {};
        if(id){
            params.id = id;
            params.wid = allData[id].wid;
        }
        params.status = status;
        params.outSubid = selectSid;
        params.inSubid = shopId;
        params.inUid = peopleId;
        params.createUid = quakooUser.getUserInfo().id;
        params.itemsJson = [];
        for(var i in allOutList){
            if(allOutList[i].data){
                for(var j=0;j<allOutList[i].data.length;j++){
                    var obj = {};
                    if(id){
                        obj.did = allOutList[i].data[j].did;
                    }else{
                        obj.did = allOutList[i].data[j].id;
                    }
                    obj.num = allOutList[i].data[j].num;
                    params.itemsJson.push(obj)
                }
            }
        }
        params.itemsJson = JSON.stringify(params.itemsJson)
        if(id){
            quakooData.ajaxGetData(config.getUrl_inventoryInvokeBill_update(),params,function (ret) {
                if(ret && ret.success){
                    layer.msg('修改成功',{icon: 1})
                    layer.close(index)
                    getInData()
                }else{
                    layer.msg(ret.data,{icon: 2})
                }
            })
        }else{
            quakooData.ajaxGetData(config.getUrl_inventoryInvokeBill_add(),params,function (ret) {
                if(ret && ret.success){
                    layer.msg('添加成功',{icon: 1})
                    layer.close(index)
                    getInData()
                }else{
                    layer.msg(ret.data,{icon: 2})
                }
            })
        }
    }


    /**查看调货单弹窗*/
    function lookRepertory(id,look) {
        allOutList = {};
        var outSubName = '门店';
        var inUserName = '发起人';
        if(id){
            inUserName = allData[id].inUserName;
            outSubName = allData[id].outSubName;
            for(var i=0;i<allData[id].clientItems.length;i++){
                if(allOutList[allData[id].clientItems[i].cid]){
                    allOutList[allData[id].clientItems[i].cid].data.push(allData[id].clientItems[i]);
                }else{
                    allOutList[allData[id].clientItems[i].cid] = {cid:allData[id].clientItems[i].cid,name:allData[id].clientItems[i].categoryName,data:[allData[id].clientItems[i]]}
                }
            }
        }
        var html;
        if(diaohuotype==1 && !look){
            html = '<div class="cargo-header clearfix">\n' +
            '        <div class="cargo-title">调货单</div>\n' +
            '        <div class="cargo-person">\n' +
            '            <span>发起人:</span>\n' +
            '            <span>'+inUserName+'</span>\n' +
            '        </div>\n' +
            '        <div class="cargo-shop">\n' +
            '            <span>被调店铺:</span>\n' +
            '            <span id="carg-shop">'+outSubName+'</span>\n' +
            '        </div>\n' +
            '    </div>';
        }else{
            html = '<div class="cargo-header clearfix">\n' +
                '        <div class="cargo-title">调货单</div>\n' +
                '        <div class="cargo-person">\n' +
                '            <span style="font-weight: normal">'+outSubName+'</span>\n' +
                '            <span id="carg-shop"> · '+inUserName+'</span>\n' +
                '        </div>\n' +
                '    </div>';
        }

        layer.open({
            type: 1, shade: 0.01, title: html,
            move:'cargo-title',
            skin: 'layui-cargo content-cargo content-view-checkRepertory-tan', //样式类名
            area: ['auto', '560px'],
            anim: 0,
            closeBtn: 0, //不显示关闭按钮
            resize: false,
            shadeClose: true, //开启遮罩关闭
            content: $('.content-cargo-view'),
            btn: [''],
            success: function (layero, index) {
                var html = '';
                if(diaohuotype==1){
                    $('.log-true').hide();
                    $('.log-false').hide();
                    html =  '<div class="foot"><span class="_btn layui-layer-btn0">关闭窗口</span></div>';
                }else{
                    html='<div class="foot"><span class="_btn layui-layer-btn0">关闭窗口</span><span class="btn btn-primary fr">完成调货</span></div>'
                    if(look){
                        $('.log-true').show();
                        $('.log-false').hide();
                        html =  '<div class="foot"><span class="_btn layui-layer-btn0">关闭窗口</span></div>';
                    }else{
                        $('.log-true').hide();
                        $('.log-false').show();
                    }
                }

                //物流选择
                selectTag($('#yj-log'),function (ret) {
                    console.log(ret)
                })
                $('.content-cargo .layui-layer-btn').html(html)
                $('.content-cargo .layui-layer-btn0').click(function () {
                    layer.close(index)
                })
                $('.content-cargo .layui-layer-btn .btn-primary').click(function () {
                    //删除出库
                    layer.confirm('完成调货?', {title:'提示',skin:'layui-layer-default',resize:false}, function(index1){
                        quakooData.ajaxGetData(config.getUrl_inventoryInvokeBill_pass(),{id:id,outUid:quakooUser.getUserInfo().id},function (ret) {
                            if(ret && ret.success){
                                layer.msg('确认成功',{icon:1})
                                getInData()
                                layer.close(index1)
                                layer.close(index)
                            }else{
                                layer.msg(data.msg,{icon:2})
                            }
                        })
                    });
                });
                var html1 = template('outListTmp',{list:allOutList,showTool:false})
                $("#diaohuoDom").html(html1)
            }
        });
    }

    function delDiaohuo(id) {
        layer.confirm('删除调货?', {title:'提示',skin:'layui-layer-default',resize:false}, function(index1){
            quakooData.ajaxGetData(config.getUrl_inventoryInvokeBill_del(),{id:id},function (ret) {
                if(ret && ret.success){
                    layer.msg('删除成功',{icon:1})
                    getInData()
                    layer.close(index1)
                    layer.close(index)
                }else{
                    layer.msg(data.msg,{icon:2})
                }
            })
        });
    }

    //检查调货量是否大于出库量
    function checkNum(self) {
        if(self.value > parseInt($(self).parent().prev().text())){
            self.value = parseInt($(self).parent().prev().text())
        }
    }
    //移除出库单中的商品
    function removeOutLi(i,j) {
        allOutList[i].data.splice(j,1);
        var html = template('outListTmp',{list:allOutList,showTool:true})
        $("#outListDom").html(html)
    }

</script>
</body>
</html>


