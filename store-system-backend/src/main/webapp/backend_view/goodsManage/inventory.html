<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <title>盘点</title>
    <link href="../resource/layui/css/layui.css" rel="stylesheet">
    <link href="../resource/css/reset.css" rel="stylesheet">
    <link href="../resource/css/bootstrap.min.css" rel="stylesheet">
    <link href="../resource/js/plugins/bootstarp-table/css/bootstrap-table.min.css" rel="stylesheet">
    <link href="../resource/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">
    <link href="../resource/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../resource/css/animate.css" rel="stylesheet">
    <link href="../resource/css/style.css" rel="stylesheet">
    <link href="../resource/css/common.css" rel="stylesheet">
    <link rel="stylesheet" href="../resource/fonts/iconfont.css">
    <link rel="stylesheet" href="../resource/css/yanjing/goodsManage.css">
    <link rel="stylesheet" href="../resource/css/yanjing/inventory.css">
</head>
<body>
<div class="inventory_cont">
    <div class="header">
      <span>
        <i class="icon iconfont icon-ico_inventory_filled"></i>
      </span>
        <span>商品盘点</span>
        <span onclick="newInventory()">新增盘点</span>
    </div>
    <div class="filter">
        <div class="cont">
            <div class="yj-demo-time" id="select-date">
                <div class="yj-date">
                    <span>开始时间-结束时间</span><i class="iconfont icon-ico_calendar"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="mainCont clearfix goods-body">
        <ul class="contUl clearfix" id="showUl">
            <!--<li class="item">
              <div class="head">
                <span>等待盘点的任务</span>
                <span>发起人:<em>总仓</em></span>
              </div>
              <div class="body">
                <div class="top">
                  <ul>
                    <li>
                      <span class="txtOverflow">HYDRON海昌透明黑色单片年抛</span>
                      <span>X10</span>
                    </li>
                    <li>
                      <span class="txtOverflow">HYDRON海昌透明黑色单片年抛</span>
                      <span>X20</span>
                    </li>
                    <li>
                      <span class="txtOverflow">HYDRON海昌透明黑色单片年抛</span>
                      <span>X200</span>
                    </li>
                    <li>
                      <span class="txtOverflow">商品A</span>
                      <span>-20</span>
                    </li>
                    <li>
                      <span class="txtOverflow">商品B</span>
                      <span>+9</span>
                    </li>
                  </ul>
                </div>
                <div class="bottom">
                  <div>共15种商品</div>
                  <div>数量总计:100</div>
                </div>
              </div>
              <div class="foot">
                <span class="txt">2018.01.21<em>18:49:57</em></span>
                <span class="btn red" onclick="startInvent()">开始盘点</span>
              </div>
            </li>-->
        </ul>
        <table id="yj-table" data-toggle="table" class="table table-border"></table>

    </div>
</div>
<!--新增盘点弹窗-->
<div class="content-view content-view-commonInventory content-view-addInventory clearfix" id="addDom">

</div>
<!--确认盘点弹窗-->
<div class="content-view content-view-addSuccess">
    <p>是否立即进行盘点?</p>
</div>
<!--开始盘点-->
<div class="content-view content-view-commonInventory content-view-startInvent clearfix">
    <!--左边-->
    <div class="leftBox" id="startLeft">

    </div>
    <!--右边-->
    <div class="rightBox" id="startRight">

    </div>
</div>
<!--查看不可盘点弹窗-->
<div class="content-view content-view-commonInventory content-view-checkInvent clearfix">
    <!--左边-->
    <div class="leftBox">
        <div class="head">
            <span class="title layui-layer-title">盘点单</span>
            <span class="person">盘点人:某某某</span>
        </div>
        <div class="body">
            <ul class="contUl">
                <li class="item">
                    <div class="title">镜片</div>
                    <div class="box">
                        <div class="top">
                            <span>品牌·系列</span>
                            <span>当前</span>
                            <span>实际</span>
                            <span>差异</span>
                            <span>操作</span>
                        </div>
                        <ul>
                            <li>
                                <span>品牌A系列A</span>
                                <span>12</span>
                                <span>4423</span>
                                <span>3466</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="item">
                    <div class="title">镜片</div>
                    <div class="box">
                        <div class="top">
                            <span>品牌·系列</span>
                            <span>当前</span>
                            <span>实际</span>
                            <span>差异</span>
                            <span>操作</span>
                        </div>
                        <ul>
                            <li>
                                <span>品牌A系列A</span>
                                <span>12</span>
                                <span>4423</span>
                                <span>3466</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="item">
                    <div class="title">镜片</div>
                    <div class="box">
                        <div class="top">
                            <span>品牌·系列</span>
                            <span>当前</span>
                            <span>实际</span>
                            <span>差异</span>
                            <span>操作</span>
                        </div>
                        <ul>
                            <li>
                                <span>品牌A系列A</span>
                                <span>12</span>
                                <span>4423</span>
                                <span>3466</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="item">
                    <div class="title">镜片</div>
                    <div class="box">
                        <div class="top">
                            <span>品牌·系列</span>
                            <span>当前</span>
                            <span>实际</span>
                            <span>差异</span>
                            <span>操作</span>
                        </div>
                        <ul>
                            <li>
                                <span>品牌A系列A</span>
                                <span>12</span>
                                <span>4423</span>
                                <span>3466</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="item">
                    <div class="title">镜片</div>
                    <div class="box">
                        <div class="top">
                            <span>品牌·系列</span>
                            <span>当前</span>
                            <span>实际</span>
                            <span>差异</span>
                            <span>操作</span>
                        </div>
                        <ul>
                            <li>
                                <span>品牌A系列A</span>
                                <span>12</span>
                                <span>4423</span>
                                <span>3466</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="item">
                    <div class="title">镜片</div>
                    <div class="box">
                        <div class="top">
                            <span>品牌·系列</span>
                            <span>当前</span>
                            <span>实际</span>
                            <span>差异</span>
                            <span>操作</span>
                        </div>
                        <ul>
                            <li>
                                <span>品牌A系列A</span>
                                <span>12</span>
                                <span>4423</span>
                                <span>3466</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                            <li>
                                <span>品牌A系列A</span>
                                <span>22</span>
                                <span>5</span>
                                <span>6</span>
                                <span><em class="white">盘点</em></span>
                            </li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
        <div class="foot">
            <a class="layui-layer-btn0">关闭窗口</a>
        </div>
    </div>
    <!--右边-->
    <div class="rightBox">
        <div class="head">
            <span class="title">镜片</span>
            <span class="subTitle">品牌A系列Z</span>
        </div>
        <div class="body">

        </div>
        <div class="foot">

        </div>
    </div>
</div>
<!--全局js-->
<script src="../resource/js/jquery.min.js"></script>
<script src="../resource/js/bootstrap.js?v=3.3.6"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table.js"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table-zh-CN.min.js"></script>
<script src="../resource/js/plugins/layer/layer.js"></script>
<script src="../resource/layui/layui.js"></script>


<script src="../resource/js/lib/quakooLib/QuakooBase-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooConfig-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooBasePc-1.0.0.js"></script>
<script src="../resource/js/lib/quakoo/Config.js"></script>
<script src="../resource/js/lib/quakoo/project.js"></script>
<script src="../resource/common/common.js?" +Math.random()></script>
<script src="../resource/js/yanjing/yanjing.js"></script>
<!--//日期范围插件开始-->
<script src="../resource/js/yanjing/daterange.js"></script>
<script src="../resource/js/template-native.js"></script>

<!--下拉选择-->
<script type="text/html" id="selectTagTmp">
    <div class="select-box-header">
        <span class="text"><%=title%></span> <i class="iconfont icon-ico_arrow_down"></i>
    </div>
    <div class="optionBox">
        <ul class="optionUL">
            <%for(var i=0;i< list.length;i++){%>
            <li value="<%=list[i].id%>" data-pnid="<%if(list[i].pnid){%><%=list[i].pnid%><%}%>">
                <%if(list[i].name){%><%=list[i].name%><%}else{%><%=list[i].content%><%}%>
            </li>
            <%}%>
        </ul>
    </div>
</script>
<!--添加盘点单-->
<script type="text/html" id="addTmp">
    <!--左边-->
    <div class="leftBox">
        <div class="head">
            <span class="title layui-layer-title">添加盘点</span>
            <%if(showShop){%>
            <!--<div class="selectShop">
                <div id="box001">门店(多选)<i class="icon iconfont icon-ico_arrow_down"></i></div>
                <div id="selectBox001" class="optionBox">
                    <div class="btn-fixed" onclick="listHide()">确定</div>
                    <ul>
                        <%for(var i=0;i< shopData.length;i++){%>
                        <li>
                            <form class="layui-form">
                                <div class="layui-form-item">
                                    <div class="layui-input-block">
                                        <input type="checkbox" value="<%=shopData[i].id%>" name="like1[write]" lay-skin="primary"
                                               lay-filter="shop" title="<%=shopData[i].name%>">
                                    </div>
                                </div>
                            </form>
                        </li>
                        <%}%>
                    </ul>

                </div>
            </div>-->
            <div class="selectBox jj-box" id="out-shop" style="margin-top: 8px;float: right">
                <div class="select-box-header">
                    <span class="text">选择门店</span> <i class="iconfont icon-ico_arrow_down"></i>
                </div>
                <div class="optionBox">
                    <ul class="optionUL">
                        <%for(var i=0;i< shopData.length;i++){%>
                        <li value="<%=shopData[i].id%>"><%=shopData[i].name%></li>
                        <%}%>
                    </ul>
                </div>
            </div>
            <%}%>
        </div>
        <div class="body">
            <ul class="contUl">
                <%for(var i=0;i< categoryData.length;i++){%>
                <li class="item clearfix">
                    <div class="title"><%=categoryData[i].name%></div>
                    <div class="cont">
                        <div class="selectBox" id='yj-brand<%=categoryData[i].id%>'>
                            <div class="select-box-header"><span class="text">品牌</span> <i class="iconfont icon-ico_arrow_down"></i></div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <%for(var j=0;j< brandData.length;j++){%>
                                    <li class="txtOverflow" value="<%=brandData[j].id%>"><%=brandData[j].name%></li>
                                    <%}%>
                                </ul>
                            </div>
                        </div>
                        <div class="selectBox" >

                        </div>
                        <div class="selectBox yj-provider-select" id='yj-provider<%=categoryData[i].id%>'>
                            <div class="select-box-header"><span class="text">供应商</span> <i class="iconfont icon-ico_arrow_down"></i></div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <%for(var j=0;j< providerData.length;j++){%>
                                    <li class="txtOverflow" value="<%=providerData[j].id%>"><%=providerData[j].name%></li>
                                    <%}%>
                                </ul>
                            </div>
                        </div>
                        <div class="btn btn-info" style="float: right;" onclick="addToList('<%=categoryData[i].id%>')">添加至盘点单</div>
                    </div>
                </li>
                <%}%>
            </ul>
        </div>
        <div class="foot">
            <a class="layui-layer-btn0">关闭窗口</a>
        </div>
    </div>
    <!--右边-->
    <div class="rightBox">
        <div class="head">
            <span class="title">盘点单</span>
            <div class="selectBox" id="yj-people">
                <div class="select-box-header">
                    <span class="text"><%=initName%></span> <i class="iconfont icon-ico_arrow_down"></i>
                </div>
                <div class="optionBox">
                    <ul class="optionUL">
                        <%for(var i=0;i< peopleData.length;i++){%>
                        <li value="<%=peopleData[i].id%>"><%=peopleData[i].name%></li>
                        <%}%>
                    </ul>
                </div>
            </div>
            <span class="person">发起人:</span>
        </div>
        <div class="body">
            <ul class="contUl" id="outListDom">


            </ul>
        </div>
        <div class="foot">
            <a class="layui-layer-btn1">创建盘点</a>
        </div>
    </div>
</script>
<!--盘点列表-->
<script type="text/html" id="dataTmp">
    <%for(var i=0;i< list.length;i++){%>
    <li class="item">
        <div class="head">
            <span class="mainCont-head-left blue"><em></em>常规出库</span>
            <span>发起人:<em><%=list[i].initUserName%></em></span>
        </div>
        <div class="body">
            <div class="top">
                <ul>
                    <%if(list[i].clientItems.length>5){%>
                    <%for(var j=0;j< list[i].clientItems.length;j++){%>
                    <%if(j< 4 ){%>
                    <li>
                        <span class="txtOverflow"><%=list[i].clientItems[j].seriesName%><%=list[i].clientItems[j].code%></span>
                        <span>X<%=list[i].clientItems[j].currentNum%></span>
                    </li>
                    <%}%>
                    <%}%>
                    <li style="color:#828297">
                        ...
                    </li>
                    <%}else{%>
                    <%for(var j=0;j< list[i].clientItems.length;j++){%>
                    <li>
                        <span class="txtOverflow"><%=list[i].clientItems[j].seriesName%><%=list[i].clientItems[j].code%></span>
                        <span>X<%=list[i].clientItems[j].currentNum%></span>
                    </li>
                    <%}%>
                    <%}%>
                </ul>
            </div>
            <div class="bottom">
                <div>共<%=list[i].clientItems.length%>种商品</div>
                <div>数量总计:<%=list[i].clientItemsNum%></div>
            </div>
        </div>
        <div class="foot">
            <span class="txt"><%=list[i].time%></span>
            <%if(list[i].status==0){%>
            <button class="btn btn-primary" type="button" onclick="newInventory('<%=list[i].id%>')">编辑</button>
            <%}else if(list[i].status==1){%>
            <button class="btn btn-danger" type="button" onclick="startInvent('<%=list[i].id%>')">开始盘点</button>
            <%}else if(list[i].status==2){%>
            <button class="btn btn-order" type="button" onclick="startInvent('<%=list[i].id%>',1)">查看</button>
            <%}%>
        </div>
    </li>
    <%}%>
</script>
<!--添加盘点右边的盘点单-->
<script type="text/html" id="outListTmp">
    <%for(var i in list){%>
    <%if(isJson(list[i].data)){%>
    <li class="yanjing item" style="">
        <div class="title"><%=list[i].name%></div>
        <div class="box">
            <div class="top">
                <span>品牌·系列</span>
                <span>产品编码</span>
                <span>当前库存</span>
                <span>操作</span>
            </div>
            <ul>
                <%for(var j in list[i].data){%>
                <li class="clearfix">
                    <span><%=list[i].data[j].brandName%>·<%=list[i].data[j].seriesName%></span>
                    <span><%=list[i].data[j].p_code%></span>
                    <span><%=list[i].data[j].num%></span>
                    <span class="removeLi" onclick="removeOutLi('<%=i%>','<%=j%>')">移除</span>
                </li>
                <%}%>
            </ul>
        </div>
    </li>
    <%}%>
    <%}%>
</script>
<!--开始盘点左侧-->
<script type="text/html" id="startLeftTmp">
    <div class="head">
        <span class="title layui-layer-title">盘点单</span>
        <div class="selectBox" id="yj-pd-people">
            <div class="select-box-header">
                <span class="text">盘点人</span> <i class="iconfont icon-ico_arrow_down"></i>
            </div>
            <div class="optionBox">
                <ul class="optionUL">
                    <%for(var i=0;i< peopleData.length;i++){%>
                    <li value="<%=peopleData[i].id%>"><%=peopleData[i].name%></li>
                    <%}%>
                </ul>
            </div>
        </div>
        <span class="person">盘点人:</span>
    </div>
    <div class="body">
        <ul class="contUl">
            <%for(var i in allCategory){%>
            <li class="item">
                <div class="title"><%=allCategory[i].categoryName%></div>
                <div class="box">
                    <div class="top">
                        <span>品牌·系列</span>
                        <span>当前</span>
                        <span>实际</span>
                        <span>差异</span>
                        <span>操作</span>
                    </div>
                    <ul>
                        <%for(var j in allCategory[i].data){%>
                        <li>
                            <span><%=allCategory[i].data[j].brandName%><%=allCategory[i].data[j].seriesName%></span>
                            <span><%=allCategory[i].data[j].currentNum%></span>
                            <span><%=allCategory[i].data[j].realNum%></span>
                            <%if(allCategory[i].data[j].realNum-allCategory[i].data[j].currentNum<0){%>
                            <span style="color: #DD5B4B"><%=allCategory[i].data[j].realNum-allCategory[i].data[j].currentNum%></span>
                            <%}else if(allCategory[i].data[j].realNum-allCategory[i].data[j].currentNum>0){%>
                            <span style="color: #54B677">+<%=allCategory[i].data[j].realNum-allCategory[i].data[j].currentNum%></span>
                            <%}else{%>
                            <span><%=allCategory[i].data[j].realNum-allCategory[i].data[j].currentNum%></span>
                            <%}%>
                            <span><em class="white" onclick='initRight(<%=json(allCategory[i].data[j])%>,"<%=type%>")'>盘点</em></span>
                        </li>
                        <%}%>
                    </ul>
                </div>
            </li>
            <%}%>
           <!-- <li class="item">
                <div class="title">镜片</div>
                <div class="box">
                    <div class="top">
                        <span>品牌·系列</span>
                        <span>当前</span>
                        <span>实际</span>
                        <span>差异</span>
                        <span>操作</span>
                    </div>
                    <ul>
                        <li>
                            <span>品牌A系列A</span>
                            <span>12</span>
                            <span>4423</span>
                            <span>3466</span>
                            <span><em>盘点</em></span>
                        </li>
                        <li>
                            <span class="iconClick"><i class="icon iconfont icon-ico_check"></i>品牌A系列A</span>
                            <span>22</span>
                            <span>5</span>
                            <span>6</span>
                            <span><em class="blue">盘点</em></span>
                        </li>
                        <li>
                            <span class="iconClick"><i class="icon iconfont icon-ico_check"></i>品牌A系列A</span>
                            <span>22</span>
                            <span>5</span>
                            <span>6</span>
                            <span><em class="white">盘点</em></span>
                        </li>
                    </ul>
                </div>
            </li>-->
        </ul>
    </div>
    <div class="foot">
        <a class="layui-layer-btn0">关闭窗口</a>
        <%if(type!=1){%>
        <span class="btn01 btn btn-primary" onclick="finishPd('<%=list.id%>')">完成盘点</span>
        <span class="btn02" onclick="">打印盘点单</span>
        <!--<span class="btn03" onclick="deletePd('<%=list.id%>')">删除盘点</span>-->
        <%}%>
    </div>
</script>
<!--开始盘点右侧-->
<script type="text/html" id="startRightTmp">
    <div class="head">
        <span class="title"><%=list.categoryName%></span>
        <span class="subTitle"><%=list.brandName%>·<%=list.seriesName%></span>
        <!--<input type="number" placeholder="输入条码">-->
    </div>
    <div class="body">
        <div class="tableCont">
            <table data-toggle="table" id="startRightTable"></table>
        </div>
    </div>
    <%if(type!=1){%>
    <div class="foot">
        <a class="layui-layer-btn1" onclick="savePd()">保存</a>
    </div>
    <%}%>

</script>
<!--//日期范围插件结束-->
<script>

    template.helper('json',function(obj){
        return JSON.stringify(obj)
    });

    var subid = quakooUser.getUserInfo().psid;//企业/公司id
    var shopId = quakooDb.getItem('sel_ShopId');//门店id

    var allData = {};//页面请求回来的所有数据

    var startTime;//筛选时间开始时间
    var endTime;//筛选时间结束时间


    var categoryData = [];//一级类目数据
    var brandData = [];//品牌数据
    var providerData = [];//供应商数据
    var ballData = [];//球数据
    var columnData = [];//柱数据
    var peopleData = [];//员工数据
    var allOutList = {};//全部数据
    var shopData;//门店数据
    var peopleId;//发起人
    var subidsArr = [];//门店id集合
    var pdPeopleId;//盘点人

    var startPdId;//开始盘点的id

    //获取门店所有顾客-不分页
    quakooData.ajaxGetData(config.getUrl_user_getAllUser(),{sid:shopId,userType:1},function (ret) {
        if(ret && ret.success){
            peopleData = ret.data;
        }
    })
    //获取当前企业下门店列表
    quakooData.ajaxGetData(config.getUrl_subordinate_getSubordinateStore(),{sid:subid},function (ret) {
        if(ret&&ret.success){
            if(quakooUtils.isNotBlack(ret.data)){
                shopData = ret.data;
            }
        }
    });
    //获取一级类目
    quakooData.ajaxGetData(config.getUrl_productCategory_getSubAllList(),{subid:subid},function (ret) {
        if(ret && ret.success){
            categoryData = ret.data;
        }
    })
    //获取品牌数据
    quakooData.ajaxGetData(config.getUrl_productBrand_getSubAllList(),{},function (ret) {
        if(ret && ret.success){
            brandData = ret.data;
        }
    })
    //获取属性-球
    quakooData.ajaxGetData(config.getUrl_productPropertyvalue_getAllList(),{pnid:15},function (ret) {
        if(ret && ret.success){
            ballData = ret.data.sort(function (a,b) {
                return b.content-a.content;
            });
        }
    })
    //获取供应商
    function getSupplier(id){
        quakooData.ajaxGetData(config.getUrl_productProvider_getSubAllList(),{subid:id},function (ret) {
            if(ret && ret.success){
                providerData = ret.data;
                var html = '';
                for (var i = 0; i < providerData.length; i++) {
                    html+= '<li class="txtOverflow"  value="'+providerData[i].id+'">'+providerData[i].name+'</li>'
                }
                $(".yj-provider-select ul").html(html);
                for(var i=0;i<categoryData.length;i++){
                    (function (i) {
                        selectTag($("#yj-provider"+categoryData[i].id),function (ret) {
                            console.log(ret.value);
                            if(ret.value){
                                if(allOutList[categoryData[i].id]){
                                    allOutList[categoryData[i].id].pid = ret.value;
                                }else{
                                    allOutList[categoryData[i].id] = {cid:categoryData[i].id,pid:ret.value,name:categoryData[i].name,data:{}}
                                }
                            }
                        })
                    })(i)
                }
            }
        })
    }
    //获取属性-柱
    quakooData.ajaxGetData(config.getUrl_productPropertyvalue_getAllList(),{pnid:16},function (ret) {
        if(ret && ret.success){
            columnData = ret.data.sort(function (a,b) {
                return b.content-a.content;
            });
        }
    })


    //日期范围初始化
    var selectDate = new dateRange("#select-date");
    selectDate.init()
    $('#select-date button').click(function () {
        startTime = selectDate.getTime()[2];
        endTime = selectDate.getTime()[3];
        getInData()
    })


    //获取盘点数据
    getInData()
    //盘点列表
    function getInData(){
        $("#yj-table").bootstrapTable('destroy');
        $("#yj-table").bootstrapTable({
            url: config.getUrl_inventoryCheckBill_getCreatePager(),
            classes: "table",
            pagination: true,        //是否显示分页
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 6,
            pageList: [6, 12, 18],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            // paginationLoop:false,        //分页是否可以循环
            columns: [],
            queryParams:function (param) {
                param.subid = shopId;
                param.token = quakooUser.getUserInfo().token;
                if(startTime){
                    param.startTime=startTime;
                }
                if(endTime){
                    param.endTime=endTime;
                }
                return param
            },
            onPreBody: function (data) {
                var arr = [];
                for (var i = (this.pageNumber - 1) * this.pageSize; i < this.pageNumber * this.pageSize; i++) {
                    if(this.data[i]){
                        this.data[i].time = quakooUtils.formatTimeToDateDian(this.data[i].ctime);
                        this.data[i].clientItemsNum = 0;
                        for(var j=0;j<this.data[i].clientItems.length;j++){
                            this.data[i].clientItemsNum +=this.data[i].clientItems[j].currentNum;
                        }
                        arr.push(this.data[i])
                        allData[this.data[i].id] = this.data[i]
                    }
                }
                var html = template('dataTmp',{list:arr})
                $("#showUl").html(html);
            }
        });
    }
    //新增盘点弹窗
    function newInventory(id) {
        allOutList = {};
        if(!brandData || !peopleData || !categoryData || !providerData || !shopData){
            return
        }

        layer.open({
            type: 1,
            shade: 0.01,
            title: null,
            skin: 'content-view-tan content-view-commonInventory-tan content-view-addInventory', //样式类名
            anim: 0,
            move:'.title',
            area: ['735px', '560px'],
            closeBtn: 0, //不显示关闭按钮
            resize: false,
            shadeClose: true, //开启遮罩关闭
            content: $('.content-view-addInventory'), //容器对象
            btn: [],
            success: function (layero, index) {
                $('.content-view-commonInventory-tan .layui-layer-content').height(560);
                addRepertorySuccess(index,id)
            }
        });
    }
    function addRepertorySuccess(index,id) {
        var showShop = true;
        var initName = '发起人'
        if(id){
            showShop =  false;
            peopleId = allData[id].initUid;
            initName = allData[id].initUserName
        }
        var html = template('addTmp',{brandData:brandData,peopleData:peopleData,categoryData:categoryData,providerData:providerData,shopData:shopData,showShop:showShop,initName:initName})
        $('#addDom').html(html);

        if(id){
            for(var i=0;i<allData[id].clientItems.length;i++){
                var obj = {};
                obj.bid = allData[id].clientItems[i].bid;
                obj.cid = allData[id].clientItems[i].cid;
                obj.pid = allData[id].clientItems[i].pid;
                obj.sid = allData[id].clientItems[i].sid;
                obj.type = allData[id].clientItems[i].type;
                obj.name = allData[id].clientItems[i].categoryName;
                obj.data = {};
                allData[id].clientItems[i].num = allData[id].clientItems[i].currentNum;
                allData[id].clientItems[i].p_code = allData[id].clientItems[i].code;
                allOutList[allData[id].clientItems[i].cid] = obj;
            }
            for(var i=0;i<allData[id].clientItems.length;i++){
                allOutList[allData[id].clientItems[i].cid].data[''+allData[id].clientItems[i].bid+allData[id].clientItems[i].sid+allData[id].clientItems[i].did] = allData[id].clientItems[i];
            }
            console.log(allOutList)
            var html = template('outListTmp',{list:allOutList})
            $("#outListDom").html(html)
        }


        $('.content-view-addInventory .layui-layer-btn0').click(function () {
            addOutList(0,index,id);
        });
        $('.content-view-addInventory .layui-layer-btn1').click(function () {
            addOutList(1,index,id);
        });
        for(var i=0;i<categoryData.length;i++){
            (function (i) {
                selectTag($("#yj-brand"+categoryData[i].id),function (ret) {
                    if(ret.value){
                        if(allOutList[categoryData[i].id]){
                            allOutList[categoryData[i].id].bid = ret.value;
                            allOutList[categoryData[i].id].sid = -1;
                        }else{
                            allOutList[categoryData[i].id] = {cid:categoryData[i].id,bid:ret.value,sid:-1,name:categoryData[i].name,data:{}}
                        }
                        $('#yj-brand'+categoryData[i].id).next().html('');
                        //获取品牌下的系列列表
                        quakooData.ajaxGetData(config.getUrl_productSeries_getSubAllList(),{bid:ret.value},function (ret1) {
                            if(ret1 && ret1.success){
                                var html2 = template('selectTagTmp',{title:'系列',list:ret1.data});
                                $('#yj-brand'+categoryData[i].id).next().html(html2).show();
                                selectTag($('#yj-brand'+categoryData[i].id).next(),function (series) {
                                    allOutList[categoryData[i].id].sid = series.value;
                                })
                            }
                        })
                    }
                })
            })(i)
        }
        //发起人
        selectTag($("#yj-people"), function (ret) {
            peopleId = ret.value;
        })
        selectTag($("#out-shop"), function (ret) {
            subidsArr = [ret.value]
            getSupplier(ret.value)
            // peopleId = ret.value;
        })


        /*setTimeout(function () {
          layui.use(['form'], function () {
              var form = layui.form
              form.on('checkbox(shop)', function (data) {
                  if ($(this).prop("checked")) {
                      subidsArr.push($(this).val());
                  } else {
                      var index = getIndex(subidsArr, $(this).val())
                      subidsArr.splice(index, 1);
                  }
              });
          })
        },100)*/

        function getIndex(arr, value) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] == value) {
                    return i
                }
            }
        }

        //点击按钮是弹出数组
        $('#box001').click(function (e) {
            quakooUtils.stopEventBubble(e)
            if ($(this).find('.icon').hasClass('icon-ico_arrow_down')) {
                $(this).find('.icon').removeClass('icon-ico_arrow_down').addClass('icon-ico_arrow_up')
            } else {
                $(this).find('.icon').removeClass('icon-ico_arrow_up').addClass('icon-ico_arrow_down')
            }
            if ($('#selectBox001').is(':hidden')) {　　//如果node是隐藏的则显示node元素，否则隐藏
                $('#selectBox001').show(600);
            } else {
                $('#selectBox001').hide(600);
            }
        })
        $('#selectBox001').click(function (e) {
            quakooUtils.stopEventBubble(e)
        })
        $(document).click(function () {
            $("#selectBox001").hide();
            $(this).find('.icon').removeClass('icon-ico_arrow_up').addClass('icon-ico_arrow_down')
        });
    }
    function addToList(id) {
        var param = {};
        if(!allOutList[id] || !allOutList[id].bid){
            layer.msg('请选择品牌');return ;
        }
        if(!allOutList[id].pid){
            layer.msg('请选择供应商');return ;
        }

        param.type = 0;
        param.pid = allOutList[id].pid;
        param.bid = allOutList[id].bid;
        param.sid = allOutList[id].sid;
        param.subid = shopId;
        param.cid = id;
        quakooData.ajaxGetData(config.getUrl_inventoryCheckBill_select(),param,function (ret) {
            if(ret&&ret.success){
                if(ret.data.details.length>0){
                    for(var i=0;i<ret.data.details.length;i++){
                        allOutList[id].data[''+allOutList[id].bid+allOutList[id].sid+ret.data.details[i].id] = ret.data.details[i]
                    }
                }else{
                    layer.msg('暂无此类商品')
                    return
                }
                var html = template('outListTmp',{list:allOutList})
                $("#outListDom").html(html)
            }else{
                layer.msg(ret.data,{icon: 2})
            }
        })
    }
    //移除盘点单中的商品
    function removeOutLi(i,j) {
        delete allOutList[i].data[j];
        var html = template('outListTmp',{list:allOutList})
        $("#outListDom").html(html)
    }
    //添加盘点
    function addOutList(status,index,id) {
        var closeFlag = true;
        for(var i in allOutList){
            console.log(Object.keys(allOutList[i].data).length);
            if(Object.keys(allOutList[i].data).length>0){
                closeFlag = false;
                break ;
            }
        }
        if(closeFlag){
            layer.close(index)
            return ;
        }
        if(!id){
            if(subidsArr.length<=0){
                layer.msg('选择门店');
                return
            }
        }

        if(!peopleId){
            layer.msg('选择发起人');
            return
        }
        var params = {};
        if(id){
            params.id = id;
            params.wid = allData[id].wid;
        }
        params.subid = shopId;
        params.subids = subidsArr;
        params.status = status;
        params.initUid = peopleId;
        params.createUid = quakooUser.getUserInfo().id;
        params.itemsJson = [];
        for(var i in allOutList){
            if(allOutList[i].data){
                for(var j in allOutList[i].data){
                    var obj = {};
                    if(id){
                        obj.did = allOutList[i].data[j].did;
                    }else{
                        obj.did = allOutList[i].data[j].id;
                    }
                    obj.currentNum = allOutList[i].data[j].num;
                    params.itemsJson.push(obj)
                }
            }
        }
        params.itemsJson = JSON.stringify(params.itemsJson)
        if(id){
            quakooData.ajaxGetData(config.getUrl_inventoryCheckBill_update(),params,function (ret) {
                if(ret && ret.success){
                    layer.msg('修改成功',{icon: 1})
                    layer.close(index)
                    getInData()
                }else{
                    layer.msg(ret.data,{icon: 2})
                }
            })
        }else{
            quakooData.ajaxGetData(config.getUrl_inventoryCheckBill_add(),params,function (ret) {
                if(ret && ret.success){
                    layer.close(index)
                    layer.msg('添加成功',{icon: 1})
                    getInData()
                }else{
                    layer.msg(ret.data,{icon: 2})
                }
            })
        }
    }

    //盘点创建成功弹窗
    function addSuccess() {
        layer.open({
            type: 1,
            shade: 0.01,
            title: '创建成功',
            skin: 'content-view-tan', //样式类名
            anim: 0,
            area: ['240px', '130px'],
            closeBtn: 0, //不显示关闭按钮
            resize: false,
            shadeClose: true, //开启遮罩关闭
            content: $('.content-view-addSuccess'), //容器对象
            btn: ['下次再说', '立即盘点'],
            yes: function (index) {
                layer.close(index);
            },
            btn2: function (index) {
                layer.close(index);
                startInvent()
            }
        });
    }

    //开始盘点弹窗
    function startInvent(id,type) {
        startPdId = id;
        layer.open({
            type: 1,
            shade: 0.01,
            title: null,
            skin: 'content-view-tan content-view-commonInventory-tan content-view-startInvent', //样式类名
            anim: 0,
            area: ['960px', '560px'],
            closeBtn: 0, //不显示关闭按钮
            resize: false,
            shadeClose: true, //开启遮罩关闭
            content: $('.content-view-startInvent'), //容器对象
            btn: [],
            yes: function (index) {},
            btn2: function (index) {},
            success: function (layero, index) {
                $('.iconClick').click(function () {
                    $(this).toggleClass('checked');
                })
                $('.content-view-commonInventory-tan .layui-layer-content').height(560);

                var allCategory = {};
                allPdDidObj = {};
                for(var i=0;i<allData[id].clientItems.length;i++){
                    if(allData[id].clientItems[i].realNum){
                        allPdDidObj[allData[id].clientItems[i].did] = {did:allData[id].clientItems[i].did,currentNum:allData[id].clientItems[i].currentNum,realNum:allData[id].clientItems[i].realNum}
                    }else{
                        allPdDidObj[allData[id].clientItems[i].did] = {did:allData[id].clientItems[i].did,currentNum:allData[id].clientItems[i].currentNum,realNum:0}
                    }


                    if(allCategory[allData[id].clientItems[i].cid]){
                        if(allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid]){
                            allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid].data.push(allData[id].clientItems[i])
                        }else{
                            allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid] = {};
                            allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid].data = [allData[id].clientItems[i]];
                            allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid].brandName = allData[id].clientItems[i].brandName;
                            allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid].seriesName = allData[id].clientItems[i].seriesName;
                        }
                    }else{
                        allCategory[allData[id].clientItems[i].cid] = {};
                        allCategory[allData[id].clientItems[i].cid].categoryName = allData[id].clientItems[i].categoryName;
                        allCategory[allData[id].clientItems[i].cid].data = {};
                        allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid] = {};
                        allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid].data = [allData[id].clientItems[i]];
                        allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid].brandName = allData[id].clientItems[i].brandName;
                        allCategory[allData[id].clientItems[i].cid].data[allData[id].clientItems[i].bid+'*'+allData[id].clientItems[i].sid].seriesName = allData[id].clientItems[i].seriesName;
                    }
                }
                for(var i in allCategory){
                    for(var j in allCategory[i].data){
                        allCategory[i].data[j].currentNum = 0;
                        allCategory[i].data[j].realNum = 0;
                        for(var k=0;k<allCategory[i].data[j].data.length;k++){
                            allCategory[i].data[j].currentNum+= allCategory[i].data[j].data[k].currentNum;
                            allCategory[i].data[j].realNum+= allCategory[i].data[j].data[k].realNum;
                        }
                    }
                }
                document.getElementById('startRight').innerHTML = '';
                document.getElementById('startLeft').innerHTML = template('startLeftTmp',{list:allData[id],peopleData:peopleData,allCategory:allCategory,type:type})
                selectTag($("#yj-pd-people"),function (ret) {
                    pdPeopleId = ret.value;
                })
                $("#yj-pd-people .select-box-header .text").html(allData[id].checkUserName);
                pdPeopleId = allData[id].checkUid;
                //底部按钮点击关闭弹窗
                $('.content-view-startInvent .layui-layer-btn0').click(function () {
                    layer.close(index);
                });
            }
        });
    }
    //进行盘点点击左边的盘点
    function initRight(data,type) {
        $("#startRight").html(template('startRightTmp',{list:data,type:type}))
        for(var i=0;i<data.data.length;i++){
            if(allPdDidObj[data.data[i].did]){
                data.data[i].realNum = allPdDidObj[data.data[i].did].realNum;
            }
        }
        console.log(data.data);
        $("#startRightTable").bootstrapTable('destroy')
        $("#startRightTable").bootstrapTable({
            data: data.data,
            classes: "table",
            pagination: false,        //是否显示分页
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 10,
            pageList: [5, 10, 15, 20],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            smartDisplay: false,
            columns: [
                {field: "code", title: "产品编码", align: "left", valign: "middle"},
                {field: "currentNum", title: "当前", align: "left", valign: "middle",},
                {
                    field: "realNum", title: "实际", align: "left", valign: "middle",
                    formatter: function (value, row, index) {//循环自定义内容
                        if(type==1){
                            return value
                        }else{
                            if(value!=0){
                                return '<input value="' + value + '" onkeyup="realNumChange(this,'+row.did+','+row.currentNum+')" type="number" >'
                            }else{
                                return '<input value="" onkeyup="realNumChange(this,'+row.did+','+row.currentNum+')" type="number" >'
                            }
                        }

                    }
                },
                {
                    field: "properties", title: "球", align: "left", valign: "middle",
                    formatter: function (value, row, index) {//循环自定义内容
                        if(value){return value[15]}
                    }
                },
                {
                    field: "properties", title: "柱", align: "left", valign: "middle",
                    formatter: function (value, row, index) {//循环自定义内容
                        if(value){return value[16]}
                    }
                },
                {
                    field: "", title: "差异", align: "left", valign: "middle", formatter: function (value, row, index) {//循环自定义内容
                        var num = row.realNum - row.currentNum;
                        if(num<0){
                            return '<span style="color: #DD5B4B">'+num+'</span>'
                        }else if(num>0){
                            return '<span style="color: #54B677">+'+num+'</span>'
                        }else{
                            return '<span>'+num+'</span>'
                        }
                    }
                },
            ],
            onPageChange: function (number, size) {

            }
        });
    }
    //完成盘点
    function finishPd(id) {
        savePd(function () {
            layer.confirm('确认完成?', {icon: 1, title:'提示'}, function(index){
                quakooData.ajaxGetData(config.getUrl_inventoryCheckBill_end(),{id:id},function (data) {
                    if(data.success){
                        layer.msg('已完成',{icon:1})
                        getInData();
                        layer.closeAll();
                    }else{
                        layer.msg(data.msg,{icon:2})
                    }
                })
            });
        })

    }
    //删除盘点
    function deletePd(id) {
        layer.confirm('确认删除?', {icon: 2, title:'提示'}, function(index){
            quakooData.ajaxGetData(config.getUrl_inventoryCheckBill_del(),{id:id},function (data) {
                if(data.success){
                    layer.msg('删除成功',{icon:1})
                    getInData();
                    layer.close(index);
                }else{
                    layer.msg(data.msg,{icon:2})
                }
            })
        });
    }

    //保存盘点
    function savePd(callback) {
        if(!pdPeopleId){
            layer.msg('请选择盘点人');
            return
        }
        var params = {};
        params.id = startPdId;
        params.subid = shopId;
        params.initUid = allData[startPdId].initUid;
        params.createUid = quakooUser.getUserInfo().id;
        params.checkUid = pdPeopleId;
        params.status = 1;
        params.itemsJson = [];
        for(var i in allPdDidObj){
            params.itemsJson.push(allPdDidObj[i])
        }
        params.itemsJson = JSON.stringify(params.itemsJson)
        quakooData.ajaxGetData(config.getUrl_inventoryCheckBill_save(),params,function (data) {
            if(data.success){
                layer.msg('保存成功',{icon:1})
                if(callback){
                    callback()
                }
                getInData()
            }else{
                var msg = data.msg|| data.data;
                layer.msg(msg,{icon:2})
            }
        })
    }

    //查看不可盘点弹窗
    function checkInvent() {
        layer.open({
            type: 1,
            shade: 0.01,
            title: null,
            skin: 'content-view-tan content-view-commonInventory-tan content-view-checkInvent', //样式类名
            anim: 0,
            area: ['960px', '560px'],
            closeBtn: 0, //不显示关闭按钮
            resize: false,
            shadeClose: true, //开启遮罩关闭
            content: $('.content-view-checkInvent'), //容器对象
            btn: [],
            yes: function (index) {

            },
            btn2: function (index) {

            },
            success: function (layero, index) {
                $('.content-view-commonInventory-tan .layui-layer-content').height(560);
                //底部按钮点击关闭弹窗
                $('.content-view-checkInvent .layui-layer-btn0').click(function () {
                    layer.close(index);
                });
            }
        });
    }
    //实际数量改变
    var allPdDidObj = {};
    function realNumChange(self,id,currentNum) {
        var num = self.value - parseInt($(self).parents('td').prev().text());
        if(num<0){
            $(self).parents('tr').find('td').last().html('<span style="color: #DD5B4B">'+num+'</span>')
        }else if(num>0){
            $(self).parents('tr').find('td').last().html('<span style="color: #54B677">+'+num+'</span>')
        }else{
            $(self).parents('tr').find('td').last().html('<span>'+num+'</span>')
        }
        if(self.value>=0){
            allPdDidObj[id].realNum = self.value;
        }
    }
    function listHide() {
        $("#selectBox001").hide();
    }
</script>
</body>
</html>