<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <title>眼睛-实时工作台</title>
    <!-- bootstrap样式开始 -->
    <link href="../resource/css/bootstrap.min.css" rel="stylesheet">
    <link href="../resource/js/plugins/bootstarp-table/css/bootstrap-table.min.css" rel="stylesheet">
    <link href="../resource/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">
    <!-- bootstrap样式结束 -->
    <!--时间插件引用的css-->
    <link href="../resource/css/yanjing/mobiscroll.2.13.2.css" rel="stylesheet">
    <link href="../resource/css/yanjing/myDate.css" rel="stylesheet">
    <!--时间插件引用的css结束-->
    <!-- layui样式 -->
    <link rel="stylesheet" href="../resource/layui/css/layui.css">
    <!-- 字体图标 -->
    <link rel="stylesheet" href="../resource/fonts/iconfont.css">
    <!-- 清除默认样式 -->
    <link rel="stylesheet" href="../resource/css/style.css">
    <link rel="stylesheet" href="../resource/css/reset.css">
    <!-- 公共样式 -->
    <link href="../resource/css/common.css" rel="stylesheet">
    <!-- 当前页面样式 -->
    <link rel="stylesheet" href="../resource/css/yanjing/timeWorkbench.css">
</head>

<body>

<!--头部开始-->
<header>
    <ul>
        <li class="xuan" onclick="chooseType(this)">今日概览</li>
        <li onclick="chooseType(this)">资金管理</li>
    </ul>
</header>
<!--头部结束-->
<!--今日概览开始-->
<div class="winBox list" id="Today">
    <ul>
        <li>
            <div>
                <i class="iconfont  ico_stock_in_filled icon-ico_stock_in_filled" style="color: #57B8DB;"></i>
            </div>
            <span>入库</span>
        </li>
        <li>
            <div>
                <i class="iconfont ico_stock_out_filled icon-ico_stock_out_filled" style="color: #4186DC;"></i>
            </div>
            <span>出库</span>
        </li>
        <li>
            <div>
                <i class="iconfont ico_exchange icon-ico_exchange" style="color:#DD5B4B;"></i>
            </div>
            <span>调货</span>
        </li>
        <li>
            <div>
                <i class="iconfont ico_inventory_filled icon-ico_inventory_filled" style="color:#7D65C5;"></i>
            </div>
            <span>盘点</span>
        </li>
    </ul>
    <div style="clear: both"></div>
    <div class="salesData">
        <div class="salesDataTop">
            <ul>
                <li onclick="chooseTime(1,this)">今日</li>
                <li onclick="chooseTime(2,this)">昨日</li>
                <li onclick="chooseTime(3,this)">本周</li>
                <li onclick="chooseTime(4,this)">本月</li>
            </ul>
            <div class="moreSales">更多数据</div>
            <div class="yj-demo-time" id="yj-sale-time">
                <i class="i iconfont ico_arrow_left icon-ico_arrow_left"></i>
                <div class="yj-date">
                    <span>开始时间-结束时间</span>
                </div>
                <i class="i iconfont ico_arrow_right icon-ico_arrow_right"></i>
            </div>
        </div>
        <div id="saleMoneyDom">

        </div>
    </div>
    <div class="questRewards">
        <div class="questRewardsTop">
            <div>
                <p>日常任务和奖励</p>
                <span>销售奖励为本月数据</span>
            </div>
<!--
            <div class="btnCmyRoyalty">
                提成商品清单
            </div>
-->
        </div>
        <div class="questRewardsBanner">
            <div class="gradual btnLeft">
                <span class="iconfont ico_arrow_left icon-ico_arrow_left"></span>
            </div>
            <ul class="clearfix">
            </ul>
            <div class="gradual btnRight">
                <span class="iconfont ico_arrow_right icon-ico_arrow_right"></span>
            </div>
        </div>
        <div class="questRewardsContent">
            <div class="taskReward">
                <h3>任务奖励&nbsp;&nbsp;￥<span id="taskTotal">0</span></h3>
                <div class="content">
                    <table data-toggle="table" class="table table-border" id="taskReward"></table>
                </div>
            </div>
            <div class="salesIncentives">
                <h3>销售奖励&nbsp;&nbsp;¥<span id="salesBonus">0</span></h3>
                <div class="content">
                    <table data-toggle="table" class="table table-border" id="salesIncentives">
                    </table>
                    <!-- <span>暂无销售记录</span> -->
                </div>
            </div>
        </div>
    </div>
</div>
<!--今日概览结束-->
<!-- 资金管理 -->
<div class="winBox monManagement" id="monMan">
    <div class="cashDetailedBox">
        <div class="cashBox br">
            <div class="cashTitle bomr">
                <h3 class="dib">现金管理</h3>
                <button class="btnCloseCash butn btnRemove fr" onclick="diaSettlement()">结算现金</button>
                <button class="btnOrdinary fr btnSettlementRecord" onclick="settlementRecord()">结算记录</button>
            </div>
            <ul class="cashContent bomr">
                <li>
                    <h2 id="noSettlement">0</h2><span class="fcHui">未结算金额&nbsp;|&nbsp;元</span>
                </li>
                <li>
                    <h2 class="womenC" id="cashMoney">0</h2><span class="fcHui">现金部分&nbsp;|&nbsp;元</span>
                </li>
                <li>
                    <h2 class="womenC" id="cashNum">0</h2><span class="fcHui">现金单数&nbsp;|&nbsp;笔</span>
                </li>
            </ul>
            <div class="cashFooter">
                <span class="fl fcHui">上次结算</span>
                <span class="fr fcHui" id="lastTime"></span>
            </div>
        </div>
        <div class="detailedBox br">
            <div class="detailedTitle bomr">
                <h3>今日资金明细</h3>
                <span><i style="background: #57B8DB;"></i> 支出</span>
                <span><i></i> 收入</span>
            </div>
            <div class="totalBox fl">
                <div style="margin-bottom: 16px;">
                    <h2 id="todayTotalAdd">0</h2>
                    <span class="fcHui">收入&nbsp;|&nbsp;元</span>
                </div>
                <div class=" ">
                    <h2 id="todayTotalSub">0</h2>
                    <span class="fcHui">支出&nbsp;|&nbsp;元</span>
                </div>
            </div>
            <div style="width:75.2%;" class="fr">
                <div id="echarts"></div>
            </div>
        </div>
    </div>
    <div class="formBox">
        <h2 style="padding: 13px 16px;">今日出入账明细</h2>
        <table data-toggle="table" class="table table-border" id="todaysDetails">
        </table>
    </div>
</div>
<!-- 弹窗 -->
<div class="popup">
    <div class="closeCashPop">
        <div class="titleBox clearfix bomr">
            <h3 class="fl">现金结算</h3>
            <div class="selectBox fr" id="closeCashSele">

            </div>
            <span class="fcHui fr">结算人</span>
        </div>
        <div class="titleBox clearfix bomr">
            <span class="fcHui">销售额</span><em id="timeSale">￥0</em>
            <span class="fcHui">现金</span><em id="timeCash">￥0</em>
            <span class="fcHui">支付宝</span><em id="timeAli">￥0</em>
            <span class="fcHui">微信</span><em id="timeWx">￥0</em>
            <span class="fcHui">其他</span><em id="timeOther">￥0</em>
        </div>
        <div class="inputContent">
            <div class="inpBox">
                <h3>现金总金额</h3>
                <input type="number" placeholder="金额" class="xjZje" id="setTotal" readonly="readonly">
            </div>
            <div class="inpBox">
                <h3>预留金</h3>
                <input type="number" placeholder="金额" id="setyuliu">
            </div>
            <div class="inpBox">
                <h3>上缴现金</h3>
                <input type="number" placeholder="金额" id="setjiao">
            </div>
            <div class="inpBox">
                <h3>差额</h3>
                <input type="number" placeholder="金额" id="setcha" readonly="readonly">
            </div>
        </div>
    </div>
    <div class="cmyRoyaltyPop">
        <ul class="tab-ul">
            <li class="active">镜片</li>
            <li>镜架</li>
            <li>隐形眼镜</li>
            <li>太阳镜</li>
            <li>护理产品</li>
            <li>其他商品</li>
            <li>特殊商品</li>
        </ul>
        <div class="formContent">
            <table data-toggle="table" class="table table-border" id="cmyRoyaltyForm" border="0">
            </table>
        </div>
    </div>
    <div class="settlementRecordPop" style="display:none">
        <table id="cashSettlementRecord" data-toggle="table" class="table table-border"></table>
    </div>
</div>
</body>
<!--全局js-->
<!-- jq库 -->
<script src="../resource/js/jquery.min.js"></script>
<!-- bootstrap UI需要依赖的js -->
<script src="../resource/js/bootstrap.js?v=3.3.6"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table.js"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table-zh-CN.min.js"></script>
<!-- layui需要依赖的js -->
<script src="../resource/js/plugins/layer/layer.js"></script>
<script src="../resource/layui/layui.js"></script>
<!-- 公司内部库 -->
<script src="../resource/js/lib/quakooLib/QuakooBase-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooConfig-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooBasePc-1.0.0.js"></script>
<script src="../resource/js/lib/quakoo/Config.js"></script>
<script src="../resource/js/lib/quakoo/project.js"></script>
<script src="../resource/common/common.js?" +Math.random()></script>
<script src="../resource/js/template-native.js"></script>
<script src="../resource/js/yanjing.js"></script>

<!-- 时间插件js -->
<script src="../resource/js/mobiscroll.2.13.2.js"></script>
<!-- 时间范围插件 -->
<script src="../resource/js/yanjing/daterange.js"></script>
<!-- echarts插件 -->
<script src="../resource/js/echarts.js"></script>

<script type="text/html" id="bannerList">
    <li>
        <span>全店</span>
        <h2><%=tem%><em>元</em></h2>
    </li>
    <%for (var i = 0; i < list.length; i++){%>
    <li>
        <%if (i == 0){%>
        <span><%=list[i].name%><i class="iconfont icon-ico_medal_first"
                                  style="color:#EDC74E"></i></span>
        <%}%>
        <%if (i == 1){%>
        <span><%=list[i].name%><i class="iconfont icon-ico_medal_second"
                                  style="color:#B9B9B9"></i></span>
        <%}%>
        <%if (i == 2){%>
        <span><%=list[i].name%><i class="iconfont icon-ico_medal_third"
                                  style="color:#C99F7E"></i></span>
        <%}%>
        <%if (i > 2){%>
        <span><%=list[i].name%></span>
        <%}%>
        <h2><%=list[i].sale%><em>元</em></h2>
    </li>
    <%}%>
</script>
<script type="text/html" id="saleMoneyTmp">
    <div class="salesDatacen">
        <ul>
            <li>
                <div>
                    <span><%=list.sale%></span>
                    <div>
                        <%if(list.saleStatus==1){%>
                        <i class="iconfont ico_decrease_filled icon-ico_increase_filled"
                           style="color:#54B677;"></i>
                        <em style="color:#54B677;"><%=list.saleRate%></em>%
                        <%}else{%>
                        <i class="iconfont ico_decrease_filled icon-ico_decrease_filled"
                           style="color:#DD5B4B;"></i>
                        <em style="color:#DD5B4B;"><%=list.saleRate%></em>%
                        <%}%>
                    </div>
                </div>
                <div>
                    销售额|元
                </div>
                <div style="clear: both"></div>
            </li>
            <li>
                <div>
                    <span><%=list.num%></span>
                    <div>
                        <%if(list.numStatus==1){%>
                        <i class="iconfont ico_decrease_filled icon-ico_increase_filled"
                           style="color:#54B677;"></i>
                        <em style="color:#54B677;"><%=list.numRate%></em>%
                        <%}else{%>
                        <i class="iconfont ico_decrease_filled icon-ico_decrease_filled"
                           style="color:#DD5B4B;"></i>
                        <em style="color:#DD5B4B;" ><%=list.numRate%></em>%
                        <%}%>
                    </div>
                </div>
                <div>
                    销售单数|单
                </div>
                <div style="clear: both"></div>
            </li>
            <li>
                <div>
                    <span><%=list.perPrice%></span>
                </div>
                <div>
                    客单价|元
                </div>
                <div style="clear: both"></div>
            </li>
            <li>
                <div>
                    <span><%=list.profits%></span>
                </div>
                <div>
                    毛利润|元
                </div>
                <div style="clear: both"></div>
            </li>
        </ul>
    </div>
    <div class="salesDatabot">
        <p>去年同期</p>
        <ul>
            <li>
                <span>销售额</span>
                <em><%=list.saleOld%> </em>元
            </li>
            <li>
                <span>销售单数</span>
                <em ><%=list.numOld%> </em>单
            </li>
            <li>
                <span>客单价</span>
                <em><%=list.perPriceOld%> </em>元
            </li>
            <li>
                <span>毛利润</span>
                <em ><%=list.profitsOld%> </em>元
            </li>
        </ul>
    </div>
</script>
<script type="text/html" id="closeCashSeleTmp">
    <div class="select-box-header">
        <%if(list.length>0){%>
        <span class="text"><%=list[0].name%></span>
        <%}else{%>
        <span class="text">暂无员工</span>
        <%}%>
        <i class="iconfont icon-ico_arrow_down" id="jt"></i>
    </div>
    <div class="optionBox">
        <ul class="optionUL">
            <%if(list.length>0){%>
                <%for(var i = 0;i< list.length;i++){%>
                    <li value="<%=list[i].id%>"><%=list[i].name%></li>
                <%}%>
            <%}%>
        </ul>
    </div>
</script>
<!-- 当前页面逻辑 -->
<script>
    var time;//任务奖励参数
    var subid = quakooUser.getUserInfo().psid;//企业/公司id
    var shopId = quakooDb.getItem('sel_ShopId');//门店id
    var locSettlement = {};//资金结算对象
    var todayDataIn = [];
    var todayDataOut = [];
    var optId;//结算人ID
    var lastEndtime = 0;
    var date = new Date();
    time=date.format("yyyyMM");
    //今日概览的时间选择
    var saleTime = new dateRange("#yj-sale-time");
    saleTime.init();
    $('#yj-sale-time button').click(function () {
        chooseTime(5)
    });

    //任务奖励
    missionRewards();
    //销售奖励
    renderSaleIncentive();

    //日常任务和奖励轮播
    questRewardsBanner();
    $('.salesDataTop li').eq(0).click()
    popup();
    fromBox();

    //今日出入账明细
    getTodayDetails();
    //获取最近一次资金结算记录
    getLastSettlement();
    getUser();//结算现金获取所有员工（结算人）

    function getUser() {
        quakooData.ajaxGetData(config.getUrl_user_getAllUser(),{sid:shopId,userType:1},function (ret) {
            if(ret.success){
                if(quakooUtils.isNotBlack(ret.data)){
                    optId = ret.data[0].id;
                    var data = {list:ret.data};
                    var html = template("closeCashSeleTmp",data);
                    $('#closeCashSele').html(html);
                    selectTag($("#closeCashSele"), function (ret) {
                        optId = ret.value;
                    });
                }
            }
        })
    }

    // 数据表单初始化函数
    function fromBox() {
        var columns2 = [
            {field: "name", title: "商品名称", align: "left", valign: "middle", width: '50%'},
            {field: "company", title: "单位", align: "left", valign: "middle"},
            {field: "teamRoy", title: "团队提成", align: "left", valign: "middle"},
            {field: "personalRoy", title: "个人提成", align: "left", valign: "middle"}
        ];
        $('#cmyRoyaltyForm').bootstrapTable({
            data: cmyRoyaltyForm,
            classes: "table",
            pagination: true,        //是否显示分页
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 10,
            pageList: [5, 10, 15, 20],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            height: 400,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            columns: columns2
        });
        /*卡片分页-抵用券营销*/
        var $table = $("#yj-page-table");
        var data1 = [
            {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}, {id: 1}];
        var TableInit = function (callback) {
            var oTableInit = new Object();
            //初始化Table
            oTableInit.Init = function () {
                $table.bootstrapTable('destroy');
                $table.bootstrapTable({
                    data: data1,
                    classes: "table",
                    pagination: true,        //是否显示分页
                    pageNumber: 1,                       //初始化加载第一页，默认第一页
                    pageSize: 10,
                    pageList: [10, 15, 20],
                    sortable: false,
                    sortOrder: "asc",
                    showColumns: true,
                    strictSearch: true,
                    locale: "zh-CN",
                    paginationHAlign: "center",
                    clickToSelect: true,
                    paginationLoop: false,
                    columns: [],
                    onPreBody: function (data) {
                        if (callback) {
                            callback(data, this)
                        }
                    }
                });
            };
            return oTableInit;
        };
        var Table = new TableInit(manage);
        Table.Init();

        function manage(data, _this) {
            var html = '';
            var html2 = '';
            for (var i = (_this.pageNumber - 1) * _this.pageSize; i < _this.pageNumber * _this.pageSize; i++) {
                html += '<div class="item">' +
                    '<ul>' +
                    '<li style="min-width: 160px;">' +
                    '01.04 21:52-01.05 22:02' +
                    '</li>' +
                    '<li>￥2010</li>' +
                    '<li>￥1000</li>' +
                    '<li>￥1010</li>' +
                    '<li>￥500</li>' +
                    '<li>￥1000</li>' +
                    '<li>-</li>' +
                    '<li>￥500</li>' +
                    '</ul>' +
                    '</div>';
                html2 += '<li>1</li>';
            }
            $('.fixedBox ul').html(html2)
            $('.fixedBox ul').prepend('<li>结算</li>')
            var h = 0;
            $('.fixedBox ul li').each(function (index, item) {
                h += $(item).outerHeight();
            })
            $('.fixedBox').height(h);
            $(".formSetRecord .content").html(html);
            $('.formSetRecord').on('scroll', function () {
                $('.fixedBox').scrollTop($(this).scrollTop());
            })
            var w = 0;
            $(".formSetRecord .header ul li").each(function (index, item) {
                w += $(item).outerWidth();
            })
            $('.formSetRecord .header').width(w);
            $('.formSetRecord .content').width(w);
        }
    }

    function getTodayDetails() {
        //今日出入账明细
        $("#todaysDetails").bootstrapTable('destroy');
        $("#todaysDetails").bootstrapTable({
            data: todaysDetails,
            classes: "table",
            pagination: true,        //是否显示分页
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 10,
            pageList: [5, 10, 15, 20],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            columns: [
                {field: "orderNum", title: "订单号", align: "left", valign: "middle"},
                {field: "date", title: "时间", align: "left", valign: "middle"},
                {field: "name", title: "顾客姓名", align: "left", valign: "middle"},
                {field: "number", title: "手机号", align: "left", valign: "middle"},
                {field: "money", title: "出入账金额", align: "left", valign: "middle"},
                {field: "mode", title: "支付方式", align: "left", valign: "middle"},
                {
                    field: "type", title: "订单状态", align: "left", valign: "middle",
                    formatter: function (a, b, c) {
                        return '<span class="spanType span1">已完成</span>';
                    }
                },
                {field: "saleName", title: "销售员", align: "left", valign: "middle"},
                {
                    field: "btn", title: "操作", align: "left", valign: "middle", formatter: function () {
                        return "<buttom class='btnViewOrder'>查看订单</buttom>"
                    }
                },

            ]
        });
    }

    //任务奖励

    function missionRewards() {
        quakooData.ajaxGetData(config.getUrl_mission_getAllMission(),{sid:shopId},function (ret) {
            if(ret.success){
                if(quakooUtils.isNotBlack(ret.data.money)){
                    $("#taskTotal").html(ret.data.money)
                }else {
                    $('#taskTotal').html('0');
                }
                $("#taskReward").bootstrapTable('destroy');
                $("#taskReward").bootstrapTable({
                    data: ret.data.list,
                    classes: "table",
                    pagination: false,//是否显示分页
                    sortable: false,
                    sortOrder: "asc",
                    showColumns: true,
                    strictSearch: true,
                    locale: "zh-CN",
                    paginationHAlign: "center",
                    clickToSelect: true,
                    columns: [
                        {
                            field: "name", title: "任务名称", align: "left", valign: "middle"
                        },
                        {
                            field: "startTime", title: "截止时间", align: "left", valign: "middle", formatter: function (val, obj) {
                                return quakooUtils.formatTimeToDateDianLY(val) + '-' + quakooUtils.formatTimeToDateDianLY(obj.endTime);
                            }
                        },
                        {field: "amount", title: "奖励", align: "left", valign: "middle"},
                        {
                            field: "target", title: "任务量", align: "left", valign: "middle", formatter: function (item, obj) {
                                var val = item + '元';
                                if (obj.amountType == 1) {
                                    val = item + '个'
                                }
                                return val;
                            }
                        },
                        {field: "allAmount", title: "已完成", align: "left", valign: "middle"},
                        {
                            field: "allProgress", title: "进度", align: "left", valign: "middle", formatter: function (v, e) {
                                return v >= 100 ? "<span class='end'><i class='iconfont icon-ico_check'></i></span>" : canvasFn(v, 14);
                            }
                        }
                    ],
                });
            }
        })
    }

    function chooseType(self) {
        $(self).addClass('xuan').siblings().removeClass('xuan');
        $('.winBox').hide();
        $('.winBox').eq($(self).index()).show();

        getFinanceLogs();//今日资金明细
    }

    //选择type   今日1 昨日2 本周3 ，本月4
    function chooseTime(type,self) {
        var params = {subId:shopId}
        if(self){
            $(self).addClass('suanZ').siblings().removeClass('suanZ');
        }else{
            $(".salesDataTop li").removeClass('suanZ')
            params.startTime = saleTime.getTime()[2]
            params.endTime = saleTime.getTime()[3]
        }
        var url = '';
        if(type==1){
            url = config.getUrl_statisticsSale_saleToday();
        }else if(type==2){
            url = config.getUrl_statisticsSale_saleYesterday();
        }else if(type==3){
            url = config.getUrl_statisticsSale_saleWeek();
        }else if(type==4){
            url = config.getUrl_statisticsSale_saleMonth();
        }else if(type==5){
            url = config.getUrl_statisticsSale_searchSale();
        }
        quakooData.ajaxGetData(url,params,function (ret) {
            var html = template('saleMoneyTmp',{list:ret.data})
            $("#saleMoneyDom").html(html)
        })
    }

    //日常任务和奖励轮播
    function questRewardsBanner() {
        var ul = $('.questRewardsBanner>ul'),
            quW = $('.questRewardsBanner').outerWidth();
        quakooData.ajaxGetData(config.getUrl_user_taskReward(), {date: time, sid: shopId}, function (ret) {
            if (ret && ret.success) {
                ul.html(template('bannerList', {list: ret.data.clientUsers, tem: ret.data.tem}));
                var liW = ul.children('li').outerWidth(),
                    ulW = (ul.children('li').length * liW),
                    isRen = true;
                ul.css('width', ulW + 'px');
                $('.questRewardsBanner .btnLeft>span').on('click', function () {
                    $('.questRewardsBanner .btnRight').show();
                    var ulLeft = parseFloat(ul.css('left'));
                    if (!isRen) return;
                    isRen = false;
                    if (ulLeft >= 0 - liW) {
                        ulLeft = -liW;
                        $(this).parent().hide();
                    }
                    ;
                    ul.animate({
                        "left": (ulLeft + liW) + 'px'
                    }, 200, function () {
                        isRen = true;
                    });
                })
                $('.questRewardsBanner .btnRight>span').on('click', function () {
                    $('.questRewardsBanner .btnLeft').show();
                    var ulLeft = parseFloat(ul.css('left'));
                    if (!isRen) return;
                    isRen = false;
                    if (-(ulLeft - liW) >= ulW - quW - liW) {
                        ulLeft = -(ulW - quW - liW * 2);
                        $(this).parent().hide();
                    }
                    ul.animate({
                        "left": (ulLeft - liW) + 'px'
                    }, 200, function () {
                        isRen = true;
                    });
                })
            }
        })
    }



    // 数据统计图
    function chart(fundData) {
        var app = echarts.init(document.getElementById('echarts'));
        var option = {
            color: ['#DD5B4B', '#57B8DB'],
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'none'
                },
                backgroundColor: '#393953'
                , formatter: function (data) {
                    return (data[0].value == 0 ? '' : '收入：' + data[0].value + "<br/>") + (data[1].value == 0 ? '' : '支出：' + data[1].value);
                }
            },
            grid: {left: '15%', top: '20%',},
            title: {
                subtext: '单位：百元',
                right: '40',
                top: '-5'
            },
            xAxis: {
                type: 'category',
                data: ['支付宝', '微信', '现金', '储值卡'],
                axisTick: {
                    show: false
                }, axisLine: {
                    show: false
                }, offset: 3
            }
            ,
            yAxis: {
                type: 'value', axisTick: {
                    show: false
                }, axisLine: {
                    show: false
                }, offset: 10, splitNumber: 2
            }
            ,
            series: [
                {
                    type: 'bar',
                    barWidth: 10,
                    barCategoryGap: 10,
                    data: todayDataIn
                },
                {
                    type: 'bar',
                    barWidth: 10,
                    data: todayDataOut
                }
            ]
        };
        window.onresize = function () {
            app.resize();
        }
        app.setOption(option);
    }

    // 弹窗
    function popup() {
        function addAlert(a) {
            layer.closeAll()
            var index = layer.open({
                type: 1,
                skin: 'layui-layer-demo', //样式类名
                area: a.data.area,
                anim: 0,
                closeBtn: 0,
                title: a.data.title,
                shade: 0.03,
                shadeClose: true, //开启遮罩关闭
                scrollbar: false,
                content: a.data.popupBox,
                btn: a.data.btn,
                move: a.data.move,
                resize: false,
                yes: function () {
                },
                btn2: function () {
                    //    取消
                    console.log(a);
                },
                success: function (layero, index) {
                    a.data.fn(layero);
                }
            });
        }

        $('.btnCmyRoyalty').bind('click', {
            title: "提成商品",
            popupBox: $('.cmyRoyaltyPop'),
            btn: ['确认结算', '关闭窗口'],
            area: ['720px'],
            fn: function (layero) {
                layero.find('.layui-layer-btn0').hide();
            }
        }, addAlert);
    }

    //现金结算记录
    function settlementRecord(a) {
        var index = layer.open({
            type: 1,
            skin: 'layui-layer-demo', //样式类名
            area: ['720px', '560px'],
            anim: 0,
            closeBtn: 0,
            title: '现金结算记录',
            shade: 0.01,
            shadeClose: true, //开启遮罩关闭
            scrollbar: false,
            content: $('.settlementRecordPop'),
            resize: false,
            btn: ['关闭窗口'],
            success:function () {
                getPagerLog();
            }
        })
    }
    //获取结算记录
    function getPagerLog() {
        $("#cashSettlementRecord").bootstrapTable('destroy');
        $("#cashSettlementRecord").bootstrapTable({
            url: config.getUrl_settlement_getPagerLog(),
            method: 'get',
            classes: "table",
            pagination: true,            //是否显示分页
            pageNumber: 1,               //初始化加载第一页，默认第一页
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageSize: 5,
            pageList: [5, 10, 15, 20],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            columns: [
                {field: "", title: "结算时间", align: "left", valign: "middle",formatter:function (val, row, index) {
                        var html = quakooUtils.formatTimeToMonthDian(row.startTime)+'-'+quakooUtils.formatTimeToMonthDian(row.endTime);
                        return html;
                    }},
                {
                    field: "sale",
                    title: "销售额",
                    align: "left",
                    valign: "middle",
                    formatter: function (val, row, index) {
                        var html = '¥'+(val).toFixed(2);
                        return html;
                    }
                },
                {field: "cash", title: "现金收款", align: "left", valign: "middle",formatter:function (val,row,index) {
                        var html = '¥'+(val).toFixed(2);
                        return html;
                    }},
                {field: "other", title: "其他收款", align: "left", valign: "middle",formatter:function(val,row,index){
                        var html = '¥'+(val).toFixed(2);
                        return html;
                    }},
                {field: "obligate", title: "原预留金", align: "left", valign: "middle",formatter:function (val, row, index) {
                        var html = '¥'+(val).toFixed(2);
                        return html;
                    }},
                {field: "payMoney", title: "结算现金", align: "left", valign: "middle",formatter:function (val, row, index) {
                        var html = '¥'+(val).toFixed(2);
                        return html;
                    }},
                {field: "balanceMoney", title: "差额", align: "left", valign: "middle",formatter:function (val, row, index) {
                        var html = '¥'+(val).toFixed(2);
                        return html;
                    }},
                {field: "userName", title: "结算人", align: "left", valign: "middle"},
            ],
            queryParams: function (params) {
                params.subId = shopId;
                params.page = params.offset / params.limit + 1;
                params.size = params.limit;
                params.token = quakooUser.getUserInfo().token;
                return params
            },
        });

    }
    //获取最近一次结算
    function getLastSettlement() {
        quakooData.ajaxGetData(config.getUrl_settlement_loadClient(),{subId:shopId},function (ret) {
            var time;
            if(ret&&ret.success){
                console.log("上一次的结算记录",ret.data);
                lastEndtime = ret.data.endTime;
                if(ret.data.startTime != 0 && ret.data.endTime != 0){
                    time = quakooUtils.formatTimeToMonthDian(ret.data.startTime)+"-"+quakooUtils.formatTimeToMonthDian(ret.data.endTime);
                }else if(ret.data.startTime == 0 && ret.data.endTime != 0){
                    time = "开业"+"-"+quakooUtils.formatTimeToMonthDian(ret.data.endTime);
                }else{
                    time = "暂无结算记录";
                }
                $("#noSettlement").html(ret.data.balanceMoney);
                $("#cashMoney").html(ret.data.payMoney);
                $("#cashNum").html(ret.data.num);
                $("#lastTime").html(time)
            }
        })
    }
    //结算现金
    function diaSettlement() {
        var index = layer.open({
            type: 1,
            skin: 'layui-layer-demo', //样式类名
            anim:1,
            area: ['410px','280px'],
            closeBtn: 0,
            title: '',
            shade: 0.03,
            shadeClose: true, //开启遮罩关闭
            scrollbar: false,
            content: $('.closeCashPop'),
            btn: ['取消','确认结算'],
            move: $('.closeCashPop .titleBox h3'),
            resize: false,
            yes: function (index) {
                layer.close(index);
            },
            btn2: function (index) {
                settlement(index);
            },
            success: function (layero, index) {
                var endTime = Date.now();
                if(lastEndtime!=0){
                    layero.append('<div class="ov"><span class="fcHui">结算时间</span><span class="fcHui fr">'+quakooUtils.formatTimeToMonthDian(lastEndtime)+' - '+quakooUtils.formatTimeToMonthDian(endTime)+'</span></div>');
                }else{
                    layero.append('<div class="ov"><span class="fcHui">结算时间</span><span class="fcHui fr">'+'开业'+' - '+quakooUtils.formatTimeToMonthDian(endTime)+'</span></div>');
                }
                getUser();
                getMoney(lastEndtime,endTime);
            }
        });
    }
    function getMoney(startTime,endTime) {
        $('#timeSale').html("¥0");
        $('#timeCash').html("¥0");
        $('#timeAli').html("¥0");
        $('#timeWx').html("¥0");
        $('#timeOther').html("¥0");
        $("#setTotal").val('');
        $("#setcha").val('');
        $("#setyuliu").val('');
        $("#setjiao").val('');
        locSettlement = {};
        locSettlement.startTime = startTime;
        locSettlement.endTime = endTime;
        quakooData.ajaxGetData(config.getUrl_businessOrder_calculateOrders(),{startTime:startTime,endTime:endTime,subId:shopId},function (ret) {
            if(ret.success){
                if(quakooUtils.isNotBlack(ret.data)){
                    for(var i in ret.data){
                        locSettlement[i] = ret.data[i];
                    }
                    locSettlement.total = ret.data.cash;
                    $('#timeSale').html("¥"+locSettlement.sale);
                    $('#timeCash').html("¥"+locSettlement.cash);
                    $('#timeAli').html("¥"+locSettlement.ali);
                    $('#timeWx').html("¥"+locSettlement.wx);
                    $('#timeOther').html("¥"+locSettlement.other);
                    $("#setTotal").val(locSettlement.total);
                    // countCha()
                    $("#setyuliu").on("input  propertychange",function(){
                        countCha();
                        locSettlement.obligate = $("#setyuliu").val();
                    });
                    $("#setjiao").on("input  propertychange",function(){
                        countCha();
                        locSettlement.payMoney = $("#setjiao").val();
                    });
                }else{
                    locSettlement.sale = 0;
                    locSettlement.cash = 0;
                    locSettlement.ali = 0;
                    locSettlement.wx = 0;
                    locSettlement.other = 0;
                    locSettlement.total = 0
                }
            }
        })
    }
    //计算差额
    function countCha() {
        var money= (locSettlement.total+$("#setyuliu").val()*1-$("#setjiao").val()).toFixed(2);
        /*if(money<0){
            money = 0;
        }else{
            money =money
        }*/
        locSettlement.balanceMoney = money;
        $("#setcha").val(locSettlement.balanceMoney);
    }
    
    //今日资金明细
    function getFinanceLogs() {
        quakooData.ajaxGetData(config.getUrl_settlement_getFinanceLogs(),{subId:shopId},function (ret) {
            if(ret&&ret.success){
                if(quakooUtils.isNotBlack(ret.data)){
                    $("#todayTotalAdd").html(ret.data.totalIn);
                    $("#todayTotalSub").html(ret.data.totalOut);
                    todayDataIn.push((ret.data.aliIn/100).toFixed(1));
                    todayDataIn.push((ret.data.wxIn/100).toFixed(1));
                    todayDataIn.push((ret.data.cashIn/100).toFixed(1));
                    todayDataIn.push((ret.data.storedIn/100).toFixed(1));
                    todayDataOut.push((ret.data.aliOut/100).toFixed(1));
                    todayDataOut.push((ret.data.wxOut/100).toFixed(1));
                    todayDataOut.push((ret.data.cashOut/100).toFixed(1));
                    todayDataOut.push((ret.data.storedOut/100).toFixed(1));
                    chart();
                }
            }
        })
    }
    //进行结算
    function settlement(index) {
        var param ={};
        param.subId= shopId;
        param.optId = optId;
        param.sale = locSettlement.sale;
        param.cash = locSettlement.cash;
        param.ali = locSettlement.ali;
        param.wx = locSettlement.wx;
        param.other = locSettlement.other;
        param.total = locSettlement.total;
        param.obligate = locSettlement.obligate||0;
        param.payMoney = locSettlement.payMoney||0;
        param.balanceMoney = locSettlement.balanceMoney||0;
        param.num = locSettlement.num;
        param.startTime = locSettlement.startTime;
        param.endTime = locSettlement.endTime;
        console.log("销售额",param);
        if(quakooUtils.isBlack(param.sale)){
            layer.msg("此时间段内没有销售额");
            return;
        }
        param.status = 0;
        quakooData.ajaxGetData(config.getUrl_settlement_add(),param,function (ret) {
            if(ret.success){
                layer.msg('结算成功',{icon:1});
                layer.close(index)
            }else{
                layer.msg(ret.data);
            }
        })
    }
    //销售奖励
    function renderSaleIncentive(){
        quakooData.ajaxGetData(config.getUrl_product_saleReward(),{subid:shopId},function (ret) {
            if(quakooUtils.isNotBlack(ret.data.total)){
                $("#salesBonus").html(ret.data.total);
            }else{
                $('#salesBonus').html('0')
            }
            $("#salesIncentives").bootstrapTable('destroy');
            $("#salesIncentives").bootstrapTable({
                data: ret.data,
                classes: "table",
                pagination: false,//是否显示分页
                sortable: false,
                sortOrder: "asc",
                showColumns: true,
                strictSearch: true,
                locale: "zh-CN",
                paginationHAlign: "center",
                clickToSelect: true,
                columns: [
                    {field: "name", title: "商品名称", align: "left", valign: "middle", sortable: true},
                    {field: "rewardPersonal", title: "提成", align: "left", valign: "middle", sortable: true},
                    {field: "number", title: "完成量", align: "left", valign: "middle", sortable: true},
                    {field: "royaltyPersonal", title: "奖励", align: "left", valign: "middle", sortable: true},
                ],
            });
        })
    }

</script>

</html>