<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <title>售后处理</title>
    <!--Bootstrap样式引入开始-->
    <link rel="stylesheet" href="../resource/css/bootstrap.min.css">
    <link href="../resource/js/plugins/bootstarp-table/css/bootstrap-table.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../resource/js/plugins/bootstrapzTree/bootstrapStyle.css" type="text/css">
    <link rel="stylesheet" href="../resource/js/plugins/bootstrap-select/css/bootstrap-select.min.css" type="text/css">
    <link href="../resource/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">

    <!--Bootstrap样式引入结束-->
    <!--字体样式文件引用开始-->
    <link rel="stylesheet" href="../resource/fonts/iconfont.css">
    <!--字体样式文件引用结束-->
    <!--标签样式重置开始-->
    <link rel="stylesheet" href="../resource/css/reset.css">
    <!--标签样式重置结束-->
    <!--公用组件样式-->
    <link rel="stylesheet" href="../resource/css/style.css">
    <link rel="stylesheet" href="../resource/css/common.css">
    <!--公用组件样式结束-->
    <!--单页样式-->
    <link rel="stylesheet" href="../resource/css/yanjing/afterSale.css">
    <!--单页样式结束-->

</head>
<body class="body-bg" id="body">
<div class="header">
    <ul class="tab-ul clear">
        <li class="active" onclick="choose(1)">售后处理</li>
        <li onclick="choose(2)">售后记录</li>
    </ul>
    <div class="right-info">
        <div class="selectBox" id="yj-name-id">
            <div class="select-box-header">
                <span class="text">顾客姓名</span><i class="iconfont icon-ico_arrow_down"></i>
            </div>
            <div class="optionBox">
                <ul class="optionUL">
                    <li value="1">顾客姓名</li>
                    <li value="2">顾客id</li>
                    <li value="3" style="display: none">顾客手机号</li>
                </ul>
            </div>
        </div>
        <input type="search" class="search-box" placeholder="搜索顾客姓名" id="yj-value">
        <div class="btn btn-info" style="margin-left: 10px;" onclick="search()">搜索</div>
    </div>
</div>
<div class="content-main">
    <div class="no-order">搜索订单号、顾客姓名或手机号</div>
    <ul class="content-inner">
        <li class="tab-item">
            <table id="as-table" data-toggle="table"  class="table table-border"></table>
        </li>
        <li class="tab-item">
            <table id="record-table" data-toggle="table"  class="table table-border"></table>
        </li>
    </ul>

</div>

<div class="content-view content-view1" id="afterDom">

</div>
<div class="content-view-change">
    <div class="header">
        <span class="title">全部镜片</span>
        <input type="text" placeholder="搜索系列">
    </div>
    <div class="content clear">
        <ul class="left-tab">
            <li class="left-item active">澳洲明月</li>
            <li class="left-item">美国暴龙</li>
            <li class="left-item">宝丽来</li>
            <li class="left-item">Calvin Kle</li>
        </ul>
        <ul class="right-content">
            <li class="right-item">
                <table id="brand-table-1" data-toggle="table"  class="table table-border"></table>
            </li>
            <li class="right-item">
                <table id="brand-table-2" data-toggle="table"  class="table table-border"></table>
            </li>
            <li class="right-item">
                <table id="brand-table-3" data-toggle="table"  class="table table-border"></table>
            </li>
            <li class="right-item">
                <table id="brand-table-4" data-toggle="table"  class="table table-border"></table>
            </li>
        </ul>
    </div>
    <div class="bottom clear">
        <div class="wear-tear">
            <input type="checkbox" id="wear-tear">
            <label for="wear-tear">损耗原商品<i class="iconfont">&#xe6a8;</i></label>
        </div>
        <div class="close-win">
            关闭窗口
        </div>
    </div>
</div>
<div class="content-view-salesReturn">
    <div class="content">确定将「」退货？</div>
</div>
<div class="content-view-breakage">
    <div class="content">确定将「」报损？</div>
</div>

<!--全局JS引用-->
<script src="../resource/js/jquery.min.js"></script>
<script src="../resource/js/bootstrap.js?v=3.3.6"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table.js"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table-zh-CN.min.js"></script>
<script src="../resource/js/plugins/layer/layer.js"></script>
<script src="../resource/layui/layui.js"></script>

<script src="../resource/js/lib/quakooLib/QuakooBase-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooConfig-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooBasePc-1.0.0.js"></script>
<script src="../resource/js/lib/quakoo/Config.js"></script>
<script src="../resource/js/lib/quakoo/project.js"></script>
<script src="../resource/common/common.js?" +Math.random()></script>

<script src="../resource/js/yanjing/yanjing.js"></script>
<script src="../resource/js/yanjing/daterange.js"></script>
<script src="../resource/js/template-native.js"></script>

<script src="../resource/js/yanjing/mobiscroll.2.13.2.js"></script>

<script type="text/html" id="afterTmp">
    <div class="dialog-header">
        <%if(type==1){%>
        <div style="float: left;padding-left: 20px;font-weight: bold;">订单详情</div>
        <%}else{%>
        <ul class="dialog-tab-ul">
            <%for(var i=0; i< allList.length;i++){%>
            <li onclick="changeSalesLog('<%=i%>',this)"><%=allList[i].saleTime%></li>
            <%}%>
            <li>2018.10.27</li>
        </ul>
        <%}%>
        <div class="order-num">
            <input type="button" value="订单号">
            <span><%=list.orderNo%></span>
        </div>
    </div>
    <div class="dialog-content">
        <div class="customer">
            <div class="customer-title">顾客信息</div>
            <ul class="customer-info">
                <li class="info-item">
                    <button type="button">姓名</button>
                    <%if(type==1){%>
                    <span><%=list.uname%></span>
                    <%}else{%>
                    <span><%=list.userName%></span>
                    <%}%>
                </li>
                <li class="info-item">
                    <button type="button">年龄</button>
                    <%if(type==1){%>
                    <span><%=list.uAge%></span>
                    <%}else{%>
                    <span><%=list.userAge%></span>
                    <%}%>
                </li>
                <li class="info-item">
                    <button type="button">联系方式</button>
                    <%if(type==1){%>
                    <span><%=list.uphone%></span>
                    <%}else{%>
                    <span><%=list.phone%></span>
                    <%}%>
                </li>
                <li class="info-item">
                    <button type="button">订单金额</button>
                    <span><%=list.totalPrice%></span>
                </li>
                <li class="info-item">
                    <button type="button">折扣</button>
                    <span><%=list.discount%></span>
                </li>
                <li class="info-item">
                    <button type="button">验光师</button>
                    <span><%=list.oiName%></span>
                </li>
                <li class="info-item">
                    <button type="button">加工师</button>
                    <span><%=list.machiningName%></span>
                </li>
            </ul>
            <div class="remark">备注: <%=list.desc%></div>
        </div>
        <div class="optometry">
            <div class="optometry-top">
                <div class="optometry-title">验光信息</div>
                <div class="selectBox" id="selectYgInfo" style="width: 160px;">
                    <div class="select-box-header">
                        <%if(list.optometryInfos.length>0){%>
                        <span class="text"><%=formatDateToDotted(list.optometryInfos[0].ctime)%></span><i class="iconfont icon-ico_arrow_down"></i>
                        <%}else{%>
                        <span class="text">更多验光记录</span><i class="iconfont icon-ico_arrow_down"></i>
                        <%}%>
                    </div>
                    <div class="optionBox">
                        <ul class="optionUL" id="moreYgList">
                            <%for(var i=0;i< list.optometryInfos.length;i++){%>
                            <li value="<%=list.optometryInfos[i].id%>"><%=formatDateToDotted(list.optometryInfos[i].ctime)%></li>
                            <%}%>
                        </ul>
                    </div>
                </div>
                <!--<ul class="optometry-date-tab clear">
                    <li class="optometry-date-item active">本次</li>
                    <li class="optometry-date-item">
                        <span>2018.10.27</span>
                        <button type="button">隐形</button>
                    </li>
                    <li class="optometry-date-item">
                        <span>2018.10.27</span>
                        <button type="button">通用</button>
                    </li>
                </ul>-->
            </div>
            <div class="optometry-content" id="ygInfoDom">

            </div>
        </div>

        <div class="order">
            <div class="order-header">
                <div class="order-title">订单信息</div>
                <%if(type==1){%>
                <button type="button" class="fr btn btn-primary add">添加</button>
                <input type="text" class="fr money" placeholder="金额" >
                <div class="selectBox fr" id="selectOrder">
                    <div class="select-box-header">
                        <span class="text">附加收费</span><i class="iconfont icon-ico_arrow_down"></i>
                    </div>
                    <div class="optionBox">
                        <ul class="optionUL">
                            <li value="01">1</li>
                            <li value="02">2</li>
                            <li value="03">3</li>
                        </ul>
                    </div>
                </div>
                <%}%>
            </div>
            <div class="order-table">
                <table class="table">
                    <thead>
                    <tr>
                        <th>商品名称</th>
                        <th>数量</th>
                        <th>零售价</th>
                        <th>会员折扣</th>
                        <th>小计</th>
                        <th>质保状态</th>
                        <%if(type==1){%>
                        <th>操作</th>
                        <%}%>
                    </tr>
                    </thead>
                    <tbody>
                    <%for(var i=0;i< list.skuids.length;i++){%>
                    <tr>
                        <td><%=list.skuids[i].code%>
                            <!--<span class="sign-btn">定制商品</span>
                            <div class="selectBox small-select selectBatch" id="selectBatch">
                                <div class="select-box-header">
                                    <span class="text">选择批号</span><i class="iconfont icon-ico_arrow_down"></i>
                                </div>
                                <div class="optionBox">
                                    <ul class="optionUL">
                                        <li value="01">1</li>
                                        <li value="02">2</li>
                                        <li value="03">3</li>
                                    </ul>
                                </div>
                            </div>-->
                        </td>
                        <td><%=list.skuids[i].num%></td>
                        <td>￥<%=list.skuids[i].price%></td>
                        <td>
                            <input type="number" class="discount" readonly="readonly" value="<%=list.skuids[i].discount%>" placeholder="10.0">
                        </td>
                        <td>￥<%=list.skuids[i].subtotal%></td>
                        <%if(list.skuids[i].qualityType==1){%>
                        <td><i class="indate indate-danger"></i>过期</td>
                        <%}else if(list.skuids[i].qualityType==2){%>
                        <td><i class="indate indate-going"></i>保修中</td>
                        <%}else if(list.skuids[i].qualityType==3){%>
                        <td><i class="indate indate-renew"></i>换新</td>
                        <%}else{%>
                        <td><i class="indate"></i>-</td>
                        <%}%>
                        <%if(type==1){%>
                        <td>
                            <span class="change" onclick="change()">更换</span>
                            <span class="sales-return" onclick="salesReturn('<%=list.skuids[i].skuid%>')">退货</span>
                            <span class="breakage" onclick="breakage('<%=list.skuids[i].skuid%>')">报损</span>
                        </td>
                        <%}%>
                    </tr>
                    <%}%>
                    <%for(var i=0;i< list.surcharges.length;i++){%>
                    <tr class="promotion">
                        <td colspan="4"><%=list.surcharges[i].name%></td>
                        <td colspan="3">-￥<%=list.surcharges[i].price%></td>
                    </tr>
                    <%}%>

                    </tbody>
                </table>
            </div>
            <div class="order-bottom">
                <div class="fl origin">
                    <span class="text">原价共计</span>
                    <span class="money">￥<%=list.totalPrice%></span>
                </div>
                <div class="fl last">
                    <span class="text">上次支付</span>
                    <span class="money">￥<%=list.price%></span>
                </div>
                <div class="fr extra">
                    <span class="text">额外支付</span>
                    <span class="case">
                        <i>￥</i><input type="number"  value="<%=list.extra%>" placeholder="0">
                    </span>
                </div>
                <div class="fr ">
                    <span class="text">退款金额</span>
                    <span class="case">
                        <i>￥</i><input type="number" value="<%=list.refund%>" placeholder="0">
                    </span>
                </div>
            </div>
        </div>
        <div class="bot clear">
            <div class="bot-item">
                <span class="name">售后原因</span>
                <div class="selectBox small-select selectBatch" id="select-why">
                    <div class="select-box-header">
                        <span class="text"><%=list.reason%></span><i class="iconfont icon-ico_arrow_down"></i>
                    </div>
                    <div class="optionBox">
                        <ul class="optionUL">
                            <li value="01">1</li>
                            <li value="02">2</li>
                            <li value="03">3</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="bot-item">
                <span class="name">售后人</span>
                <div class="selectBox small-select selectBatch" id="select-who">
                    <div class="select-box-header">
                        <span class="text"><%=list.optName%></span><i class="iconfont icon-ico_arrow_down"></i>
                    </div>
                    <div class="optionBox">
                        <ul class="optionUL">
                            <%for(var i=0;i< peopleData.length;i++){%>
                            <li value="<%=peopleData[i].id%>"><%=peopleData[i].name%></li>
                            <%}%>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dialog-bottom">
        <button type="button" class="closewin btn btn-gray">关闭窗口</button>
        <%if(type==1){%>
        <button type="button" class="submit btn btn-primary">提交订单</button>
        <button type="button" class="save btn btn-order">保存订单</button>
        <%}%>
    </div>
</script>
<script type="text/html" id="ygInfoTmp">
    <div class="optometry-content-top clear">
        <ul class="optometry-content-top-tab-list clear" id="ygType">
            <li class="active" onclick="changeYgSelect('yuanYongRes',this)">远用</li>
            <li onclick="changeYgSelect('yinXingRes',this)">隐形</li>
            <li onclick="changeYgSelect('jinYongRes',this)">近用</li>
            <li onclick="changeYgSelect('jianJinDuoJiaoDianRes',this)">渐进多焦点</li>
        </ul>
    </div>
    <div class="visionForm">
        <div class="formLeftBorder"></div>
        <div class="tableContent active" id="tableContent">
            <%for(var i in LocYgInfo){%>
            <%if(i=='yuanYongRes'){%>
            <table border="" cellpadding="1" cellspacing="0" style="width:100%;display: block" class="<%=i%>">
                <%}else{%>
                <table border="" cellpadding="1" cellspacing="0" style="width:100%;display: none" class="<%=i%>">
                    <%}%>
                    <thead>
                    <tr>
                        <th></th>
                        <%for(var j=0; j < LocYgInfo[i].length;j++){%>
                        <th><%=LocYgInfo[i][j].name%></th>
                        <%}%>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <th>R</th>
                        <%for(var j=0;j< LocYgInfo[i].length;j++){%>
                        <td style="background: #fff"><%=LocYgInfo[i][j].valueRight%></td>
                        <%}%>
                    </tr>
                    <tr>
                        <th>L</th>
                        <%for(var j=0;j< LocYgInfo[i].length;j++){%>
                        <td style="background: #fff"><%=LocYgInfo[i][j].valueLeft%></td>
                        <%}%>
                    </tr>
                    </tbody>
                </table>
                <%}%>
        </div>
        <div class="formRightBorder"></div>
    </div>
    <div class="optometry-content-bot clear">
        <div class="kuang">
            <input type="text" readonly="readonly" value="<%=list.farPd%>" placeholder="远用瞳距">
            <span class="mm">mm</span>
        </div>
        <!--<div class="selectBox">
            <div class="select-box-header">
                <span class="text">右眼</span>
            </div>
        </div>-->
        <div class="selectBox" >
            <div class="select-box-header">
                <span class="text"><%=list.wearProp%></span>
            </div>
        </div>
        <div class="selectBox" id="select-suggest">
            <div class="select-box-header">
                <span class="text"><%=list.support%></span>
            </div>
        </div>
        <div class="selectBox" id="select-results">
            <div class="select-box-header">
                <span class="text"><%=list.res%></span>
            </div>
        </div>
    </div>

</script>
<script>
    var subid = quakooUser.getUserInfo().psid;//企业/公司id
    var shopId = quakooDb.getItem('sel_ShopId');//门店id
    var selectType = 1;  //1姓名   2 id   3手机号
    var type = 1;   //1售后处理   2售后记录

    var peopleData;  //门店员工
    var orderInfo = {};  //选择的订单信息
    var LocYgInfo = {};  //验光信息对象
    var allYgInfo = {};//选择某个订单时所有的验光信息
    LocYgInfo.yuanYongRes=[{name:'裸眼视力',value:'nakedEyesight'},{name:'球镜(S)',value:'s'},{name:'柱镜(C)',value:'c'},{name:'轴位(A)',value:'a'},{name:'矫正视力',value:'correctEyesight'},{name:'瞳距(PD)',value:'pd'},{name:'瞳高',value:'ph'},{name:'棱镜(V)',value:'v'},{name:'基底(SC)',value:'sc'}];
    LocYgInfo.yinXingRes=[{name:'裸眼视力',value:'nakedEyesight'},{name:'球镜(S)',value:'s'},{name:'柱镜(C)',value:'c'},{name:'轴位(A)',value:'a'},{name:'矫正视力',value:'correctEyesight'},{name:'曲率',value:'q'},{name:'直径',value:'d'}];
    LocYgInfo.jinYongRes=[{name:'裸眼视力',value:'nakedEyesight'},{name:'球镜(S)',value:'s'},{name:'柱镜(C)',value:'c'},{name:'轴位(A)',value:'a'},{name:'矫正视力',value:'correctEyesight'},{name:'瞳距(PD)',value:'pd'},{name:'瞳高',value:'ph'},{name:'棱镜(V)',value:'v'},{name:'基底(SC)',value:'sc'}];
    LocYgInfo.jianJinDuoJiaoDianRes=[{name:'裸眼视力',value:'nakedEyesight'},{name:'球镜(S)',value:'s'},{name:'柱镜(C)',value:'c'},{name:'轴位(A)',value:'a'},{name:'矫正视力',value:'correctEyesight'},{name:'远瞳距',value:'fpd'},{name:'近瞳距',value:'npd'},{name:'ADD',value:'add'},{name:'瞳高',value:'ph'}];

    var allOrderSales;//某个订单的所有售后记录
    quakooData.ajaxGetData(config.getUrl_user_getAllUser(),{sid:shopId,userType:1},function (ret) {
        if(ret && ret.success){
            peopleData = ret.data;
        }
    })

    selectTag($('#yj-name-id'),function (ret) {
        selectType = ret.value;
        if(selectType==1){
            $('#yj-value').attr('placeholder','搜索顾客姓名')
        }else if(selectType==2){
            $('#yj-value').attr('placeholder','搜索顾客id')
        }else if(selectType==3){
            $('#yj-value').attr('placeholder','搜索顾客手机号')
        }
    })
    //type  1售后处理     2售后记录
    function choose(t) {
        if(type==t){
            return
        }
        selectType = 1;
        $('#yj-name-id .text').html('顾客姓名')
        type = t;
        if(type==1){
            $('#yj-name-id li').eq(2).hide().siblings().show();
        }else{
            $('#yj-name-id li').eq(1).hide().siblings().show();
        }
        $('.header .tab-ul li').eq(type-1).addClass('active').siblings().removeClass('active');
        if(quakooUtils.isBlack($('#yj-value').val())){
            $(".no-order").show();
            $(".content-inner").hide();
            return ;
        }else{
            $(".no-order").hide();
            $(".content-inner").show();
        }
        if(type==1){
            getData()
        }else{
            getDataLog()
        }
    }
    function search() {
        if(quakooUtils.isBlack($('#yj-value').val())){
            layer.msg('请输入搜索内容')
            $(".no-order").show();
            $(".content-inner").hide();
            return
        }
        $(".no-order").hide();
        $(".content-inner").show();
        if(type==1){
            getData()
        }else{
            getDataLog()
        }
    }
    //售后处理
    function getData() {
        $('.tab-item').eq(0).show().siblings().hide();
        $("#as-table").bootstrapTable('destroy');
        $("#as-table").bootstrapTable({
            url: config.getUrl_order_getAllOrder(),
            classes: "table",
            pagination: true,        //是否显示分页
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 6,
            pageList: [6, 12, 18],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            // paginationLoop:false,        //分页是否可以循环
            queryParams: function (param) {
                param.subId = shopId;
                param.token = quakooUser.getUserInfo().token;
                if(selectType==1){
                    param.name = $('#yj-value').val();
                }else{
                    param.uid = $('#yj-value').val();
                }
                return param
            },
            columns:[
                {field: "orderNo", title: "订单号", align:"left",valign:"middle"},
                {field: "ctime", title: "销售时间", align:"left",valign:"middle",formatter:function (value, row, index) {
                        return quakooUtils.formatTimeToDateDian(value);
                    }},
                {field: "uname", title: "顾客姓名", align:"left",valign:"middle"},
                {field: "uphone", title: "联系方式", align:"left",valign:"middle"},
                {field: "priceYuan", title: "成交金额", align:"left",valign:"middle",formatter:function (value, row, index) {
                        return '￥'+value;
                    }},
                {field: "personnelName", title: "销售员", align:"left",valign:"middle"},
                {field: "asCount", title: "售后次数", align:"center",valign:"middle"},
                {field: "id", title: "操作", align:"center",valign:"middle",formatter: function (value, row, index) {
                        return '<button class="btn btn-primary" onclick="goAfter('+value+',1)">进行售后</button>';
                    }
                }

            ]

        });
    }
    //售后记录
    function getDataLog() {
        $('.tab-item').eq(1).show().siblings().hide();
        $("#record-table").bootstrapTable('destroy');
        $("#record-table").bootstrapTable({
            url: config.getUrl_afterSale_getLogPager(),
            classes: "table",
            pagination: true,        //是否显示分页
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 6,
            pageList: [6, 12, 18],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            // paginationLoop:false,        //分页是否可以循环
            queryParams: function (param) {
                param.subId = shopId;
                param.token = quakooUser.getUserInfo().token;
                if(selectType==1){
                    param.userName = $('#yj-value').val();
                }else{
                    param.phone = $('#yj-value').val();
                }
                return param
            },
            columns:[
                {field: "orderNo", title: "订单号", align:"left",valign:"middle"},
                {field: "lastTime", title: "最后一次售后", align:"left",valign:"middle"},
                {field: "userName", title: "顾客姓名", align:"left",valign:"middle"},
                {field: "userPhone", title: "联系方式", align:"left",valign:"middle"},
                {field: "resaon", title: "售后原因", align:"left",valign:"middle"},
                {field: "salesName", title: "销售员", align:"left",valign:"middle"},
                {field: "status", title: "订单状态", align:"left",valign:"middle",formatter: function (value, row, index) {
                        var str = '-';
                        switch (value){
                            case 1:str = '<div class="btn-status btn-red">未加工</div>';break;
                            case 2:str = '<div class="btn-status btn-blue">欠￥500</div>';break;
                            case 3:str = '<div class="btn-status btn-yellow">未取货</div>';break;
                            case 4:str = '<div class="btn-status btn-grays">已完成</div>';break;
                            case 5:str = '<div class="btn-status btn-black">已作废</div>';break;
                            case 6:str = '<div class="btn-status btn-green">临时订单</div>';break;
                        }
                        return str;
                    }},
                {field: "times", title: "售后次数", align:"center",valign:"middle"},
                {field: "id", title: "操作", align:"center",valign:"middle",formatter: function (value, row, index) {
                        return '<button class="btn btn-primary" onclick="goAfter('+value+',2)">查看</button>';
                    }
                }

            ]

        });
    }
    //查看售后
    function lookAfter(id) {

    }
    //进行售后    type   1进行售后   2查看售后
    function goAfter(id,type) {
        var index = layer.open({
            type: 1,
            shade: 0.01,
            shadeClose: true,
            skin: 'layui-layer-demo layui-layer-view1', //样式类名
            area: ['960px', '560px'],
            anim: 0,
            closeBtn:0,
            title:"",
            move:'dialog-tab-ul',
            content: $('.content-view1'),
            btn: "",
            success: function(layero, index){
                $(".layui-layer-view1 .closewin").click(function () {
                    layer.close(index);
                })
                if(type==1){
                    quakooData.ajaxGetData(config.getUrl_order_loadOrder(),{id:id},function (ret) {
                        orderInfo = ret;
                        $("#afterDom").html(template('afterTmp',{list:ret.order,type:type,peopleData:peopleData}))
                        goAfterSuccess(ret.order)
                    })
                }else if(type==2){
                    quakooData.ajaxGetData(config.getUrl_afterSale_loadDetails(),{asId:id},function (ret) {
                        for(var i =0;i<ret.data.length;i++){
                            ret.data[i].skuids = ret.data[i].sku;
                        }
                        allOrderSales = ret.data;
                        $("#afterDom").html(template('afterTmp',{list:ret.data[0],allList:ret.data,type:type,peopleData:peopleData}))
                        goAfterSuccess(ret.data[0])
                    })
                }

            }
        });
    }
    function goAfterSuccess(data) {
        for(var i=0;i<data.optometryInfos.length;i++){
            allYgInfo[data.optometryInfos[i].id] = data.optometryInfos[i];
        }
        if(data.optometryInfos.length>0){
            for(var i in LocYgInfo){
                for(var j=0;j<LocYgInfo[i].length;j++){
                    if(allYgInfo[data.optometryInfos[0].id][i] && allYgInfo[data.optometryInfos[0].id][i].leftResItem&& allYgInfo[data.optometryInfos[0].id][i].leftResItem[LocYgInfo[i][j].value]){
                        LocYgInfo[i][j].valueLeft = allYgInfo[data.optometryInfos[0].id][i].leftResItem[LocYgInfo[i][j].value]
                    }
                    if(allYgInfo[data.optometryInfos[0].id][i] && allYgInfo[data.optometryInfos[0].id][i].rightResItem&& allYgInfo[data.optometryInfos[0].id][i].rightResItem[LocYgInfo[i][j].value]){
                        LocYgInfo[i][j].valueRight = allYgInfo[data.optometryInfos[0].id][i].rightResItem[LocYgInfo[i][j].value]
                    }
                }
            }
            $('#ygInfoDom').html(template('ygInfoTmp',{list:allYgInfo[data.optometryInfos[0].id],LocYgInfo:LocYgInfo}))
        }
        //选择验光信息
        selectTag($("#selectYgInfo"), function (ret) {
            for(var i in LocYgInfo){
                for(var j=0;j<LocYgInfo[i].length;j++){
                    if(allYgInfo[ret.value][i] && allYgInfo[ret.value][i].leftResItem&& allYgInfo[ret.value][i].leftResItem[LocYgInfo[i][j].value]){
                        LocYgInfo[i][j].valueLeft = allYgInfo[ret.value][i].leftResItem[LocYgInfo[i][j].value]
                    }
                    if(allYgInfo[ret.value][i] && allYgInfo[ret.value][i].rightResItem&& allYgInfo[ret.value][i].rightResItem[LocYgInfo[i][j].value]){
                        LocYgInfo[i][j].valueRight = allYgInfo[ret.value][i].rightResItem[LocYgInfo[i][j].value]
                    }
                }
            }
            $('#ygInfoDom').html(template('ygInfoTmp',{list:allYgInfo[ret.value],LocYgInfo:LocYgInfo}))
        });
        selectTag($('#select-who'),function (ret) {

        })
    }
    function changeSalesLog(index,self){
        $(self).addClass('active').siblings().removeClass('active');
        goAfterSuccess(allOrderSales[index])
        //$(".dialog-tab-item").hide().eq($(this).index()).show();
        //$(".right-info").hide().eq($(this).index()).show();
    }
   /* var data3 = [
        {onum:"123456a45c",otime:"2018.06.17 12:31",customerName:"邓裕",phoneNum:"13781728173",closingPrice:"￥380",salesMan:'李燕',afterNum:"12次"},
        {onum:"123456a45c",otime:"2018.06.17 12:31",customerName:"邓裕",phoneNum:"13781728173",closingPrice:"￥380",salesMan:'李燕',afterNum:"12次"},
        {onum:"123456a45c",otime:"2018.06.17 12:31",customerName:"邓裕",phoneNum:"13781728173",closingPrice:"￥380",salesMan:'李燕',afterNum:"12次"},
        {onum:"123456a45c",otime:"2018.06.17 12:31",customerName:"邓裕",phoneNum:"13781728173",closingPrice:"￥380",salesMan:'李燕',afterNum:"12次"},
        {onum:"123456a45c",otime:"2018.06.17 12:31",customerName:"邓裕",phoneNum:"13781728173",closingPrice:"￥380",salesMan:'李燕',afterNum:"12次"}
    ];
    var data1 = [
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-red">未加工</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-yellow">未取货</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-blue">欠￥500</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-black">已作废</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-red">未加工</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-yellow">未取货</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-blue">欠￥500</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-black">已作废</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-red">未加工</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-yellow">未取货</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-blue">欠￥500</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-black">已作废</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-red">未加工</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-yellow">未取货</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-blue">欠￥500</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-black">已作废</div>',afterNum:"10次"},
        {oNum:"123456a45c",lastTime:"2018-06-17 12:31",customerName:"邓裕",phoneNum:"13781728173",afterWhy:"佩戴不适",salesMan:'李燕',oStatus:'<div class="btn-status btn-grays">已完成</div>',afterNum:"10次"}
    ];

    $("#record-table").bootstrapTable({
        data:data1,                 //被加载的数据。
        classes:"table",
        pagination:true,            //是否显示分页
        pageNumber:1,               //初始化加载第一页，默认第一页
        pageSize: 10,
        pageList: [5, 10, 15, 20],
        sortable: false,
        sortOrder: "asc",
        showColumns: true,
        strictSearch: true,
        locale: "zh-CN",
        paginationHAlign:"center",
        clickToSelect:true,
        columns:[
            {field: "oNum", title: "订单号", align:"left",valign:"middle"},
            {field: "lastTime", title: "最后一次售后", align:"left",valign:"middle"},
            {field: "customerName", title: "顾客姓名", align:"left",valign:"middle"},
            {field: "phoneNum", title: "联系方式", align:"left",valign:"middle"},
            {field: "afterWhy", title: "售后原因", align:"left",valign:"middle"},
            {field: "salesMan", title: "销售员", align:"left",valign:"middle"},
            {field: "oStatus", title: "订单状态", align:"left",valign:"middle"},
            {field: "afterNum", title: "售后次数", align:"center",valign:"middle"},
            {field: "", title: "操作", align:"center",valign:"middle",formatter: function (value, row, index) {
                    return '<button class="btn btn-primary">查看</button>';
                }
            }

        ]

    });
    /!**
     * 更换弹窗数据接口
     * *!/
    var brand1 = [
        {
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        },{
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        },{
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        },{
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        },{
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        },{
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        },{
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        },{
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        },{
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        },{
            serice:"A系列",ballEye:"-0.25",degree:"-0.50",price:"300元",stock:"8",source:"本店"
        }
    ];
    $("#brand-table-1").bootstrapTable({
        data:brand1,                 //被加载的数据。
        classes:"table",
        pagination:true,            //是否显示分页
        pageNumber:1,               //初始化加载第一页，默认第一页
        pageSize: 10,
        pageList: [5, 10, 15, 20],
        sortable: false,
        sortOrder: "asc",
        showColumns: true,
        strictSearch: true,
        locale: "zh-CN",
        paginationHAlign:"center",
        clickToSelect:true,
        columns:[
            {field: "serice", title: "系列", align:"left",valign:"middle"},
            {field: "ballEye", title: "球镜度数", align:"left",valign:"middle"},
            {field: "degree", title: "散光度数", align:"left",valign:"middle"},
            {field: "price", title: "价格", align:"left",valign:"middle"},
            {field: "stock", title: "可用库存", align:"left",valign:"middle"},
            {field: "source", title: "来源", align:"left",valign:"middle"},
            {field: "", title: "操作", align:"center",valign:"middle",formatter: function (value, row, index) {
                    return '<button class="btn btn-primary">选择</button>';
                }
            }
        ]
    });

    /!**
     * 主页tab切换 oncl
     * *!/
  /!*  $(".tab-ul li").click(function(){
        $(this).addClass('active').siblings().removeClass('active');
        $(".tab-item").hide().eq($(this).index()).show();
        showTable();//显示表格
        //$(".right-info").hide().eq($(this).index()).show();
    });*!/
    /!**
     * 弹窗tab切换
     * *!/
    $(".dialog-tab-ul li").click();

    /!**
     * 弹窗验光信息 时间tab切换
     * *!/
    $(".optometry-date-tab .optometry-date-item").click(function(){
        $(this).addClass('active').siblings().removeClass('active');
        //$(".dialog-tab-item").hide().eq($(this).index()).show();
        //$(".right-info").hide().eq($(this).index()).show();
    });
    /!**
     * 弹窗验光信息 种类tab切换
     * *!/
    $(".optometry-content-top-tab-list li").click(function(){
        $(this).addClass('active').siblings().removeClass('active');
        //$(".dialog-tab-item").hide().eq($(this).index()).show();
        //$(".right-info").hide().eq($(this).index()).show();
    });
    /!**
     * 更换弹窗tab切换
     * *!/
    $(".content-view-change .content .left-tab .left-item").click(function () {
        $(this).addClass('active').siblings().removeClass('active');
        $(".content-view-change .content .right-content .right-item").hide().eq($(this).index()).show();
    })
    /!**
     * 下拉框
     * *!/
    selectTag($("#selectBox"),function (ret) {
        console.log(ret)
    });
    /!**
     * 验光信息下拉框
     * *!/
    selectTag($("#select-site"),function (ret) {
        console.log(ret)
    });
    selectTag($("#select-property"),function (ret) {
        console.log(ret)
    });
    selectTag($("#select-results"),function (ret) {
        console.log(ret)
    });
    selectTag($("#select-suggest"),function (ret) {
        console.log(ret)
    });
    /!**
     * 验光记录下拉框
     * *!/
    selectTag($("#selectOptometry"),function (ret) {
        console.log(ret)
    });
    /!**
     * 订单信息下拉框
     * *!/
    selectTag($("#selectOrder"),function (ret) {
        console.log(ret)
    });
    /!**
     * 订单信息批号下拉框
     * *!/
    selectTag($("#selectBatch"),function (ret) {
        console.log(ret)
    });

    /!**
     * 售后原因下拉框
     * *!/
    selectTag($("#select-why"),function (ret) {
        console.log(ret)
    });

    /!**
     * 操作人下拉框
     * *!/
    selectTag($("#select-who"),function (ret) {
        console.log(ret)
    });
*/
    /**
     * 弹窗进行售后
     * */

    /**
     * 弹窗 商品更换
     * */
    function change() {
        var index = layer.open({
            type: 1,
            shade: 0.01,
            shadeClose: true,
            skin: 'layui-layer-demo layui-layer-change', //样式类名
            area: ['720px', '528px'],
            anim: 0,
            closeBtn:0,
            title:"",
            content: $('.content-view-change'),
            btn: "",
            yes: function(){
            },
            btn2: function(){},
            success: function(layero, index){
                $(".layui-layer-change .close-win").click(function () {
                    layer.close(index);
                })
            }
        });
    }
    /**
     * 弹窗退货
     * */
    function salesReturn(skuid) {
        var selectSkuObj;
        for(var i=0;i<orderInfo.order.skuids.length;i++){
            if(orderInfo.order.skuids[i].skuid == skuid){
                selectSkuObj = orderInfo.order.skuids[i]
            }
        }
        var index = layer.open({
            type: 1,
            shade: 0.01,
            shadeClose: true,
            skin: 'layui-layer-demo layui-layer-salesReturn', //样式类名
            area: ['240px', '146px'],
            anim: 0,
            closeBtn:0,
            title:"<span style='color: rgba(221, 91, 75, 1)'>确定退货</span>",
            content: $('.content-view-salesReturn'),
            btn: ['确定','取消'],
            yes: function(index, layero){
                toShouhou(selectSkuObj,2,index)
            },
            btn2: function(){},
            success: function(layero, index){
                $('.content-view-salesReturn .content').html('确定将「'+selectSkuObj.code+'」退货？')
            }
        });
    }
    /**
     * 弹窗报损
     * */
    function breakage(skuid) {
        var selectSkuObj;
        for(var i=0;i<orderInfo.order.skuids.length;i++){
            if(orderInfo.order.skuids[i].skuid == skuid){
                selectSkuObj = orderInfo.order.skuids[i]
            }
        }
        var index = layer.open({
            type: 1,
            shade: 0.01,
            shadeClose: true,
            skin: 'layui-layer-demo layui-layer-breakage', //样式类名
            area: ['240px', '146px'],
            anim: 0,
            closeBtn:0,
            resize:false,
            title:"<span style='color: rgba(221, 91, 75, 1)'>确定报损</span>",
            content: $('.content-view-breakage'),
            btn: ['确定','取消'],
            yes: function(){
                toShouhou(selectSkuObj,3)
            },
            btn2: function(){},
            success: function(layero, index){
                $('.content-view-breakage .content').html('确定将「'+selectSkuObj.code+'」报损？')
            }
        });
    }
    /**
     * 显示表格
     * */
    function showTable(){
        $(".no-order").css("display","none");
        $(".content-inner").css("display","block");
    }
    //进行售后   type 1更换 2退货 3报修
    function toShouhou(selectSkuObj,type,index) {
        var params = {};
        params.subId = shopId;
        params.oid = orderInfo.order.id;
        params.reason = '';
        params.skuJson = [];
        var obj = {};
        obj.skuid = selectSkuObj.skuid;
        obj.num = selectSkuObj.num;
        obj.name = selectSkuObj.name;
        obj.price = selectSkuObj.price;
        obj.subtotal = selectSkuObj.subtotal;
        obj.qualityType = type;
        obj.optStatus = selectSkuObj.qualityType;
        params.skuJson.push(obj)
        params.skuJson = JSON.stringify(params.skuJson)
        quakooData.ajaxGetData(config.getUrl_afterSale_add(),params,function (data) {
            if(data.success){
                layer.msg('提交成功',{icon:1})
                layer.close(index);
            }else{
                layer.msg(data.msg,{icon:2})
            }
        })
    }
    //改变验光信息
    function changeYgSelect(className,self) {
        $("#tableContent table").hide();
        $('.'+className).show();
        $(self).addClass('active').siblings().removeClass('active');
    }
</script>
</body>
</html>