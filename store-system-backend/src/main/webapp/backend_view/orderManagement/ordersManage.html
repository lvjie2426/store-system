<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <title>订单管理</title>
    <!--Bootstrap样式引入开始-->
    <link rel="stylesheet" href="../resource/css/bootstrap.min.css">
    <link href="../resource/js/plugins/bootstarp-table/css/bootstrap-table.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../resource/js/plugins/bootstrapzTree/bootstrapStyle.css" type="text/css">
    <link rel="stylesheet" href="../resource/js/plugins/bootstrap-select/css/bootstrap-select.min.css" type="text/css">
    <link href="../resource/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">

    <!--Bootstrap样式引入结束-->
    <!--字体样式文件引用开始-->
    <link rel="stylesheet" href="../resource/fonts/iconfont.css">
    <!--字体样式文件引用结束-->
    <!--标签样式重置开始-->
    <link rel="stylesheet" href="../resource/css/reset.css">
    <!--标签样式重置结束-->
    <!--公用组件样式-->
    <link rel="stylesheet" href="../resource/css/common.css">
    <!--公用组件样式结束-->
    <!--单页样式-->
    <link rel="stylesheet" href="../resource/css/yanjing/ordersManage.css">
    <!--单页样式结束-->

</head>
<body class="body-bg">
<div class="header clear">
    <ul class="tab-ul clear">
        <li class="active">全部订单</li>
        <li>未完成订单</li>
        <li>作废订单</li>
    </ul>

    <ol class="clear">
        <li class="right-info active">
            <div class="selectBox" id="selectCustomer">
                <div class="select-box-header">
                    <span class="text">顾客名称</span><i class="iconfont icon-ico_arrow_down"></i>
                </div>
                <div class="optionBox">
                    <ul class="optionUL">
                        <li value="1">顾客名称</li>
                    </ul>
                </div>
            </div>
            <input type="search" class="search-box" placeholder="搜索顾客名称" id="searchInput" onblur="searchName(this)">
            <div class="btn btn-info" onclick="searchName()">查询</div>
        </li>
    </ol>
</div>
<div id="second-bar">
    <ul class="filter-list clear">
        <li class="filter-item">
            <div class="yj-demo-time">
                <div class="yj-date">
                    <span>开始时间-结束时间</span><i class="iconfont icon-ico_calendar"></i>
                </div>
            </div>
        </li>
        <li class="filter-item">
            <div class="selectBox" id="selectAllSalesStaff">
                <div class="select-box-header">
                    <span class="text">全部销售员</span><i class="iconfont icon-ico_arrow_down"></i>
                </div>
                <div class="optionBox">
                    <ul class="optionUL" id="salespersonBox">

                    </ul>
                </div>
            </div>
        </li>
        <li class="filter-item">
            <div class="selectBox" id="selectAllState">
                <div class="select-box-header">
                    <span class="text">全部状态</span>
                    <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                </div>
                <div class="optionBox">
                    <ul class="optionUL">
                        <li value="0">全部状态</li>
                        <li value="1">未加工</li>
                        <li value="2">欠款</li>
                        <li value="3">未取货</li>
                        <li value="4">已完成</li>
                        <li value="5">已作废</li>
                    </ul>
                </div>
            </div>
        </li>
    </ul>
</div>
<div class="content">
    <table id="dxqf-table" data-toggle="table" class="table table-border"></table>
</div>
<div class="content-view"></div>
<!-- 固定底部 -->
<div class="winFooterBox">
    <span id="numLen"> 选中0项</span>
    <button class="btnSubmission">完成取货并结算</button>
    <button class="btnPreservation">取消选中</button>
</div>
<!--全局JS引用-->
<script src="../resource/js/jquery.min.js"></script>
<script src="../resource/js/bootstrap.js?v=3.3.6"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table.js"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table-zh-CN.min.js"></script>
<script src="../resource/js/plugins/layer/layer.js"></script>
<script src="../resource/js/mobiscroll.2.13.2.js"></script>
<!--//日期范围插件开始-->
<script src="../resource/js/yanjing/daterange.js"></script>
<!--//日期范围插件结束-->
<script src="../resource/js/lib/quakooLib/QuakooBase-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooConfig-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooBasePc-1.0.0.js"></script>
<script src="../resource/js/lib/quakoo/Config.js"></script>
<script src="../resource/js/lib/quakoo/project.js"></script>
<script src="../resource/common/common.js?" +Math.random()></script>
<script src="../resource/js/template-native.js"></script>
<script src="../resource/js/yanjing.js"></script>
<script src="../resource/js/yanjing/daterange.js"></script>
<!--顾客下拉框-->
<script type="text/html" id="nameList">
    <li value="0">全部</li>
    <%for (var i = 0; i < list.length; i++){%>
    <li value="<%=list[i].id%>"><%=list[i].name%></li>
    <%}%>
</script>
<!--销售员下拉框-->
<script type="text/html" id="salespersonList">
    <li value="0">全部</li>
    <%for (var i = 0; i < list.length; i++){%>
    <li value="<%=list[i].id%>"><%=list[i].name%></li>
    <%}%>
</script>

<script>
    var ordersType = 0;//订单状态
    var subid;//门店id
    var timeStart;//开始时间
    var timeEnd;//结束时间
    var makeStatusType = 0;//订单状态
    var personnelId;//销售员id
    var customerId;//顾客id
    var customerName;//顾客姓名
    //初始化页面
    $(function () {
        initPage();
        selectTag($("#selectCustomer"),function (ret) {

        })
    });

    //初始化函数
    function initPage() {
        subid = quakooDb.getItem("sel_ShopId");//门店ID
        ajaxTemplate(config.getUrl_order_getAllOrder());
        ajaxSalespersonList();
    }

    //获取全部销售员
    function ajaxSalespersonList() {
        quakooData.ajaxGetData(config.getUrl_user_getUsersByJob(), {job: '销售员', userType: 1}, function (ret) {
            if (ret && ret.success) {
                document.getElementById('salespersonBox').innerHTML = template('salespersonList', {list: ret.data})
                //根据下拉框销售员id获取数据
                selectTag($("#selectAllSalesStaff"), function (ret) {
                    personnelId = parseFloat(ret.value);
                    ajaxIsRen();
                });
            }
        })
    }


    // 时间插件JS开始
    $(function () {
        var curr = new Date().getFullYear();
        var opt = {};
        opt.date = {preset: 'date'};
        opt.datetime = {preset: 'datetime'};
        opt.time = {preset: 'time'};

        opt.default = {
            theme: 'mbsc-android-holo', //皮肤样式
            display: 'bubble', //显示方式
            mode: 'scroller', //日期选择模式
            dateFormat: 'yyyy-mm-dd',
            lang: 'zh',
            showNow: true,
            nowText: "今天",
            typeNum: 'day',//day：获取到日，time：获取到时，branch：获取到分；默认是获取到分
        };
        $('.settings').bind('change', function () {
            var demo = 'datetime';
            if (!demo.match(/select/i)) {
                $('.demo-test-' + demo).val('');
            }
            $('.demo-test-' + demo).scroller('destroy').scroller($.extend(opt['datetime'], opt['default']));
            $('.demo').hide();
            $('.demo-' + demo).show();
        });
        $('#demo').trigger('change');
        return curr;
    });
    // 时间插件JS结束

    //日期范围插件开始
    var date1 = new dateRange(".yj-demo-time");
    date1.init();
    //日期范围插件结束
    //根据时间查找数据


    function ajaxTemplate(url) {
        $("#dxqf-table").bootstrapTable('destroy');
        $("#dxqf-table").bootstrapTable({
            url: url,
            method: 'get',
            classes: "table",
            pagination: true,            //是否显示分页
            pageNumber: 1,               //初始化加载第一页，默认第一页
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageSize: 5,
            pageList: [5, 10, 15, 20],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            columns: [
                {checkbox: true, valign: "middle"},
                {field: "orderNo", title: "订单号", align: "left", valign: "middle"},
                {
                    field: "ctime",
                    title: "时间",
                    align: "left",
                    valign: "middle",
                    formatter: function (val, obj, index) {
                        return quakooUtils.formatTimeToDay(val);
                    }
                },
                {field: "uname", title: "顾客姓名", align: "left", valign: "middle"},
                {field: "uphone", title: "手机号", align: "left", valign: "middle"},
                {field: "totalPrice", title: "原价", align: "left", valign: "middle"},
                {field: "price", title: "成交金额", align: "left", valign: "middle"},
                {field: "descSubtract", title: "折扣", align: "left", valign: "middle"},
                {field: "personnelName", title: "销售员", align: "left", valign: "middle"},
                {
                    field: "makeStatus",
                    title: "订单状态",
                    align: "center",
                    valign: "middle",
                    formatter: function (value, row, index) {
                        var html = '';
                        if (value) {
                            if (value == 1) html = '<div class="btn-status btn-red">未加工</div>';
                            if (value == 2) html = '<div class="btn-status btn-blue">欠￥ 0</div>';
                            if (value == 3) html = '<div class="btn-status btn-yellow">未取货</div>';
                            if (value == 4) html = '<div class="btn-status btn-grays">已完成</div>';
                            if (value == 5) html = '<div class="btn-status btn-black">已作废</div>';
                            if (value == 6) html = '<div class="btn-status btn-green">临时订单</div>';
                        }
                        return html;
                    }
                },
                {
                    field: "", title: "操作", align: "center", valign: "middle", formatter: function (value, row, index) {
                        return '<button class="btn btn-primary">查看</button>';
                    }
                }
            ],
            queryParams: function (param) {
                timeStart = date1.getTime()[2] || '';      //开始时间
                timeEnd = date1.getTime()[3] || '';          //结束时间
                if (timeStart != '') param.startTime = timeStart;
                if (timeEnd != '') param.endTime = timeEnd;
                if (makeStatusType) param.makeStatus = makeStatusType;
                if (customerName && customerName != '') param.name = customerName;
                if (customerId && customerId != '') param.uid = customerId;
                if (personnelId && personnelId != '') param.personnelid = personnelId;
                param.subid = subid;
                param.page = param.offset / param.limit + 1;
                param.size = param.limit;
                param.token = quakooUser.getUserInfo().token;
                return param
            },
            onPostBody: function (data) {
            },
            onCheckAll: function (data) {
                var len = data.length;
                $("#numLen").html('选中' + len + '项');
            },
            onUncheckAll: function () {
                $("#numLen").text('选中' + 0 + '项')
            },
            onCheck: function () {
                var len = $('#dxqf-table').find('tr.selected').length;
                $("#numLen").text('选中' + len + '项')
            },
            onUncheck: function () {
                var len = $('#dxqf-table').find('tr.selected').length;
                $("#numLen").text('选中' + len + '项')
            }
        });
    }

    /**
     * tab切换
     * */
    $(".tab-ul li").click(function () {
        $(this).addClass('active').siblings().removeClass('active');
        $('#selectAllState').show();
        ordersType = $(this).index();
        if (ordersType == 0) makeStatusType = 0;
        if (ordersType == 1) makeStatusType = 0;
        if (ordersType == 2) {
            makeStatusType = 5;
            $('#selectAllState').hide();
        }
        ajaxIsRen();
    });


    function searchName() {
        customerName = $('#searchInput').val();
        ajaxIsRen();
    }

    //请求判断全部||未完成||作废
    function ajaxIsRen() {
        if (ordersType == 0) ajaxTemplate(config.getUrl_order_getAllOrder());
        if (ordersType == 1) ajaxTemplate(config.getUrl_order_getIncomplete());
        if (ordersType == 2) ajaxTemplate(config.getUrl_order_getAllOrder());
    }


    /**
     * 全部状态下拉框
     * */
    selectTag($("#selectAllState"), function (ret) {
        makeStatusType = parseFloat(ret.value)//1未加工2欠款3未取货4已完成5已作废
        console.log(makeStatusType);
        ajaxIsRen();
    });

</script>
</body>
</html>