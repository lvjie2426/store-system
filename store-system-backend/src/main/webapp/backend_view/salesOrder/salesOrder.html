<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <title>销售开单-主页</title>
    <!-- bootstrap样式开始 -->
    <link href="../resource/css/bootstrap.min.css" rel="stylesheet">
    <link href="../resource/js/plugins/bootstarp-table/css/bootstrap-table.min.css" rel="stylesheet">
    <link href="../resource/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">
    <!-- bootstrap样式结束 -->
    <!--时间插件引用的css-->
    <link href="../resource/css/yanjing/mobiscroll.2.13.2.css" rel="stylesheet">
    <link href="../resource/css/yanjing/myDate.css" rel="stylesheet">
    <!--时间插件引用的css结束-->
    <!-- layui样式 -->
    <link rel="stylesheet" href="../resource/layui/css/layui.css">
    <!-- 字体图标 -->
    <link rel="stylesheet" href="../resource/fonts/iconfont.css">
    <!-- 清除默认样式 -->
    <link rel="stylesheet" href="../resource/css/style.css">
    <link rel="stylesheet" href="../resource/css/reset.css">
    <!-- 公共样式 -->
    <link href="../resource/css/common.css" rel="stylesheet">
    <!-- 当前页面样式 -->
    <link rel="stylesheet" href="../resource/css/yanjing/salesOrder.css">
    <style>

        .dwhl:nth-child(2) {
            display: none;
        }

        .show {
            display: block !important;
        }

        .dw-bubble-bottom,
        .dw-bubble-top {
            border-right: 1px solid #e2e2e2;
            margin-left: -45px;
            box-shadow: 1px 3px 10px #e2e2e2;
        }

        .dw-bubble-top {
            margin-top: 255px !important;
        }

        .dwbw.dwb-n {
            display: none;
        }
        .orderProvisional .select-box-header span {
            max-width: 94%;
        }
    </style>
</head>

<body>
<!-- 当前页面头部 -->
<div class="headerBox clearfix">
    <i class="ruku" style=""></i>
    <h3>销售开单</h3>
    <span class="text">*为选填信息</span>
    <div class="rightBox">
        <div class="orderProvisional">
            <div class="selectBox" id="selectBox">
                <div class="select-box-header">
                    <span class="text">临时订单</span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                </div>
                <div class="optionBox">
                    <ul class="optionUL" id="proOrderList">
                    </ul>
                </div>
            </div>
        </div>
        <button class="btn intention" onclick="activeCus()">意向顾客</button>
    </div>
</div>
<!-- 页面内容外层盒子 -->
<div class="main">
    <!-- 顾客信息 -->
    <div class="mainCustomerInfo" id="mainCustomerInfo">
        <div class="titleBox clearfix">
            <h4>顾客信息</h4>
            <div class="telephoneNumBox">
                <div class="searchTypeBox">
                    <div class="selectBox" id="searchTypeBox">
                        <div class="select-box-header">
                            <span class="text">手机号</span> <i class="iconfont icon-ico_arrow_down"></i>
                        </div>
                        <div class="optionBox">
                            <ul class="optionUL" id="shopPhoneList">
                                <li value="1">手机号</li>
                                <li value="2">会员卡号</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <input id="searchPhoneUser" type="text" placeholder="搜索手机号" autocomplete="off">
                <div class="btn btn-info" style="margin-left: 10px;" onclick="searchCus()">搜索</div>
            </div>
        </div>
        <div class="contentBox" id="cusBasicUl">
        </div>
        <div class="footerBox registerNo" id="memberUl">
        </div>
    </div>
    <!-- 验光信息 -->
    <div class="optometryInfo">
        <div class="titleBox clearfix">
            <h4>验光信息</h4>
            <div class="selectBox" id="optometrySelect">
                <div class="select-box-header">
                    <span class="text">更多信息</span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                </div>
                <div class="optionBox">
                    <ul class="optionUL" id="moreYgList">
                    </ul>
                </div>
            </div>
            <div class="tagDateBox">
                <ul class="tab-ul" id="tagDataBox">
                    <li class="active">本次</li>
                </ul>
            </div>
        </div>
        <div class="contentBox clearfix">
            <div class="leftBox">
                <h4>验光师</h4>
                <div class="dateNameInfo">
                    <div class="selectBox" id="optometristName">
                        <div class="select-box-header">
                            <span class="text"></span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                        </div>
                        <div class="optionBox">
                            <ul class="optionUL" id="optometristList">
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="dateBox">
                    <div class="settings2" style="display:none;">
                        <select name="demo" id="demo2">
                            <option value="date">日期</option>
                        </select>
                    </div>
                    <input name="test" id="tests2"
                           class="demo-test-date demo-test-datetime demo-test-time demo-test-credit" placeholder="验光时间"
                           data-type='time'/>
                </div>
                <h4 class="mt15">验光备注</h4>
                <textarea name="备注" id="optometryRemarks" cols="30" rows="10"
                          style="resize:none"></textarea>
            </div>
            <div class="rightBox">
                <div class="tagBox">
                    <ul class="tab-ul" id="ygType">
                        <li class="active">远用</li>
                        <li>隐形</li>
                        <li>近用</li>
                        <li>渐进多焦点</li>
                    </ul>
                    <div class="btnBox">
                        <button class="btnEmpty" type="button" onclick="clearYgInfo()">清空</button>
                        <button class="btnPreservation" type="button" onclick="saveYgInfo()">保存</button>
                    </div>
                </div>
                <div class="visionForm">
                    <div class="formLeftBorder"></div>
                    <div class="tableContent" id="tableContent">

                    </div>
                    <div class="formRightBorder"></div>
                </div>

                <div class="rightFooterBox clearfix">
                    <div class="degreesBox">
                        <div class="companyBox">
                            <input type="number" class="text" placeholder="远用瞳距" id="farDistance">
                            <span class="com.spring.Company">mm</span>
                        </div>
                        <span class="main-eye-text">主视眼:</span>
                        <div class="selectBox" id="maineye">
                            <div class="select-box-header">
                                <span class="text">左眼</span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL" style="overflow: hidden;">
                                    <li value="1">左眼</li>
                                    <li value="2">右眼</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="resultInfoBox">
                        <div class="selectBox" id="proposal">
                            <div class="select-box-header">
                                <span class="text"></span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL" id="proposalList" style="overflow: hidden;">
                                </ul>
                            </div>
                        </div>
                        <div class="selectBox" id="result">
                            <div class="select-box-header">
                                <span class="text"></span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL" style="overflow: hidden;" id="resultList">

                                </ul>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- 订单信息 -->
    <div class="orderInfo">
        <div class="titleBox clearfix">
            <h4>订单信息</h4>
            <div class="btnBox">
                <button class="btn btn-recharge" onclick="rechargeCard()">储值卡充值</button>
                <button class="btn addRoutineCommodity" onclick="addPro(0)">添加常规商品</button>
                <button class="btn addIntegralCommodity" onclick="addPro(1)">添加积分商品</button>
                <!--<button class="btn seeHistoryOrder" onclick="hisOrder()">历史订单记录</button>-->
            </div>
        </div>
        <div class="contentBox clearfix">
            <div class="leftBox">
                <div class="saleMachiningPeople">
                    <div class="saleBox">
                        <h4>销售员</h4>
                        <div class="selectBox" id="salePeople">
                            <div class="select-box-header">
                                <span class="text"></span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL" id="saleUl" style="overflow: hidden;">
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="machiningBox">
                        <h4>加工师</h4>
                        <div class="selectBox" id="machiningPeople">
                            <div class="select-box-header">
                                <span class="text"></span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL" style="overflow: hidden;" id="processUl">
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="costAdditional mt15">
                    <div class="costAdditionalSelect">
                        <h4>附加费用</h4>
                    </div>
                    <div class="selectBox" id="costAdditional">
                    </div>
                    <input type="number" class="moneyNum" id="extraCharges" placeholder="金额" readonly="readonly" >
                    <button class="addOrder" style="padding: 7px 10px;" onclick="addExtra()">添加</button>
                </div>
                <div class="promotionBox mt15">
                    <h4>促销方式</h4>
                    <div class="selectBox" id="promotion">
                        <div class="select-box-header">
                            <span class="text">促销方式</span> <i class="iconfont icon-ico_arrow_down"></i>
                        </div>
                        <div class="optionBox">
                            <ul class="optionUL" style="overflow: hidden;" id="ListPromotions">
                            </ul>
                        </div>
                    </div>
                </div>
                <h4 class="mt15">订单备注</h4>
                <textarea name="备注" id="optometryRemarks2" cols="30" rows="10" style="resize:none"></textarea>
            </div>
            <div class="rightBox" id="orderForm">
            </div>
        </div>
    </div>
</div>
<!-- 固定底部 -->
<div class="winFooterBox">
    <button class="btnSubmission" onclick="saveOrder(true)">提交订单</button>
    <button class="btnPreservation" onclick="saveOrder()">保存订单</button>
</div>


<!-- 弹窗结构 -->
<div id="printBox" style="display: none"></div>
<div id="salesOrder">
    <div id="search-customer-box">

    </div>
    <!--手机号搜索顾客-->
    <div class="customerInfo">
        <div class="addMember">
            <span>在该手机号下新增会员：</span>
            <span class="btn btn-blue" id="addCusByPhone">新增</span>
        </div>
        <div class="content">
            <table border="0" cellpadding="0" cellspacing="0" data-toggle="table"
                   class="cmMain-table4 table table-border" id="customerInfoTable"></table>
        </div>
    </div>
    <!-- 注册成为会员弹窗 -->
    <div class="register-member">
        <div class="content">
            <ul class="input-list">
                <li class="input-item">
                    <input type="number" class="member-input" placeholder="手机号" id="reg-phoneNum">
                </li>
                <li class="input-item two">
                    <input type="number" class="member-input" placeholder="输入验证码" id="reg-code">
                    <span class="send-code" id="sendSmsText" onclick="getSms()">发送短信验证码</span>
                </li>
                <!--<li class="input-item">
                        <input type="text" class="member-input" placeholder="搜索推荐人">
                    </li>-->
            </ul>
        </div>
    </div>
    <!-- 验证会员弹窗 -->
    <div class="verify">
        <div class="content">
            <ul class="input-list">
                <li class="input-item">
                    <input type="number" class="member-input" placeholder="18728389182">
                </li>
                <li class="input-item two">
                    <input type="number" class="member-input" placeholder="输入验证码">
                    <span class="send-code">发送验证码</span>
                </li>
                <li class="input-item or-item">
                    <i></i>
                    <span>或者</span>
                    <i></i>
                </li>
                <li class="input-item">
                    <input type="text" placeholder="扫描微信ID二维码" class="member-input">
                </li>
            </ul>
        </div>
    </div>
    <!-- 存储卡充值弹窗 -->
    <div class="card-pay" id="recharge">
        <div class="content">
            <ul class="input-list">
                <li class="input-item">
                    <input type="number" class="member-input" placeholder="充值金额" id="chuNum">
                </li>
<!--
                <li class="input-item">
                    <form class="layui-form cckXK">
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <input type="checkbox" value="本次活动期间，充3送1" name="like1[write]" lay-skin="primary"
                                       lay-filter="shop" title="本次活动期间，充3送1">
                                <div class="layui-unselect layui-form-checkbox" lay-skin="primary">
                                    <span>本次活动期间，充3送1</span><i class="layui-icon layui-icon-ok"></i></div>
                            </div>
                        </div>
                    </form>
                </li>
-->
            </ul>
        </div>
    </div>
    <!-- 定制商品弹窗 -->
    <div class="popupCustomized">
        <div class="tagBox">
            <ul class="tab-ul">
                <li class="active">镜片</li>
                <li>镜架</li>
                <li>隐形眼镜</li>
                <li>太阳镜</li>
            </ul>
        </div>
        <div class="popMainContent">
            <div class="content boxLens">
                <div class="mb10 brandSeries clearfix">
                    <div class="brand">
                        <h4>品牌</h4>
                        <div class="selectBox brandSelect">
                            <div class="select-box-header">
                                <span class="text">品牌</span>
                                <i class="iconfont icon-ico_arrow_down"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <li value="01">1</li>
                                    <li value="02">2</li>
                                    <li value="03">3</li>
                                    <li value="04">4</li>
                                    <li value="05">5</li>
                                </ul>
                                <div class="zi_dingyi">
                                    <span class="zdy_pingpai">自定义品牌</span>
                                    <div class="zi_dingyi_input_Box">
                                        <input type="text" placeholder="品牌" class="zi_dingyi_input">
                                        <div class="btn_conten">确定</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="series">
                        <h4>系列</h4>
                        <div class="selectBox seriesSelect">
                            <div class="select-box-header">
                                <span class="text">品牌</span> <i class="iconfont icon-ico_arrow_down"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <li value="01">1</li>
                                    <li value="02">2</li>
                                    <li value="03">3</li>
                                    <li value="04">4</li>
                                    <li value="05">5</li>
                                </ul>
                                <div class="zi_dingyi">
                                    <span class="zdy_pingpai">自定义品牌</span>
                                    <div class="zi_dingyi_input_Box">
                                        <input type="text" placeholder="品牌" class="zi_dingyi_input">
                                        <div class="btn_conten">确定</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb10 rightEyeCustomized eyeCustomized">
                    <h4>右眼定制数量</h4>
                    <div class="reNum clearfix">
                        <input type="number" class='totalPrice num' placeholder="数量">
                        <div class="reMoney">
                            <span>￥</span>
                            <input type="number" class="totalPrice numMoney" placeholder="单价">
                        </div>
                    </div>
                </div>
                <div class="mb10 leftEyeCustomized eyeCustomized">
                    <h4>左眼定制数量</h4>
                    <div class="reNum clearfix">
                        <input type="number" class='totalPrice num' placeholder="数量">
                        <div class="reMoney">
                            <span>￥</span>
                            <input type="number" class="totalPrice numMoney" placeholder="单价">
                        </div>
                    </div>
                </div>
                <div class="eyeDegrees">
                    <div class="leftDegrees">
                        <span>右</span>
                        <b>S：-3.50</b>
                    </div>
                    <div class="rightDegrees">
                        <span>左</span>
                        <b>S：-4.00</b>
                        <b>C：-0.50</b>
                    </div>
                </div>
            </div>
            <div class="content boxEyeRack ">
                <div class="mb10 brandSeries clearfix">
                    <div class="brand">
                        <h4>品牌</h4>
                        <div class="selectBox brandSelect">
                            <div class="select-box-header">
                                <span class="text">品牌</span>
                                <i class="iconfont icon-ico_arrow_down"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <li value="01">1</li>
                                    <li value="02">2</li>
                                    <li value="03">3</li>
                                    <li value="04">4</li>
                                    <li value="05">5</li>
                                </ul>
                                <div class="zi_dingyi">
                                    <span class="zdy_pingpai">自定义品牌</span>
                                    <div class="zi_dingyi_input_Box">
                                        <input type="text" placeholder="品牌" class="zi_dingyi_input">
                                        <div class="btn_conten">确定</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="series">
                        <h4>系列</h4>
                        <div class="selectBox seriesSelect">
                            <div class="select-box-header">
                                <span class="text">品牌</span> <i class="iconfont icon-ico_arrow_down"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <li value="01">1</li>
                                    <li value="02">2</li>
                                    <li value="03">3</li>
                                    <li value="04">4</li>
                                    <li value="05">5</li>
                                </ul>
                                <div class="zi_dingyi">
                                    <span class="zdy_pingpai">自定义品牌</span>
                                    <div class="zi_dingyi_input_Box">
                                        <input type="text" placeholder="品牌" class="zi_dingyi_input">
                                        <div class="btn_conten">确定</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb10 colorModel eyeCustomized clearfix">
                    <div class="model">
                        <h4>型号</h4>
                        <input type="text" placeholder="型号">
                    </div>
                    <div class="colorNum">
                        <h4>色号</h4>
                        <input type="text" placeholder="色号">
                    </div>
                </div>
                <div class="mb10 eyeCustomizedNum eyeCustomized">
                    <h4>定制数量</h4>
                    <div class="reNum clearfix">
                        <input type="number" class='totalPrice num' placeholder="数量">
                        <div class="reMoney">
                            <span>￥</span>
                            <input type="number" class="totalPrice numMoney" placeholder="单价">
                        </div>
                    </div>
                </div>
            </div>
            <div class="content boxInvisibleEye ">
                <div class="mb10 brandSeries clearfix">
                    <div class="brand">
                        <h4>品牌</h4>
                        <div class="selectBox brandSelect">
                            <div class="select-box-header">
                                <span class="text">品牌</span>
                                <i class="iconfont icon-ico_arrow_down"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <li value="01">1</li>
                                    <li value="02">2</li>
                                    <li value="03">3</li>
                                    <li value="04">4</li>
                                    <li value="05">5</li>
                                </ul>
                                <div class="zi_dingyi">
                                    <span class="zdy_pingpai">自定义品牌</span>
                                    <div class="zi_dingyi_input_Box">
                                        <input type="text" placeholder="品牌" class="zi_dingyi_input">
                                        <div class="btn_conten">确定</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="series">
                        <h4>系列</h4>
                        <div class="selectBox seriesSelect">
                            <div class="select-box-header">
                                <span class="text">品牌</span> <i class="iconfont icon-ico_arrow_down"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <li value="01">1</li>
                                    <li value="02">2</li>
                                    <li value="03">3</li>
                                    <li value="04">4</li>
                                    <li value="05">5</li>
                                </ul>
                                <div class="zi_dingyi">
                                    <span class="zdy_pingpai">自定义品牌</span>
                                    <div class="zi_dingyi_input_Box">
                                        <input type="text" placeholder="品牌" class="zi_dingyi_input">
                                        <div class="btn_conten">确定</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb10 cycle">
                    <h4>周期</h4>
                    <div class="selectBox cycleSelect">
                        <div class="select-box-header">
                            <span class="text">周期</span>
                            <i class="iconfont icon-ico_arrow_down"></i>
                        </div>
                        <div class="optionBox">
                            <ul class="optionUL">
                                <li value="01">1</li>
                                <li value="02">2</li>
                                <li value="03">3</li>
                                <li value="04">4</li>
                                <li value="05">5</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="mb10 rightEyeCustomized eyeCustomized">
                    <h4>右眼定制数量</h4>
                    <div class="reNum clearfix">
                        <input type="text" class='totalPrice num' placeholder="数量">
                        <div class="reMoney">
                            <span>￥</span>
                            <input type="text" class="totalPrice numMoney" placeholder="单价">
                        </div>
                    </div>
                </div>
                <div class="mb10 leftEyeCustomized eyeCustomized">
                    <h4>左眼定制数量</h4>
                    <div class="reNum clearfix">
                        <input type="text" class='totalPrice num' placeholder="数量">
                        <div class="reMoney">
                            <span>￥</span>
                            <input type="text" class="totalPrice numMoney" placeholder="单价">
                        </div>
                    </div>
                </div>
                <div class="eyeDegrees">
                    <div class="leftDegrees">
                        <span>右</span>
                        <b>S：-3.50</b>
                    </div>
                    <div class="rightDegrees">
                        <span>左</span>
                        <b>S：-4.00</b>
                        <b>C：-0.50</b>
                    </div>
                </div>
            </div>
            <div class="content boxSunglasses ">
                <div class="mb10 brandSeries clearfix">
                    <div class="brand">
                        <h4>品牌</h4>
                        <div class="selectBox brandSelect">
                            <div class="select-box-header">
                                <span class="text">品牌</span>
                                <i class="iconfont icon-ico_arrow_down"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <li value="01">1</li>
                                    <li value="02">2</li>
                                    <li value="03">3</li>
                                    <li value="04">4</li>
                                    <li value="05">5</li>
                                </ul>
                                <div class="zi_dingyi">
                                    <span class="zdy_pingpai">自定义品牌</span>
                                    <div class="zi_dingyi_input_Box">
                                        <input type="text" placeholder="品牌" class="zi_dingyi_input">
                                        <div class="btn_conten">确定</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="series">
                        <h4>系列</h4>
                        <div class="selectBox seriesSelect">
                            <div class="select-box-header">
                                <span class="text">品牌</span> <i class="iconfont icon-ico_arrow_down"></i>
                            </div>
                            <div class="optionBox">
                                <ul class="optionUL">
                                    <li value="01">1</li>
                                    <li value="02">2</li>
                                    <li value="03">3</li>
                                    <li value="04">4</li>
                                    <li value="05">5</li>
                                </ul>
                                <div class="zi_dingyi">
                                    <span class="zdy_pingpai">自定义品牌</span>
                                    <div class="zi_dingyi_input_Box">
                                        <input type="text" placeholder="品牌" class="zi_dingyi_input">
                                        <div class="btn_conten">确定</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb10 colorModel eyeCustomized clearfix">
                    <div class="model">
                        <h4>型号/色号</h4>
                        <input type="text" placeholder="型号">
                    </div>
                </div>
                <div class="mb10 eyeCustomizedNum eyeCustomized">
                    <h4>定制数量</h4>
                    <div class="reNum clearfix">
                        <input type="text" class='totalPrice num' placeholder="数量">
                        <div class="reMoney">
                            <span>￥</span>
                            <input type="text" class="totalPrice numMoney" placeholder="单价">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 历史消费记录弹窗 -->
    <div class="historyRecord">
        <div class="content">
            <table border="0" cellpadding="0" cellspacing="0" data-toggle="table"
                   class="cmMain-table1 table table-border" id="cmMain-table1"></table>
        </div>
    </div>
    <!-- 添加积分商品 -->
    <div class="branchCommodity">
        <div class="bcHeader clearfix">
            <h3>添加积分商品</h3>
            <input type="text" class="seachInput" placeholder="搜索商品名称">
            <div class="selectBox branchCommoditySelect">
                <div class="select-box-header">
                    <span class="text">商品名称</span>
                    <i class="iconfont icon-ico_arrow_down"></i>
                </div>
                <div class="optionBox">
                    <ul class="optionUL">
                        <li value="01">1</li>
                        <li value="02">2</li>
                        <li value="03">3</li>
                        <li value="04">4</li>
                        <li value="05">5</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="content">
            <table border="0" cellpadding="0" cellspacing="0" data-toggle="table"
                   class="cmMain-table2 table table-border"></table>
        </div>
    </div>
    <!-- 添加常规商品 （SPU） -->
    <div class="addRoutineCommodityPop">
        <div class="routineHeader clearfix">
            <h3>选择商品</h3>
            <input type="text" class="seachRoutine" placeholder="搜索系列...">
        </div>
        <div class="content">
            <div class="recommendList">
                <h4><i class="iconfont icon-ico_fire_filled"></i>日常使用TOP</h4>
                <ul class="recommendUL">
                    <!--<li><input type="button" value="明月2018新款 X2478874437" class="btn-blue"></li>
                        <li><input type="button" value="明月限量款 C24黑色" class="btn-red"></li>
                        <li><input type="button" value="暴龙复仇者联盟特…哈哈" class="btn-green"></li>
                        <li><input type="button" value="明月2018新款 C24…" class="btn-blue"></li>-->
                </ul>
            </div>
            <div class="dataListForm">
                <ul class="tab-ul" id="listClass">
                </ul>
                <div class="brandTabBox">
                    <div class="brandRightTab">
                        <ul id="listBrand">
                        </ul>
                    </div>
                    <div class="formBox">
                        <table border="0" cellpadding="0" cellspacing="0" data-toggle="table" data-height="432px"
                               class="cmMain-table3 table table-border" id="spuTable"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 添加常规商品 （SKU） -->
    <div class="addRoutineCommodityPro">
        <div class="content">
            <table border="0" cellpadding="0" cellspacing="0" data-toggle="table" data-height="432px"
                   class="cmMain-table3 table table-border" id="skuTable"></table>
        </div>
    </div>
    <!-- 意向客户 -->
    <div class="intentionalCustomer">
        <div class="content">
            <table border="0" cellpadding="0" cellspacing="0" data-toggle="table"
                   class="cmMain-table4 table table-border" id="JFProTable"></table>
        </div>
    </div>
    <!-- 付款结算横向小票 -->
    <div class="uncollectedFunds uncollectedFundsPop">
        <h3 class="title">付款结算</h3>
        <div class="ufHeader">
            <ul>
                <li>原价共计 <span>￥55</span></li>
                <li>折后金额 <span>￥47.5</span></li>
                <li>特惠减免 <span>-￥10</span></li>
                <li>实收金额 <span>￥37.5</span></li>
            </ul>
        </div>
        <div style="width: 100%;padding: 10px 16px;">
            <div class="content">
                <div class="conTitle">
                    <h4>结算清单</h4>
                    <span>未收金额：<i>￥7.5</i></span>
                </div>
                <div class="formBox">
                    <ul>
                        <li>
                            <div class="topic">支付宝</div>
                            <div class="valueBox btnBlue">
                                <span id="topicZFB">点击支付</span>
                            </div>
                        </li>
                        <li>
                            <div class="topic">微信</div>
                            <div class="valueBox btnBlue">
                                <span id="topicWX">点击支付</span>
                            </div>
                        </li>
                        <li>
                            <div class="topic">微信</div>
                            <div class="valueBox"><input type="text" placeholder="输入"></div>
                        </li>
                        <li>
                            <div class="topic">现金</div>
                            <div class="valueBox btnBlue">点击支付</div>
                        </li>
                        <li>
                            <div class="topic">银行卡</div>
                            <div class="valueBox"><input type="text" placeholder="输入"></div>
                        </li>
                        <li>
                            <div class="topic">积分</div>
                            <div class="valueBox">1800积分可用</div>
                        </li>
                        <li>
                            <div class="topic">储存卡</div>
                            <div class="valueBox">400元可用</div>
                        </li>
                        <li>
                            <div class="topic">他人储存值<span>验证</span></div>
                            <div class="valueBox">输入</div>
                        </li>
                        <li>
                            <div class="topic">礼券</div>
                            <div class="valueBox"><input type="text" placeholder="输入"></div>
                        </li>
                    </ul>
                </div>
                <div class="conTail">
                    <div class="total">￥30</div>
                    <span>总计</span>
                </div>
                <textarea class="noteNote" placeholder="小票备注"></textarea>
            </div>
        </div>
    </div>
    <!-- 订单竖向小票 -->
    <div class="wholeParagraph uncollectedFunds" id="payDiaVertical">
    </div>
    <!-- 支付/三种状态 -->
    <div class="paymentPopup">
        <div class="inputNumber ">
            <div class="speedProgress">
                <ul>
                    <li class="active">1.输入金额 <i class="iconfont icon-ico_arrow_down"></i></li>
                    <li>2.扫码支付 <i class="iconfont icon-ico_arrow_down"></i></li>
                    <li>3.完成支付</li>
                </ul>
            </div>
            <ul class="payContent">
                <li class="content-item first active">
                    <div class="inputBox">
                        <span>输入需要支付的金额</span>
                        <input type="number" placeholder="0" class="moneyNum" id="payNum">
                    </div>
                    <div class="btn-pay">
                        <button class="first-next" type="button" onclick="firstNext()">下一步</button>
                        <button class="cancel" type="button" onclick="closePay()">取消</button>
                    </div>
                </li>
                <li class="content-item second">
                    <div class="sweepCodeImg">
                        <img src="../resource//images/pay_01.jpg" alt="付款码" id="sweepCode">
                        <span>扫描顾客的付款码</span>
                        <input type="number" placeholder="或输入付款码" id="testCode">
                    </div>
                    <div class="btn-pay">
                        <button class="second-next" type="button" onclick="secondNext()">下一步</button>
                        <button class="second-pre" type="button" onclick="secondPre()">上一步</button>
                    </div>
                </li>
                <li class="content-item third">
                    <div class="successBox">
                        <img src="../resource//images/pay_02.jpg" alt="付款码" id="successImg">
                        <span>支付成功</span>
                        <span class="tuikuan" onclick="reimburse()">退款</span>
                    </div>
                    <div class="btn-pay">
                        <button class="third-end" type="button" onclick="finish()">完成</button>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <!-- 退款弹窗 -->
    <div class="content-view content-view-removeStaff" style="display:none">
        <p>确定退款20元？</p>
    </div>
    <!-- 横向小票 -->
    <div class="horizontalTicket">
        <div class="titleBox br">
            <div class="ov">
                <h2 class="fl">精益眼镜旗舰店</h2>
                <h2 class="fr">No.<i class="btnRed">0003926</i></h2>
            </div>
            <div class="huiColor">黔北大道二高西门人行岛天桥处将军大酒店附近
                <span class="ml16">0571-20193819</span>
            </div>
        </div>
        <div class="pd10 ov br">
            <div class="fl mr10">订单状态<span class="btnRed ml4">未取货</span></div>
            <div class="fl ml16">销售员<span class="huiColor ml4"></span></div>
            <div class="fr huiColor">2018年10月11日 12点</div>
        </div>
        <div class="pd10 ov br">
            <h3 class="info fl">商品信息</h3>
            <h3 class="info fr pd12">验光信息</h3>
        </div>
        <div class="infoContent ov br">
            <div class="purchaseItems fl">
                <ul class="pd10 ov br" style="min-height:137px;">
                    <li>
                        <span class="text">HYDRON 海昌透明黑色单片年抛</span>
                        <span class="num">X1</span>
                        <span class="price">￥30</span>
                    </li>
                    <li>
                        <span class="text">明月隐形眼镜1.50左眼</span>
                        <span class="num">X2</span>
                        <span class="price">￥10</span>
                    </li>
                    <li>
                        <span class="text">明月隐形眼镜1.40右眼</span>
                        <span class="num">X2</span>
                        <span class="price">￥15</span>
                    </li>
                    <li>
                        <span class="text">护眼灯</span>
                        <span class="num">X1</span>
                        <span class="price">￥0</span>
                    </li>
                    <li>
                        <span class="text">HYDRON 海昌透明黑色单片年抛</span>
                        <span class="num">X1</span>
                        <span class="price">￥0</span>
                    </li>
                    <li>
                        <span class="text">HYDRON 海昌透明黑色单片月抛</span>
                        <span class="num">X1</span>
                        <span class="price">￥0</span>
                    </li>
                </ul>
                <div class="ov pd10 br">
                    <span class="fl">金额减免</span>
                    <span class="huiColor fr"></span>
                </div>
                <div class="ov pd10" style="min-height: 60px;">
                    <div class="ov btnRed mb10">
                        <span class="fl fs14">总计</span>
                        <span class="fr" style="margin-right: 4px;">￥37.5</span>
                    </div>
                    <div class="huiColor">
                        微信支付: ￥20 现金支付: ￥10 他人储值支付: ￥7.5
                    </div>
                </div>
            </div>
            <div class="optInfo fr ov">
                <div class="item br">
                    <div class="pl12">右眼</div>
                    <div class="ml16 huiColor">
                        <span>S: -3.50</span>
                    </div>
                </div>
                <div class="item br">
                    <div class="pl12">左眼</div>
                    <div class="ml16 huiColor">
                        <span>S: -3.50</span>
                        <span>C: -0.50</span>
                        <span>A: 195</span>
                    </div>
                </div>
                <div class="item">
                    <div class="pl12">瞳距</div>
                    <div class="ml16 huiColor">
                        <span>2</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="pd10 ov br">
            小票备注
            <span class="pl12 huiColor">
                    这位顾客人很好，下次再来！这位顾客人很好，下次再来！
                </span>
        </div>
        <div class="pd10 ov">
            三包政策
            <span class="pl12 huiColor">
                    详细内容详细内容详细内容详细内容详细内容
                </span>
        </div>
    </div>
</div>

<!--全局js-->
<!-- jq库 -->
<script src="../resource/js/jquery.min.js"></script>
<!-- bootstrap UI需要依赖的js -->
<script src="../resource/js/bootstrap.js?v=3.3.6"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table.js"></script>
<script src="../resource/js/plugins/bootstarp-table/js/bootstrap-table-zh-CN.min.js"></script>
<!-- layui需要依赖的js -->
<script src="../resource/js/plugins/layer/layer.js"></script>
<script src="../resource/layui/layui.js"></script>
<!-- 公司内部库 -->
<script src="../resource/js/lib/quakooLib/QuakooBase-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooConfig-1.0.0.js"></script>
<script src="../resource/js/lib/quakooLib/QuakooBasePc-1.0.0.js"></script>
<script src="../resource/js/lib/quakoo/Config.js"></script>
<script src="../resource/js/lib/quakoo/project.js"></script>
<script src="../resource/common/common.js?" +Math.random()></script>
<script src="../resource/js/template-native.js"></script>
<!-- 全局公共js -->
<script src="../resource/js/yanjing.js"></script>
<!-- 时间插件js -->
<script src="../resource/js/mobiscroll.2.13.2.js"></script>
<!-- 当前页面逻辑 -->
<!--临时订单列表-->
<script type="text/html" id="proOrderData">
    <%for(var i=0; i < list.length;i++){%>
        <li value='<%=list[i].id%>'><%=list[i].orderNo%><i class="rem iconfont ico_circle_cross_fil">&#xe6aa;</i></li>
    <%}%>
</script>
<!--顾客手机号模糊搜索列表-->
<script type="text/html" id="cusPhone">
    <%if(list.length>0){%>
    <ul>
        <%for(var i =0;i< list.length;i++){%>
            <li onclick = 'showCus(<%=initobj(list[i])%>)' data-id="<%=list[i].phone%>"><%=list[i].phone%></li>
        <%}%>
    </ul>
    <%}%>
</script>
<!--推荐人-->
<script type="text/html" id="cusInfoReferrerTmp">
    <ul>
        <%if(list.length>0){%>
        <%for(var i =0;i< list.length;i++){%>
        <li onclick="renderReffer(this)" data-id="<%=list[i].id%>" data-tname="<%=list[i].tname%>" data-tphone="<%=list[i].tphone%>"><%=list[i].name%>·<%=list[i].phone%></li>
        <%}%>
        <%}%>
    </ul>
</script>
<!--顾客信息_基本信息-->
<script type="text/html" id="cusBasicTmp">
    <h4>基本信息</h4>
    <div class="fromInfo">
        <form class="layui-form" action="">
            <div class="search-select">
                <input value="<%=list.phone%>" type="number" placeholder="顾客手机号" id="searchCusPhone" maxlength="11" autocomplete="off">
            </div>
            <div class="layui-form-item nameInput">
                <div>
                    <input value="<%=list.name%>" type="text" name="title" autocomplete="off" placeholder="姓名" id="cusInfoName">
                </div>
            </div>
            <div class="benderBox" id="cusInfoSex">
                <%if(list.sex==2){%>
                <span data-value="1">男</span>
                <span class="active" data-value="2">女</span>
                <%}else{%>
                <span class="active" data-value="1">男</span>
                <span data-value="2">女</span>
                <%}%>
            </div>
            <div class="dateBox" style="position: relative;height: 50px;">
                <div class="setting" style="display:none;">
                    <select name="demo" id="demo">
                        <option value="date">日期</option>
                    </select>
                </div>
                <%if(list.birthdate){%>
                <input name="test" id="tests" class="demo-test-date demo-test-datetime demo-test-time demo-test-credit"
                       placeholder="<%=getDateToYMD(list.birthdate)%>" data-type="day"/>
                <%}else{%>
                <input name="test" id="tests" class="demo-test-date demo-test-datetime demo-test-time demo-test-credit"
                       placeholder="出生日期" data-type="day"/>
                <%}%>
            </div>
            <div class="layui-form-item ageNum">
                <div class="layui-input-block">
                    <input id="autoAge" type="text" value="<%=list.age%>" name="title" lay-verify="title" autocomplete="off"
                           placeholder="年龄（自动）" class="layui-input">
                </div>
            </div>
            <div class="occupationTypeBox">
                <div class="selectBox" id="occupationTypeBox">
                    <div class="select-box-header">
                        <%if(list.job){%>
                        <span class="text"><%=list.job%></span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                        <%}else{%>
                        <span class="text">职业</span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
                        <%}%>
                    </div>
                    <div class="optionBox">
                        <ul class="optionUL" id="shopOccupationList">
                            <li value="保密">保密</li>
                            <li value="学生">学生</li>
                            <li value="教师">教师</li>
                            <li value="医生">医生</li>
                            <li value="护士">护士</li>
                            <li value="个体">个体</li>
                            <li value="公务员">公务员</li>
                            <li value="其他">其他</li>
                        </ul>
                    </div>
                </div>
            </div>
            <%if(list.card){%>
            <div class="stu-card" id="studentCard">
            <%}else{%>
            <div class="stu-card" id="studentCard" style="display: none;">
            <%}%>
                <span class="text">学生卡</span>
                <div class="search-select">
                    <input value="<%=list.card%>" type="text" placeholder="学生卡" class="layer-input" id="stuCard">
                </div>
            </div>
            <div class="recommenderBox" id="cusInfoReferrer">
                <span class="tuiJianRen">推荐人</span>
                <div class="search-select">
                    <%if(list.tname&&list.tphone){%>
                    <input value="<%=list.tname%>·<%=list.tphone%>" autocomplete="off" type="text" placeholder="搜索推荐人" class="layer-input" id="searchReferrer">
                    <%}else{%>
                    <input autocomplete="off" type="text" placeholder="搜索推荐人" class="layer-input" id="searchReferrer">
                    <%}%>
                    <div class="search-content" style="display: none;height:auto" id="tuijianren">
                    </div>
                </div>
            </div>
        </form>
    </div>
</script>
<!--顾客信息_会员信息-->
<script type="text/html" id="memberTmp">
    <%if(list.cardNumber){%>
        <div class="memberInfo  noRegisterWx">
            <%if(list.weixinId){%>
            <span class="yiyanzheng">
                <h4>会员信息</h4>
                <span class="registerMember active">已验证</span>
                <span class="wxNoBind active">已绑定微信</span>
            </span>
            <%}else{%>
            <span class="weiyanzheng">
                <h4>会员信息</h4>
                <button class="btn btn-order registerMember" onclick="openVerify()">点击验证</button>
                <span class="wxNoBind">未绑定微信</span>
            </span>
            <%}%>
            <div class="textInfoBox">
                <div class="textInfo">
                    <span class="mem-tag">卡号</span>
                    <em class="member-text" id="memcard-num"><%=list.cardNumber%></em>
                </div>
                <div class="textInfo">
                    <span class="mem-tag">等级</span>
                    <em class="member-text" id="mem-grade"><%=list.member%></em>
                </div>
                <div class="textInfo">
                    <span class="mem-tag">储值金额</span>
                    <em class="member-text" id="mem-money"><%=list.money%></em>
                </div>
                <div class="textInfo">
                    <span class="mem-tag">积分</span>
                    <em class="member-text" id="mem-integral"><%=list.score%></em>
                </div>
                <div class="textInfo">
                    <span class="mem-tag">上次消费</span>
                    <em class="member-text" id="last-contime"><%=list.lastMoney%></em>
                </div>
                <div class="textInfo">
                    <span class="mem-tag">消费次数</span>
                    <em class="member-text" id="con-num"><%=list.payCount%></em>
                </div>
                <div class="textInfo">
                    <span class="mem-tag">推荐人</span>
                    <em class="mem-text" id="tname"><%=list.tname%></em> · <b id="tphone"><%=list.tphone%></b>
                </div>
            </div>
        </div>
    <%}else{%>
        <div class="memberInfo  noRegister" style="display: block;">
        <h4>会员信息</h4>
        <button class="btn btn-order registerMember noRegisterZC" onclick="regMember()">手机验证</button>
        <div style="color: #828297;margin-top: 16px;">暂无</div>
        </div>
    <%}%>
</script>
<!--验光信息表格-->
<script type="text/html" id="ygTmp">
    <%if(list.defShow){%>
    <table border="" cellpadding="1" cellspacing="0" style="width:100%;padding:5px;" class="<%=className%>">
    <%}else{%>
    <table border="" cellpadding="1" cellspacing="0" style="width:100%;padding:5px;" class="<%=className%> hide">
    <%}%>
        <thead>
        <tr>
            <th></th>
            <%for(var i=0; i < list.length;i++){%>
                <th><%=list[i].name%></th>
            <%}%>
        </tr>
        </thead>
        <tbody>
        <tr>
            <th>R</th>
            <%for(var i=0;i< list.length;i++){%>
            <td><input data-attr1="rightResItem" data-attr2="<%=list[i].value%>" type="number" placeholder="请输入">
            </td>
            <%}%>
        </tr>
        <tr>
            <th>L</th>
            <%for(var i=0;i< list.length;i++){%>
            <td><input data-attr1="leftResItem" data-attr2="<%=list[i].value%>" type="number" placeholder="请输入">
            </td>
            <%}%>
        </tr>
        </tbody>
    </table>
</script>
<!--验光记录tab-->
<script type="text/html" id="tagDateList">
    <li onclick="renderYgInfo(1,'now',this)" class="active">本次</li>
    <%for(var i=0; i < list.length;i++){%>
    <li onclick="renderYgInfo(2,'<%=list[i].optTime%>',this)"><%=list[i].showTime%><%=list[i].span%></li>
    <%}%>
</script>
<!--验光记录下拉框-->
<script type="text/html" id="ygRecord">
    <%for(var i=0;i < list.length;i++){%>
    <li onclick="renderYgInfo(2,'<%=list[i].optTime%>','select')"><%=list[i].showTime%><%=list[i].span%></li>
    <%}%>
</script>
<!--附加费用-->
<script type="text/html" id="extraTmp">
    <div class="select-box-header">
        <span class="text">附加费用</span> <i class="iconfont icon-ico_arrow_down" id="jt"></i>
    </div>
    <div class="optionBox">
        <ul class="optionUL" style="overflow: hidden;" id="listExtraCharge">
            <li value="附加费用">附加费用</li>
            <%for(var i = 0; i < list.length; i++){%>
                <li value="<%=list[i]%>"><%=list[i]%></li>
            <%}%>
        </ul>
    </div>
</script>
<!--订单信息表格-->
<script type="text/html" id="orderFormList1">
    <div class="rightFormBox">
        <table width="100%" border="1">
            <thead>
                <tr>
                    <th>商品名称</th>
                    <th>数量</th>
                    <th>零售价</th>
                    <th>会员折扣</th>
                    <th>小计</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody class="active">
            <!--type? 1=>金钱商品 1=>积分商品 3=>附加费用 4=>促销方式-->
            <%if(price){%>
            <%for(var i in list){%>
            <%if(list[i].type ==1){%>
            <%}else if(list[i].type ==2){%>
            <tr>
                <td>
                    <div><%=list[i].productName%></div>
                </td>
                <td><%=list[i].number%></td>
                <td><%=list[i].price%>积分</td>
                <%if(list[i].discount > 0 && list[i].discount<10){%>
                <td><input type="text" placeholder="<%=list[i].discount%>" value="<%=list[i].discount%>"
                           readonly="readonly"></td>
                <%}else{%>
                <td><input type="text" placeholder="10.0" value="10.0" readonly="readonly"></td>
                <%}%>
                <td><%=list[i].subtotal%>积分</td>
                <td><u onclick="delOrderItem('<%=i%>')">移除</u></td>
            </tr>
            <%}else if(list[i].type ==3){%>
            <tr class="discount">
                <td>
                    <div><%=list[i].name%></div>
                </td>
                <td>¥<%=list[i].money%></td>
                <td><u onclick="delOrderItem('<%=i%>')">移除</u></td>
            </tr>
            <%}else if(list[i].type ==4){%>
            <tr class="discount">
                <td>
                    <div><%=list[i].name%></div>
                </td>
                <td>-¥<%=list[i].money%></td>
                <td><u onclick="delOrderItem('<%=i%>')">移除</u></td>
            </tr>
            <%}%>
            <%}%>
            <%}else{%>
            <tr style="height: 100%;">
                <td class="nullInfo" style="width:100%;height: 100%; vertical-align: middle;line-height: 216px;"
                    colspan="2">暂无商品信息
                </td>
            </tr>
            <%}%>
            </tbody>
        </table>
    </div>
    <div class="rightFooterBox clearfix">
        <%if(price){%>
        <div class="amountMoney">
            <div>原价共计 <span id="totalPrice">¥<%=price.totalPriceYuan%></span></div>
            <div>折后金额 <span id="dicountPrice">¥<%=price.dicountPriceYuan%></span></div>
        </div>
        <div class="actualMoney">
            <div id="chuzhi">储值卡金额<span> <b>¥</b> <input type="text" id="chuMoney" readonly="readonly" value="<%=rechargeAmount%>"></span></div>
            <div>实收金额<span> <b>¥</b> <input type="text" id="PaidMoney" value="<%=price.dicountPriceYuan%>"></span></div>
            <div>折扣<i id="userDiscount"><%=price.userDiscount%></i></div>
        </div>
        <%}else{%>
        <div class="amountMoney">
            <div>原价共计 <span id="totalPrice">¥0</span></div>
            <div>折后金额 <span id="dicountPrice">¥0</span></div>
        </div>
        <div class="actualMoney">
            <div id="chuzhi" >储值卡金额<span> <b>¥</b> <input type="text" id="chuMoney" readonly="readonly" value="<%=rechargeAmount%>"></span></div>
            <div>实收金额<span> <b>¥</b> <input type="text" id="PaidMoney"></span></div>
            <div>折扣<i id="userDiscount">10.0</i></div>
        </div>
        <%}%>
    </div>
</script>
<script type="text/html" id="orderFormList">
    <div class="rightHeadBox clearfix">
    </div>
    <div class="rightFormBox">
        <table width="100%" border="1">
            <thead>
                <tr>
                    <th>商品名称</th>
                    <th>数量</th>
                    <th>零售价</th>
                    <th>会员折扣</th>
                    <th>小计</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody class="active">
            <%for(var i = 0;i < list.skuidsList.length;i++){%>
                <tr>
                    <td>
                        <div><%=list.skuidsList[i].code%></div>
                    </td>
                    <td class="goods-item">
                        <a class="jian" onclick="addSub(2,<%=i%>)">-</a>
                        <input class="goods-number" onchange="goodsNumChange(<%=i%>)" type="number" placeholder="数量" value="<%=list.skuidsList[i].num%>">
                        <a class="jia" onclick="addSub(1,<%=i%>)">+</a>
                    </td>
                    <td>¥<%=(list.skuidsList[i].retailPrice/100).toFixed(2)%></td>
                    <%if(list.skuidsList[i].discount > 0 && list.skuidsList[i].discount<10){%>
                    <td><input type="number" placeholder="<%=list.skuidsList[i].discount%>" value="<%=list.skuidsList[i].discount%>" class="goods-discount" onchange="goodsDiscountChange(<%=i%>)"></td>
                    <%}else{%>
                    <td><input type="number" placeholder="10.0" value="10.0" class="goods-discount" onchange="goodsDiscountChange(<%=i%>)"></td>
                    <%}%>
                    <td>¥ <%=(list.skuidsList[i].subtotal/100).toFixed(2)%></td>
                    <td><u onclick="removeItem(3,<%=i%>)">移除</u></td>
                </tr>
            <%}%>
            <%for(var i=0;i< list.valueCard.length;i++){%>
            <tr class="discount">
                <td>
                    <div><%=list.valueCard[i].name%></div>
                </td>
                <td>¥ <%=(list.valueCard[i].price/100).toFixed(2)%></td>
                <td><u onclick="removeItem(5,<%=i%>)">移除</u></td>
            </tr>
            <%}%>
            <%for(var i=0;i< list.surchargesJson.length;i++){%>
                <tr class="discount">
                    <td>
                        <div><%=list.surchargesJson[i].name%></div>
                    </td>
                    <td>¥ <%=(list.surchargesJson[i].price/100).toFixed(2)%></td>
                    <td><u onclick="removeItem(1,<%=i%>)">移除</u></td>
                </tr>
            <%}%>
            <%if(list.couponArr.length>0){%>
                <tr class="discount">
                    <td>
                        <div><%=list.couponArr[0].name%></div>
                    </td>
                    <td>¥ <%=-(list.couponArr[0].price/100).toFixed(2)%></td>
                    <td><u onclick="removeItem(2,<%=i%>)">移除</u></td>
                </tr>
            <%}%>
            <%if(list.reductionPrice>0){%>
            <tr class="discount">
                <td>
                    <div>特惠减免</div>
                </td>
                <td>¥ -<%=(list.reductionPrice/100).toFixed(2)%></td>
            </tr>
            <%}%>
            </tbody>
        </table>
    </div>
    <div class="rightFooterBox clearfix">
        <div class="amountMoney">
            <div>原价共计 <span id="totalPrice">¥ <%=(list.originalPrice/100).toFixed(2)%></span></div>
            <div>折后金额 <span id="dicountPrice">¥ <%=(list.discountPrice/100).toFixed(2)%></span></div>
        </div>
        <div class="actualMoney">
            <div>实收金额 <span> <b>¥</b> <input type="text" onchange="paidInChange()" id="PaidMoney" value="<%=(list.collectPrice/100).toFixed(2)%>"></span></div>
            <div>折扣 <input id="bossDiscount" type="number" onchange="discountChange()" value="<%=list.bossDiscount%>"></div>
        </div>
    </div>
</script>
<!--提交订单模版-->
<script type="text/html" id="payDiaVerticalList">
    <h3 class="title">付款结算</h3>
    <div class="ufHeader">
        <ul>
            <li>原价共计 <span>¥ <%=(orderInfo.originalPrice/100).toFixed(2)%></span></li>
            <li>折后金额 <span>¥ <%=(orderInfo.discountPrice/100).toFixed(2)%></span></li>
            <%if(orderInfo.reductionPrice){%>
            <li>特惠减免 <span>-¥ <%=(orderInfo.reductionPrice/100).toFixed(2)%></span></li>
            <%}else{%>
            <li>特惠减免 <span>¥ 0</span></li>
            <%}%>
            <li>实收金额 <span>¥ <%=(orderInfo.collectPrice/100).toFixed(2)%></span></li>
        </ul>
    </div>

    <div style="width: 100%;padding: 10px 16px;overflow: hidden;height: 435px;">
        <div class="content" style="width:55%;float: left;">
            <div class="conTitle">
                <h4>结算清单</h4>
                <span>未收金额：<i>¥ <%=(settlement.noPayNum/100).toFixed(2)%></i></span>
            </div>
            <div class="formBox">
                <ul>
                    <li>
                        <div class="topic">支付宝</div>
                        <%if(settlement.ali){%>
                            <div class="valueBox btnBlack">
                                <%if(settlement.ali.status==1){%>
                                    <span class="payed"><%=settlement.ali.money%></span>
                                    <span class="btnRed fr mr10" onclick="reimburse(1)" id="alirefund">退款</span>
                                <%}else if(settlement.ali.status==2){%>
                                    <span class="btnRed center-text" id="alirefunded">已退款</span>
                                <%}%>
                            </div>
                        <%}else{%>
                            <div class="valueBox btnBlue" onclick="payDialog(1)">点击支付</div>
                        <%}%>
                    </li>
                    <li>
                        <div class="topic">微信</div>
                        <%if(settlement.weixin){%>
                        <div class="valueBox btnBlack">
                            <%if(settlement.ali.status==1){%>
                                <span class="payed"><%=settlement.weixin.money%></span>
                                <span class="btnRed fr mr10" onclick="reimburse(2)">退款</span>
                            <%}else{%>
                                <span class="btnRed center-text" id="weirefunded" style="display: none;">已退款</span>
                            <%}%>
                        </div>
                        <%}else{%>
                        <div class="valueBox btnBlue" onclick="payDialog(2)">点击支付</div>
                        <%}%>
                    </li>
                    <li>
                        <div class="topic">现金</div>
                        <div class="valueBox"><input type="text" placeholder="输入" value="<%=settlement.cash%>" onchange="countOffline(this,1)"></div>
                    </li>
                    <li>
                        <div class="topic">银行卡</div>
                        <div class="valueBox"><input type="text" placeholder="输入" value="<%=settlement.bankCard%>"></div>
                    </li>
                    <li>
                        <div class="topic">积分</div>
                        <%if(settlement.integral){%>
                            <%if(settlement.integral.hasNum){%>
                                <div class="valueBox"><input type="text" placeholder="<%=settlement.integral.hasNum%>" value="<%=settlement.integral.usedNum%>"></div>
                            <%}else{%>
                                <div class="valueBox"><input type="text" placeholder="无可用积分" readonly="readonly"></div>
                            <%}%>
                        <%}else{%>
                            <div class="valueBox"><input type="text" placeholder="无可用积分" readonly="readonly"></div>
                        <%}%>
                    </li>
                    <li>
                        <div class="topic">储存卡</div>
                        <%if(settlement.valueCard){%>
                            <%if(settlement.valueCard.hasNum){%>
                                <div class="valueBox"><input type="text" placeholder="<%=settlement.valueCard.hasNum%>" value="<%=settlement.valueCard.usedNum%>"  onchange="countOffline(this,2)"></div>
                            <%}else{%>
                                <div class="valueBox"><input type="text" placeholder="无可用余额" readonly="readonly"></div>
                            <%}%>
                        <%}else{%>
                            <div class="valueBox"><input type="text" placeholder="无可用余额" readonly="readonly"></div>
                        <%}%>

                    </li>
                    <li>
                        <div class="topic">他人储存值<span onclick="alert(23)">验证</span></div>
                        <%if(settlement.otherValue){%>
                            <%if(settlement.otherValue.type==1){%>
                                <%if(settlement.otherValue.hasNum){%>
                                    <div class="valueBox"><input type="text" placeholder="<%=settlement.otherValue.hasNum%>" value="<%=settlement.otherValue.usedNum%>" onchange="countOffline(this,3)"></div>
                                <%}else{%>
                                    <div class="valueBox"><input type="text" placeholder="无可用余额" readonly="readonly"></div>
                                <%}%>
                            <%}else{%>
                                <div class="valueBox"><input type="text" placeholder="输入" readonly="readonly"></div>
                            <%}%>
                        <%}%>
                    </li>
                    <li>
                        <div class="topic">礼券</div>
                        <div class="valueBox"><input type="text" placeholder="输入??"></div>
                    </li>
                </ul>
            </div>
            <div class="conTail">
                <div class="total btnBlue">¥<%=(settlement.total/100).toFixed(2)%></div>
                <span>总计</span>
            </div>
            <textarea class="noteNote" placeholder="小票备注" id="paymentNote"><%=settlement.desc%></textarea>
        </div>
        <div class="smallTicket h" id="printTicketUl"></div>
    </div>
</script>
<!--小票模版-->
<script type="text/html" id="printTicketTmp">
    <i id="smallTicketBg"></i>
    <div class="stHeader">
        <div class="stTitle"><span></span>
                <h3><%=receipt.subName%></h3><span></span>
        </div>
        <ul>
            <li><span class="fl">下单时间</span><span class="fr"><%=getDateTimeDian(receipt.cTime)%></span></li>
            <li><span class="fl">订单号</span><span class="fr"><%=receipt.orderNo%></span></li>
            <li><span class="fl">销售员</span><span class="fr"><%=receipt.staffName%></span></li>
            <%if(receipt.status==0){%>
                <li class="btnRed"><span class="fl">订单状态</span><span class="fr" id="payStatus">未交费</span></li>
            <%}else if(receipt.status==1){%>
                <li class="btnRed"><span class="fl">订单状态</span><span class="fr" id="payStatus">已缴费</span></li>
            <%}else if(receipt.status==2){%>
                <li class="btnRed"><span class="fl">订单状态</span><span class="fr" id="payStatus">已退款</span></li>
            <%}%>
        </ul>
    </div>
    <%if(receipt.info){%>
    <div class="infoOptometry">
        <h3>验光信息</h3>
        <%if(receipt.info&&receipt.info.yuanYongRes){%>
        <div class="name">远用</div>
        <%if(receipt.info.yuanYongRes.rightResItem){%>
        <div class="eye">
            <span class="eyeText">右眼</span>
            <span class="eyeContent"><%=receipt.info.yuanYongRes.rightResItemHtml%></span>
        </div>
        <%}%>
        <%if(receipt.info.yuanYongRes.leftResItem){%>
        <div class="eye">
            <span class="eyeText">左眼</span>
            <span class="eyeContent"><%=receipt.info.yuanYongRes.leftResItemHtml%></span>
        </div>
        <%}%>
        <%}%>
        <%if(receipt.info&&receipt.info.jinYongRes){%>
        <div class="name">近用</div>
        <%if(receipt.info.jinYongRes.rightResItem){%>
        <div class="eye">
            <span class="eyeText">右眼</span>
            <span class="eyeContent"><%=receipt.info.jinYongRes.rightResItemHtml%></span>
        </div>
        <%}%>
        <%if(receipt.info.jinYongRes.leftResItem){%>
        <div class="eye">
            <span class="eyeText">左眼</span>
            <span class="eyeContent"><%=receipt.info.jinYongRes.leftResItemHtml%></span>
        </div>
        <%}%>
        <%}%>
        <%if(receipt.info&&receipt.info.yinXingRes){%>
        <div class="name">隐形</div>
        <%if(receipt.info.yinXingRes.rightResItem){%>
        <div class="eye">
            <span class="eyeText">右眼</span>
            <span class="eyeContent"><%=receipt.info.yinXingRes.rightResItemHtml%></span>
        </div>
        <%}%>
        <%if(receipt.info.yinXingRes.leftResItem){%>
        <div class="eye">
            <span class="eyeText">左眼</span>
            <span class="eyeContent"><%=receipt.info.yinXingRes.leftResItemHtml%></span>
        </div>
        <%}%>
        <%}%>
        <%if(receipt.info&&receipt.info.jianJinDuoJiaoDianRes){%>
        <div class="name">渐进多焦点</div>
        <%if(receipt.info.jianJinDuoJiaoDianRes.rightResItem){%>
        <div class="eye">
            <span class="eyeText">右眼</span>
            <span class="eyeContent"><%=receipt.info.jianJinDuoJiaoDianRes.rightResItemHtml%></span>
        </div>
        <%}%>
        <%if(receipt.info.jianJinDuoJiaoDianRes.leftResItem){%>
        <div class="eye">
            <span class="eyeText">左眼</span>
            <span class="eyeContent"><%=receipt.info.jianJinDuoJiaoDianRes.leftResItemHtml%></span>
        </div>
        <%}%>
        <%}%>
        <div class="tongju">
            <span class="eyeText">瞳距</span>
            <span class="eyeContent"><%=receipt.info.farPd%></span>
        </div>
    </div>
    <%}%>
    <div class="purchaseItems">
        <ul>
            <%for(var i = 0;i < receipt.skuids.length;i++){%>
            <li>
                <span class="text"><%=receipt.skuids[i].code%></span>
                <span class="num">X<%=receipt.skuids[i].num%></span>
                <span class="price">¥<%=receipt.skuids[i].price%></span>
            </li>
            <%}%>
        </ul>
    </div>

    <div class="reduction">
        <ul>
            <%if(receipt.surcharges&&receipt.surcharges.name){%>
            <li><span class="fl"><%=receipt.surcharges.name%></span><span class="fr">-¥<%=receipt.surcharges.price%></span>
            </li>
            <%}%>
            <%if(receipt.descSubtract){%>
            <li><span class="fl">促销减免</span><span class="fr">-¥<%=receipt.descSubtract%></span></li>
            <%}%>
        </ul>
    </div>
    <div style="width: 100%;overflow: hidden;padding: 16px 0;">
        <span class="fl btnRed" style="font-size:14px;font-weight: 600;">总计</span>
        <span class="fr btnRed" style="font-size:14px;font-weight: 600;">¥<%=receipt.price%></span>
    </div>
    <div class="payment">
        <%if(){%>
        <%}%>
        <%if(receipt.payType==1){%>
        <li>
            <span class="fl">支付宝支付</span>
            <span class="fr">¥<%=receipt.price%></span>
        </li>
        <%}else if(receipt.payType==2){%>
        <li>
            <span class="fl">微信支付</span>
            <span class="fr">¥<%=receipt.price%></span>
        </li>
        <%}%>
    </div>
    <div class="noteText">
        <h6>小票备注</h6>
        <%=list.desc%>
    </div>
    <div class="threePacks">
        <h6>三包政策</h6>
        <%=list.threePolicy%>
    </div>
    <div class="address">
        <ul>
            <li>
                <span class="fl">地址</span>
                <span class="fr "><%=list.address%></span>
            </li>
            <li>
                <span class="fl">电话</span>
                <span class="fr"><%=list.phone%></span>
            </li>
        </ul>
    </div>
</script>
<script>
    /********************************总体********************************/
    var psid;                                             //企业id
    var subid;                                            //门店id
    var provisionalOrder = {};                            //临时订单
    /********************************顾客********************************/
    var cusLocInfo = {};                                  //本地顾客信息
    var cusSeachType = 1;                                 //顾客信息选择框类型1=>手机号搜索；2=>会员卡号搜索
    var countdown = 30, isRen = true;                     //倒计时
    /********************************验光********************************/
    var ygInfo = {now: {}};                               //验光信息数据
    var ygSaveBtn = true;                                 //验光记录状态(是保存还是修改)
    var ygNowStatus = true;                               //本次验光记录状态true:保存，false:修改
    var presubTime = 'now';                               //验光信息时间下标
    var optUid = 0;                                       //验光师ID
    var mainEye = 1;                                      //主视眼
    var ygResults;                                        //验光结果
    var ygAdvise;                                         //验光建议
    var LocYgInfo = {};                                   //验光表格对象
    LocYgInfo.yuanTable = {
        class: 'yuan-table',
        data: [{name: '裸眼视力', value: 'nakedEyesight'}, {name: '球镜(S)', value: 's'}, {
            name: '柱镜(C)',
            value: 'c'
        }, {name: '轴位(A)', value: 'a'}, {name: '矫正视力', value: 'correctEyesight'}, {
            name: '瞳距(PD)',
            value: 'pd'
        }, {name: '瞳高', value: 'ph'}, {name: '棱镜(V)', value: 'v'}, {name: '基底(SC)', value: 'sc'}]
    };
    LocYgInfo.yinTable = {
        class: 'yin-table',
        data: [{name: '裸眼视力', value: 'nakedEyesight'}, {name: '球镜(S)', value: 's'}, {
            name: '柱镜(C)',
            value: 'c'
        }, {name: '轴位(A)', value: 'a'}, {name: '矫正视力', value: 'correctEyesight'}, {name: '曲率', value: 'q'}, {
            name: '直径',
            value: 'd'
        }]
    };
    LocYgInfo.jinTable = {
        class: 'jin-table',
        data: [{name: '裸眼视力', value: 'nakedEyesight'}, {name: '球镜(S)', value: 's'}, {
            name: '柱镜(C)',
            value: 'c'
        }, {name: '轴位(A)', value: 'a'}, {name: '矫正视力', value: 'correctEyesight'}, {
            name: '瞳距(PD)',
            value: 'pd'
        }, {name: '瞳高', value: 'ph'}, {name: '棱镜(V)', value: 'v'}, {name: '基底(SC)', value: 'sc'}]
    };
    LocYgInfo.jianTable = {
        class: 'jian-table',
        data: [{name: '裸眼视力', value: 'nakedEyesight'}, {name: '球镜(S)', value: 's'}, {
            name: '柱镜(C)',
            value: 'c'
        }, {name: '轴位(A)', value: 'a'}, {name: '矫正视力', value: 'correctEyesight'}, {
            name: '远瞳距',
            value: 'fpd'
        }, {name: '近瞳距', value: 'npd'}, {name: 'ADD', value: 'add'}, {name: '瞳高', value: 'ph'}]
    };
    /********************************订单********************************/
    var receiptInfo = {};                                 //订单小票信息
    var locShopCart = {};                                 //本地订单信息（购物车）
    var settlementList = {};                              //结算清单
    initOrderData();
    var realpriceChange;                                  //实收金额改变的时候反给后台的参数
    var locMember={};                                     //会员信息
    var couponData = {};                                  //订单抵用券数据
    var locOrder = {};                                    //订单的属性存储
    var userScore = 0;                                    //会员积分
    var userDiscount = 10.0;                              //会员折扣
    var locOrderData = {};                                //订单信息
    var onlinePayMoney;                                   //支付金额
    var payType;                                          //当前支付类型
    var payOrderData = {};                                //支付返回值
    var refundType;                                       //退款类型
    var printId;                                          //打印小票的ID
    var paymentNote;                                      //支付小票备注
    var printContent;                                     //打印内容
    template.helper('getDateTimeDian', function (l, formatStr) {
        if (!formatStr) {
            formatStr = 'yyyy年MM月dd日 hh点';
        }
        return new Date(l).format(formatStr);
    });
    template.helper('getDateToYMD', function (l, formatStr) {
        if (!formatStr) {
            formatStr = 'yyyy-MM-dd';
        }
        return new Date(l).format(formatStr);
    });
    template.helper('initobj',function (obj) {
        return JSON.stringify(obj)
    });
    $(function () {
        psid = quakooUser.getUserInfo().psid;             //企业ID(公司ID)
        subid = quakooDb.getItem("sel_ShopId");           //门店ID
        initPage(true);                                       //页面初始化
        getListClass();                                   //类目
        getListBrand();                                   //品牌
    });
    /**初始化页面*/
    function initPage(isfirst) {
        getTemporaryOrder(); //获取门店下临时订单
        /**************顾客****************/
        renderCusInfo();
        selectTag($("#searchTypeBox"), function (ret) {
            cusSeachType = ret.value;
            if (cusSeachType == 1) {
                $('#searchPhoneUser').attr('placeholder', '搜索手机号')
            } else if (cusSeachType == 2) {
                $('#searchPhoneUser').attr('placeholder', '搜索会员卡号')
            }
        });
        /**************验光****************/
        var time = quakooUtils.formatTimeToDate(Date.now());
        $("#tests2").val(time);
        $("#tests2").attr('placeholder',time);
        if(isfirst){
            renderYgTable(LocYgInfo.yuanTable, "#tableContent", true); //验光信息远用table
            renderYgTable(LocYgInfo.yinTable, "#tableContent");        //验光信息隐形table
            renderYgTable(LocYgInfo.jinTable, "#tableContent");        //验光信息近用table
            renderYgTable(LocYgInfo.jianTable, "#tableContent");       //验光信息渐进多焦点table
        }
        getUsersByJob("验光师", 1, 1);                              //获取门店下的验光师
        getResult();//渲染结果和建议
        getYgInfo(cusLocInfo.id);
        /**************订单****************/
        getUsersByJob("销售员", 1, 2);                         //获取门店下的销售员
        getUsersByJob("加工师", 1, 3);                         //获取门店下的加工师
        getExtraCharges();                                    //获取附加费用
        getListPromotions();                                  //获取促销方式
        renderList();
    }
    /**初始化数据*/
    function initPageData(){
        cusLocInfo = {};
        ygInfo = {now: {}};
        initOrderData();
    }

    /**初始化订单数据*/
    function initOrderData(){
        locShopCart={};
        locShopCart.skuidsList = [];
        locShopCart.surchargesJson = [];
        locShopCart.valueCard = [];
        locShopCart.couponArr = [];
        locShopCart.originalPrice = 0;
        locShopCart.discountPrice = 0;
        locShopCart.collectPrice = 0;
        locShopCart.bossDiscount = Number(10).toFixed(1);
    }

    /**接口——获取门店下的临时订单*/
    function getTemporaryOrder() {
        quakooData.ajaxGetData(config.getUrl_order_getTemporaryOrder(), {subId: subid,makeStatus:6}, function (ret) {
            if (ret && quakooUtils.isNotBlack(ret.data)) {
                document.querySelector("#selectBox .text").innerHTML = "临时订单";
                for(var i=0;i<ret.data.length;i++){
                    provisionalOrder[ret.data[i].id] = ret.data[i];
                }
                var data = {list: ret.data};
                var html = template("proOrderData", data);
                $("#proOrderList").html(html);
                selectTag($("#selectBox"), function (ret) {
                    initPageData();//初始化页面数据
                    //切换订单
                    if(quakooUtils.isNotBlack(provisionalOrder[ret.value].userInfo)){
                        for(var i in provisionalOrder[ret.value].userInfo){
                            cusLocInfo[i] = provisionalOrder[ret.value].userInfo[i];
                        }
                    }
                    if(quakooUtils.isNotBlack(provisionalOrder[ret.value].oiId)){

                    }
                    if(quakooUtils.isNotBlack(ret.value)){
                        getOrderInfoToLoc(provisionalOrder[ret.value]);
                    }
                    initPage();//根据数据初始化整个页面
                })
            } else {
                document.querySelector("#selectBox .text").innerHTML = "无临时订单";
            }
        })
    }

    /***************************************************顾客信息开始*****************************************************/
    /**渲染顾客信息*/
    function renderCusInfo(){
        var data = {list:cusLocInfo};
        console.log("顾客模版数据",data);
        var html = template("cusBasicTmp",data);
        var memHtml = template("memberTmp",data);
        $("#cusBasicUl").html(html);
        $('#memberUl').html(memHtml);
        //顾客手机号查询选择
        getCusPhone();
        //年龄计算
        $("#tests").on("change", function () {
            var brithYear = $(this).val().slice(0, 4);
            var nowYear = new Date().getFullYear();
            $("#autoAge").val(nowYear - brithYear + "岁");
        });
        //切换性别
        $('.benderBox>span').on('click', function () {
            $(this).addClass('active').siblings().removeClass('active');
        });
        //职业
        selectTag($("#occupationTypeBox"),function (ret) {
            cusLocInfo.job = ret.value;
            if(ret.value=='学生'){
                $('#studentCard')[0].style.display = "inline-block";
            }else{
                $('#studentCard')[0].style.display = "none";
            }
        });
        getReferrer();//推荐人查询
        //时间插件
        $(function () {
            var curr = new Date().getFullYear();
            var opt = {};
            opt.date = {preset: 'date'};
            opt.datetime = {preset: 'datetime'};
            opt.time = {preset: 'time'};

            opt.default = {
                theme: 'mbsc-android-holo', //皮肤样式
                display: 'bubble', //显示方式
                mode: 'scroller', //日期选择模式
                dateFormat: 'yyyy-mm-dd',
                lang: 'zh',
                showNow: true,
                nowText: "今天",
                typeNum: 'day',//day：获取到日，time：获取到时，branch：获取到分；默认是获取到分
            };
            $('.settings2').bind('change', function () {
                var demo = 'datetime';
                if (!demo.match(/select/i)) {
                    $('.demo-test-' + demo).val('');
                }
                $('.demo-test-' + demo).scroller('destroy').scroller($.extend(opt['datetime'], opt['default']));
                $('.demo').hide();
                $('.demo-' + demo).show();
            });
            $('#demo2').trigger('change');
            return curr;
        });
    }
    /**顾客信息顾客搜索*/
    function searchCus() {
        var content = $('#searchPhoneUser').val();
        if (quakooUtils.isBlack(content)) {
            layer.msg("请输入搜索内容");
            return;
        }
        var param = {};
        param.subid = subid;
        param.userType = 0;
        if (cusSeachType == 1) {
            if(!quakooUtils.isMobileNum(content)){
                layer.msg("请输入正确的手机号");
                return;
            }
            param.phone1 = content;
        } else if (cusSeachType == 2) {
            param.cardNumber = content;
        }
        /**打开顾客搜索结果的弹窗*/
        quakooData.ajaxGetData(config.getUrl_user_getSubCustomerPager(), param, function (ret) {
            if(quakooUtils.isNotBlack(ret.rows)){
                $('#searchPhoneUser').val("");
                layer.open({
                    type: 1,
                    skin: 'layui-layer-demo', //样式类名
                    area: ['720px', '625px'],
                    anim: 0,
                    closeBtn: 0,
                    title: '顾客信息',
                    shade: 0.1,
                    shadeClose: true, //开启遮罩关闭
                    scrollbar: false,
                    content: $('.customerInfo'),
                    resize: false,
                    btn: '关闭窗口',
                    move: '.layui-layer-title',
                    yes: function (index, layero) {
                        layer.close(index);
                    },
                    success: function (layero, index) {
                        var diaIndex = index;
                        var column =[
                            {field: "name", title: "姓名", align: "left", valign: "middle"},
                            {field: "sex",title: "性别",align: "left",valign: "middle",formatter: function (value, row, index) {
                                    if (value === 0) {
                                        return "-"
                                    } else if (value === 1) {
                                        return "男"
                                    } else if (value === 2) {
                                        return "女"
                                    }
                                }},
                            {field: "age", title: "年龄", align: "left", valign: "middle"},
                            {
                                field: "phone",
                                title: "手机号",
                                align: "left",
                                valign: "middle",
                                formatter: function (value, row, index) {
                                    var html = value;
                                    if (row.weixinId == null) {
                                        html = html + ' <span class="unbound">未绑定</span>';
                                    } else {
                                        html = html + ' <span class="bounding">已绑定</span>';
                                    }
                                    return html;
                                }
                            },
                            {field: "subName", title: "来源", align: "left", valign: "middle"},
                            {
                                field: "", title: "操作", align: "left", valign: "middle", formatter: function (value, row, index) {
                                    var html = "<div class='btnSeeHistory' onclick='selIntentionCus("+JSON.stringify(row)+","+diaIndex+")'>选择</div>";
                                    return html;
                                }
                            }];
                        $("#customerInfoTable").bootstrapTable('destroy');
                        $("#customerInfoTable").bootstrapTable({
                            data: ret.rows,                 //被加载的数据。
                            classes: "table",
                            sortable: false,
                            sortOrder: "asc",
                            showColumns: true,
                            strictSearch: true,
                            locale: "zh-CN",
                            paginationHAlign: "center",
                            clickToSelect: true,
                            columns: column
                        });

                    }
                });
            }else{
                cusLocInfo = {};
                renderCusInfo();
                layer.msg("未查询到顾客信息")
            }

            if (quakooUtils.isNotBlack(ret.rows[0])) {
                // showCus(ret.rows[0]);
                renderCusInfo();
            } else {
                showCus()
            }
        });
    }
    /**接口——获取意向顾客*/
    function activeCus() {
        layer.open({
            type: 1,
            skin: 'layui-layer-demo', //样式类名
            area: ['720px', '625px'],
            anim: 0,
            closeBtn: 0,
            title: '意向顾客',
            shade: 0.1,
            shadeClose: true, //开启遮罩关闭
            scrollbar: false,
            content: $('.intentionalCustomer'),
            resize: false,
            btn: '关闭窗口',
            move: '.layui-layer-title',
            yes: function (index, layero) {
                layer.close(index);
            },
            success: function (layero, index) {
                showIntention(index);
            }
        });
    }
    function showIntention(index) {
        var thisIndex = index;
        var table = $('#JFProTable');
        table.bootstrapTable('destroy');
        table.bootstrapTable({
            url: config.getUrl_user_getCustomerPager(),
            classes: "table",
            pagination: true,                    //是否显示分页
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 10,
            pageList: [5, 10, 15, 20],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            paginationLoop: false,
            columns: [{
                field: "ctime", title: "时间", align: "left", valign: "middle", formatter: function (value, row, index) {
                    var showTime = quakooUtils.formatTimeToDateDianLY(value);
                    return showTime;
                }
            },
                {field: "name", title: "姓名", align: "left", valign: "middle"},
                {
                    field: "sex",
                    title: "性别",
                    align: "left",
                    valign: "middle",
                    formatter: function (value, row, index) {
                        if (value === 0) {
                            return "-"
                        } else if (value === 1) {
                            return "男"
                        } else if (value === 2) {
                            return "女"
                        }
                    }
                },
                {field: "age", title: "年龄", align: "left", valign: "middle"},
                {
                    field: "phone",
                    title: "手机号",
                    align: "left",
                    valign: "middle",
                    formatter: function (value, row, index) {
                        var html = value;
                        if (row.weixinId == null) {
                            html = html + ' <span class="unbound">未绑定</span>';
                        } else {
                            html = html + ' <span class="bounding">已绑定</span>';
                        }
                        return html;
                    }
                },
                {field: "subName", title: "来源", align: "left", valign: "middle"},
                {
                    field: "", title: "操作", align: "left", valign: "middle", formatter: function (value, row, index) {
                        var html = "<div class='btnSeeHistory' onclick='selIntentionCus("+JSON.stringify(row)+","+thisIndex+")'>选择</div>";
                        return html;
                    }
                }],
            queryParams: function (param) {
                param.subid = quakooUser.getUserInfo().psid;
                param.userType = 0;
                param.token = quakooUser.getUserInfo().token;
                param.page = param.offset / param.limit + 1;
                param.size = param.limit;
                return param
            }
        });
    }
    function selIntentionCus(data,diaIndex) {
            initPageData();
            for(var i in data){
                cusLocInfo[i] = data[i];
            }
            initPage();
            layer.close(diaIndex);
    }
    /**注册成为会员*/
    function regMember() {
        var phone = $("#searchCusPhone").val();
        var name = $("#cusInfoName").val();
        var sex = $("#cusInfoSex span.active").attr("data-value");
        var strTime = $("#tests").val().split("-");
        var birthdate = new Date(strTime[0], strTime[1], strTime[2]).getTime();
        var age = $("#autoAge").val().slice(0,-1);
        var card = $("#stuCard").val();
        if (quakooUtils.isBlack(name)) {
            layer.msg("请输入姓名");
            return;
        }
        if (quakooUtils.isBlack(phone)) {
            layer.msg("请输入手机号");
            return;
        }
        if (!quakooUtils.isMobileNum(phone)) {
            layer.msg("请输入正确的手机号");
            return;
        }
        if (quakooUtils.isBlack(birthdate) || isNaN(birthdate)) {
            layer.msg("请选择出生日期");
            return;
        }
        if (quakooUtils.isBlack(cusLocInfo.job)) {
            layer.msg("请选择顾客职业");
            return;
        }
        if (quakooUtils.isBlack(cusLocInfo.recommender)) {
            layer.msg("请选择推荐人");
            return;
        }
        cusLocInfo.phone = phone;
        cusLocInfo.name = name;
        cusLocInfo.sex = sex;
        cusLocInfo.birthdate = birthdate;
        cusLocInfo.age = age;
        if(card){
            cusLocInfo.card = card;
        }
        /**注册会员弹窗*/
        var index = layer.open({
            type: 1,
            skin: 'layui-register-member',
            area: '240px',
            anim: 0,
            closeBtn: 0,
            title: '注册成为会员',
            shade: 0.4,
            shadeClose: true, //开启遮罩关闭
            scrollbar: false,
            content: $('.register-member'),
            btn: ['注册成为会员', '取消'],
            yes: function () {
                checkPhoneCode();
            },
            btn2: function () {
                //取消
            },
            success: function (layero, index) {
                $("#reg-phoneNum").val(cusLocInfo.phone);
            }
        });
    }

    /**根据手机号模糊查询顾客*/
    function getCusPhone() {
        $('#searchCusPhone').bind('input propertychange', function(){
            var thisPhone;
            var keyword = $(this).val();
            if(keyword.length == 11){
                thisPhone = keyword;
                if(!quakooUtils.isMobileNum(keyword)){
                    layer.msg('请输入正确的手机号');
                    return;
                }
                $(this).blur();
                quakooData.ajaxGetData(config.getUrl_user_getUserListByPhone(),{subid:subid,userType:0,phone:keyword*1},function(ret){
                    if(ret.success){
                        if(quakooUtils.isNotBlack(ret.data)){
                            thisPhone = ret.data[0].phone;
                        }else{
                            cusLocInfo = {};
                            cusLocInfo.phone = keyword;
                            renderCusInfo();
                            layer.msg("未查询到顾客信息")
                        }
                        layer.open({
                            type: 1,
                            skin: 'layui-layer-demo', //样式类名
                            area: ['720px', '625px'],
                            anim: 0,
                            closeBtn: 0,
                            title: '顾客信息',
                            shade: 0.1,
                            shadeClose: true, //开启遮罩关闭
                            scrollbar: false,
                            content: $('.customerInfo'),
                            resize: false,
                            btn: '关闭窗口',
                            move: false,
                            yes: function (index, layero) {
                                layer.close(index);
                            },
                            success: function (layero, index) {
                                var diaIndex = index;
                                var column =[
                                    {field: "ctime", title: "时间", align: "left", valign: "middle",formatter:function (value, row, index) {
                                            return quakooUtils.formatTimeToDate(value);
                                        }},
                                    {field: "name", title: "姓名", align: "left", valign: "middle"},
                                    {field: "sex",title: "性别",align: "left",valign: "middle",formatter: function (value, row, index) {
                                            if (value === 0) {
                                                return "-"
                                            } else if (value === 1) {
                                                return "男"
                                            } else if (value === 2) {
                                                return "女"
                                            }
                                        }},
                                    {field: "age", title: "年龄", align: "left", valign: "middle"},
                                    {
                                        field: "phone",
                                        title: "手机号",
                                        align: "left",
                                        valign: "middle",
                                        formatter: function (value, row, index) {
                                            var html = value;
                                            if (row.weixinId == null) {
                                                html = html + ' <span class="unbound">未绑定</span>';
                                            } else {
                                                html = html + ' <span class="bounding">已绑定</span>';
                                            }
                                            return html;
                                        }
                                    },
                                    {field: "subName", title: "来源", align: "left", valign: "middle"},
                                    {
                                        field: "", title: "操作", align: "left", valign: "middle", formatter: function (value, row, index) {
                                            var html = "<div class='btnSeeHistory' onclick='selIntentionCus("+JSON.stringify(row)+","+diaIndex+")'>选择</div>";
                                            return html;
                                        }
                                    }];
                                $("#customerInfoTable").bootstrapTable('destroy');
                                $("#customerInfoTable").bootstrapTable({
                                    data: ret.data,                 //被加载的数据。
                                    classes: "table",
                                    sortable: false,
                                    sortOrder: "asc",
                                    showColumns: true,
                                    strictSearch: true,
                                    locale: "zh-CN",
                                    paginationHAlign: "center",
                                    clickToSelect: true,
                                    columns: column
                                });
                                /**搜索内容*/
                                var searchType = 1;
                                $(".layui-layer-title").append('<div class="search-customer-box">\n' +
                                '            <div class="searchTypeBox">\n' +
                                '                <div class="selectBox" id="select-customer">\n' +
                                '                    <div class="select-box-header">\n' +
                                '                        <span class="text">手机号</span> <i class="iconfont icon-ico_arrow_down"></i>\n' +
                                '                    </div>\n' +
                                '                    <div class="optionBox">\n' +
                                '                        <ul class="optionUL" id="type-list">\n' +
                                '                            <li value="1">手机号</li>\n' +
                                '                            <li value="2">姓名</li>\n' +
                                '                        </ul>\n' +
                                '                    </div>\n' +
                                '                </div>\n' +
                                '            </div>\n' +
                                '            <input id="search-input" type="text" placeholder="搜索手机号" autocomplete="off">\n' +
                                '            <div class="btn btn-info" style="margin-left: 6px;" id="searchButton">搜索</div>\n' +
                                '        </div>');
                                selectTag($("#select-customer"), function (ret) {
                                    $("#search-input").val("");
                                    searchType = ret.value;
                                    if (searchType == 1) {
                                        $('#search-input').attr('placeholder', '搜索手机号')
                                    } else if (searchType == 2) {
                                        $('#search-input').attr('placeholder', '搜索姓名')
                                    }
                                });
                                $("#searchButton").click(function(){
                                    var searchWord = $("#search-input").val();
                                    var param = {};
                                    param.subid = subid;
                                    param.userType = 0;
                                    if(searchType == 1){
                                        if(!quakooUtils.isMobileNum(searchWord)){
                                            layer.msg("请输入正确手机号");
                                            return;
                                        }
                                        param.phone = searchWord;
                                    }else if(searchType == 2){
                                        param.name = searchWord;
                                    }
                                    quakooData.ajaxGetData(config.getUrl_user_searchUserList(),param,function(ret){
                                        console.log("马总",ret);
                                        if(ret&&ret.success){
                                            if(quakooUtils.isNotBlack(ret.data)){
                                                thisPhone = ret.data[0].phone
                                                $("#customerInfoTable").bootstrapTable('destroy');
                                                $("#customerInfoTable").bootstrapTable({
                                                    data: ret.data,                 //被加载的数据。
                                                    classes: "table",
                                                    sortable: false,
                                                    sortOrder: "asc",
                                                    showColumns: true,
                                                    strictSearch: true,
                                                    locale: "zh-CN",
                                                    paginationHAlign: "center",
                                                    clickToSelect: true,
                                                    columns: column
                                                });
                                            }
                                        }else{
                                            layer.msg(ret.data);
                                        }
                                    })
                                });
                                $("#addCusByPhone").click(function(){
                                    $("#searchCusPhone").val(thisPhone);
                                    layer.close(index);
                                    layer.msg("请填写其它信息并验证",{icon:1});
                                });
                            }
                        });
                    }else{
                        layer.msg(ret.data);
                    }
                })
            }
        });
    }

    /**获取推荐人*/
    function getReferrer() {
        $('#searchReferrer').bind('input propertychange', function(){
            var keyword = $(this).val();
            if(quakooUtils.isNotBlack(keyword)){
                quakooData.ajaxGetData(config.getUrl_user_getUserByNamePhone(),{subId:subid,search:keyword},function(ret){
                    if(ret.success){
                        if(quakooUtils.isNotBlack(ret.data)){
                            var data = {list:ret.data};
                            var html = template("cusInfoReferrerTmp",data);
                            $("#tuijianren").html(html);
                            $("#tuijianren").show();
                            $("body").click(function () {
                                $("#tuijianren")[0].style.display = "none";
                            })
                        }else{
                            $("#tuijianren").hide();
                        }
                    }
                })
            }else{
                $("#tuijianren").hide();
            }
        });
    }
    function renderReffer(self){
        var info = {};
        info.text= $(self).html();
        info.id = $(self).attr("data-id");
        info.tname = $(self).attr("data-tname");
        info.tphone = $(self).attr("data-tphone");
        $("#searchReferrer").val(info.text);
        cusLocInfo.recommender = info.id;
        cusLocInfo.tname = info.tname;
        cusLocInfo.tphone = info.tphone;
        $("#tuijianren").hide();
    }
    /**接口——获取短信验证码*/
    function getSms() {
        if (!isRen) {
            return
        }
        var phone = $("#reg-phoneNum").val();
        if (quakooUtils.isBlack(phone)) {
            layer.msg("请输入手机号！", {icon: 1});
            return
        }
        if (!quakooUtils.isMobileNum(phone)) {
            layer.msg("请输入正确的手机号！", {icon: 1});
            return
        }
        quakooData.ajaxGetData(config.getUrl_user_createAuthCodeOnReg(), {phone: phone}, function (ret) {
            if (ret) {
                countDown($('#sendSmsText'));
                layer.msg("短信已发送，请注意查收！", {icon: 1});
            }
        })
    }

    /**接口——注册成为会员*/
    function getMember() {
        var params = {};
        params.psid = psid;
        params.sid = subid;
        params.name = cusLocInfo.name;
        params.phone = cusLocInfo.phone;
        params.sex = cusLocInfo.sex;
        params.birthdate = cusLocInfo.birthdate;
        params.age = cusLocInfo.age;
        params.job = cusLocInfo.job;
        params.recommender = cusLocInfo.recommender;
        if(cusLocInfo.card){
            params.card =cusLocInfo.card;
        }
        quakooData.ajaxGetData(config.getUrl_user_becomeVip(),params, function (ret) {
            if (ret && ret.success) {
                if (ret.data) {
                    layer.msg("注册成功", {icon: 1});
                    for(var i in ret.data){
                        cusLocInfo[i] = ret.data[i];
                    }
                    renderCusInfo();
                    getYgInfo(ret.data.id);
                    setTimeout(function () {
                        $(".register-member input").val('');
                        layer.closeAll();
                    }, 500)
                }
            } else {
                layer.msg(ret.msg, {icon: 2});
            }
        })

    }

    /**回显顾客信息*/
    function showCus(data) {
        console.log("顾客信息",data);
        if (quakooUtils.isNotBlack(data)) {//渲染
            cusId = data.id;
            cusPhone = data.phone;
            userScore = data.score;
            userDiscount = data.discount;
            $('#userDiscount').html(userDiscount);
            getYgInfo(data.id);
            $('#cusInfoReferrer')[0].style.display = "inline-block";
            $('#cusInfoName').val(data.name);
            $('#cusInfoPhone').val(data.phone);
            if (data.sex == 2) {
                $('#cusInfoSex span').first().removeClass('active');
                $('#cusInfoSex span').last().addClass('active');
            } else {
                $('#cusInfoSex span').first().addClass('active');
                $('#cusInfoSex span').last().removeClass('active');
            }
            $('#tests').val(quakooUtils.formatTimeToDateDianLY(data.birthdate));
            $('#autoAge').val(data.age);
            $('#cusJob').val(data.job);
            $('#recommenderBox .text').html(data.tname);
            $('.memberInfo.noRegister')[0].style.display = "block";
            $('.memberInfo.noRegisterWx')[0].style.display = "none";
            if (quakooUtils.isNotBlack(data.member)) {//已注册
                $('#cusInfoReferrer')[0].style.display = "none";
                $('.memberInfo.noRegister')[0].style.display = "none";
                $('.memberInfo.noRegisterWx')[0].style.display = "block";
                if (data.weixinId == null) {//未绑定微信
                    $(".noRegisterWx .weiyanzheng")[0].style.display = "block";
                    $(".noRegisterWx .yiyanzheng")[0].style.display = "none";
                    $("#memcard-num").html(data.cardNumber);
                    $("#mem-grade").html(data.member);
                    $("#mem-money").html(data.money + "元");
                    $("#mem-integral").html(data.score + "分");
                    $("#last-contime").html(data.lastMoney);
                    $("#con-num").html(data.payCount + "次");
                    $("#tname").html(data.tname);
                    $("#tphone").html(data.tphone);
                } else {//已绑定微信
                    $(".noRegisterWx .weiyanzheng")[0].style.display = "none";
                    $(".noRegisterWx .yiyanzheng")[0].style.display = "block";
                }
            }
        } else {
            layer.msg("未查到该顾客!");
            $('#cusInfoName').val('');
            $('#cusInfoPhone').val('');
            $('#cusInfoSex span').first().addClass('active');
            $('#cusInfoSex span').last().removeClass('active');
            $('#tests').val('');
            $('#autoAge').val('');
            $('#occupationTypeBox .text').html('');
            $('#recommenderBox .text').html('');
            $('.memberInfo.noRegister')[0].style.display = "block";
            $('.memberInfo.noRegisterWx')[0].style.display = "none";
        }
    }

    /**接口——检查手机号验证码*/
    function checkPhoneCode() {
        var phonesms = $("#reg-phoneNum").val();
        var code = $("#reg-code").val();
        if (quakooUtils.isBlack(phonesms)) {
            layer.msg("请输入手机号！", {icon: 1});
            return
        }
        if (!quakooUtils.isMobileNum(phonesms)) {
            layer.msg("请输入正确的手机号！", {icon: 1});
            return
        }
        if (quakooUtils.isBlack(code)) {
            layer.msg("请输入验证码！", {icon: 1});
            return
        }
        quakooData.ajaxGetData(config.getUrl_user_checkCode(), {phone: phonesms, code: code}, function (ret) {
            if (ret && ret.success) {
                getMember();
            } else {
                layer.msg(ret.msg);
            }
        })
    }

    /**倒计时*/
    function countDown(ele) {
        isRen = false;
        ele.addClass('active');
        ele.text(countdown + "s");
        var timer = setInterval(function () {
            countdown = countdown - 1;
            ele.text(countdown + "s");
            if (countdown <= 0) {
                countdown = 30;
                isRen = true;
                ele.text('发送验证码');
                ele.removeClass('active');
                clearInterval(timer);
            }
        }, 1000)
    }

    /***************************************************顾客信息结束*****************************************************/

    /***************************************************验光模块开始*****************************************************/
    /**关联瞳距*/
    function relevancePd(){
        $('.yuan-table input[data-attr1="rightResItem"][data-attr2="pd"]').change(function () {
            var yuanRPd = $('.yuan-table input[data-attr1="rightResItem"][data-attr2="pd"]').val();
            var yuanLPd = $('.yuan-table input[data-attr1="leftResItem"][data-attr2="pd"]').val();
            $('#farDistance').val(yuanLPd*1+yuanRPd*1);
            $('.jin-table input[data-attr1="rightResItem"][data-attr2="pd"]').val(Number(yuanRPd));
            $('.jian-table input[data-attr1="rightResItem"][data-attr2="fpd"]').val(Number(yuanRPd));
        });
        $('.yuan-table input[data-attr1="leftResItem"][data-attr2="pd"]').change(function () {
            var yuanRPd = $('.yuan-table input[data-attr1="rightResItem"][data-attr2="pd"]').val();
            var yuanLPd = $('.yuan-table input[data-attr1="leftResItem"][data-attr2="pd"]').val();
            $('#farDistance').val(yuanLPd*1+yuanRPd*1);
            $('.jin-table input[data-attr1="leftResItem"][data-attr2="pd"]').val(Number(yuanLPd));
            $('.jian-table input[data-attr1="leftResItem"][data-attr2="fpd"]').val(Number(yuanLPd));
        });
        $('.jin-table input[data-attr1="rightResItem"][data-attr2="pd"]').change(function () {
            var yuanRPd = $('.jin-table input[data-attr1="rightResItem"][data-attr2="pd"]').val();
            var yuanLPd = $('.jin-table input[data-attr1="leftResItem"][data-attr2="pd"]').val();
            $('#farDistance').val(yuanLPd*1+yuanRPd*1);
            $('.yuan-table input[data-attr1="rightResItem"][data-attr2="pd"]').val(Number(yuanRPd));
            $('.jian-table input[data-attr1="rightResItem"][data-attr2="fpd"]').val(Number(yuanRPd));
        });
        $('.jin-table input[data-attr1="leftResItem"][data-attr2="pd"]').change(function () {
            var yuanRPd = $('.jin-table input[data-attr1="rightResItem"][data-attr2="pd"]').val();
            var yuanLPd = $('.jin-table input[data-attr1="leftResItem"][data-attr2="pd"]').val();
            $('#farDistance').val(yuanLPd*1+yuanRPd*1);
            $('.yuan-table input[data-attr1="leftResItem"][data-attr2="pd"]').val(Number(yuanLPd));
            $('.jian-table input[data-attr1="leftResItem"][data-attr2="fpd"]').val(Number(yuanLPd));
        });
        $('.jian-table input[data-attr1="rightResItem"][data-attr2="fpd"]').change(function () {
            var yuanRPd = $('.jian-table input[data-attr1="rightResItem"][data-attr2="fpd"]').val();
            var yuanLPd = $('.jian-table input[data-attr1="leftResItem"][data-attr2="fpd"]').val();
            $('#farDistance').val(yuanLPd*1+yuanRPd*1);
            $('.yuan-table input[data-attr1="rightResItem"][data-attr2="pd"]').val(Number(yuanRPd));
            $('.jin-table input[data-attr1="rightResItem"][data-attr2="pd"]').val(Number(yuanRPd));
        });
        $('.jian-table input[data-attr1="leftResItem"][data-attr2="fpd"]').change(function () {
            var yuanRPd = $('.jian-table input[data-attr1="rightResItem"][data-attr2="fpd"]').val();
            var yuanLPd = $('.jian-table input[data-attr1="leftResItem"][data-attr2="fpd"]').val();
            $('#farDistance').val(yuanLPd*1+yuanRPd*1);
            $('.yuan-table input[data-attr1="leftResItem"][data-attr2="pd"]').val(Number(yuanLPd));
            $('.jin-table input[data-attr1="leftResItem"][data-attr2="pd"]').val(Number(yuanLPd));
        });
        $('#farDistance').change(function () {
            var zongPd = $('#farDistance').val();
            var average = (Number(zongPd)/2).toFixed(0);
            $('.yuan-table input[data-attr1="rightResItem"][data-attr2="pd"]').val(average);
            $('.yuan-table input[data-attr1="leftResItem"][data-attr2="pd"]').val(average);
            $('.jin-table input[data-attr1="rightResItem"][data-attr2="pd"]').val(average);
            $('.jin-table input[data-attr1="leftResItem"][data-attr2="pd"]').val(average);
            $('.jian-table input[data-attr1="rightResItem"][data-attr2="fpd"]').val(average);
            $('.jian-table input[data-attr1="leftResItem"][data-attr2="fpd"]').val(average);
        });
    }

    /**接口——保存验光信息*/
    function saveYgInfo() {
        var param = {};
        param.pSubid = psid;
        param.subid = subid;
        if (quakooUtils.isBlack(cusLocInfo.id)) {
            layer.msg("请完善注册用户信息");
            return;
        }
        param.uid = cusLocInfo.id;
        param.optUid = optUid;
        var time = $("#tests2").val();
        var year = time.substring(0, 4);
        var month = time.substring(5, 7) - 1;
        var day = time.substring(8, 10);
        var hour = time.substring(time.length - 5, time.length - 3);
        param.optTime = new Date(year, month, day, hour).getTime();
        if (param.optTime < 0 || quakooUtils.isBlack(param.optTime)) {
            layer.msg("请选择验光时间");
            return;
        }
        param.desc = $("#optometryRemarks").val();
        if (quakooUtils.isBlack(param.desc)) {
            layer.msg("请输入验光备注");
            return;
        }
        param.farPd = $(".rightFooterBox .companyBox input.text").val();
        if (quakooUtils.isBlack(param.farPd)) {
            layer.msg("请输入远用瞳距");
            return;
        }
        param.mainEye = mainEye;
        param.res = ygResults;
        param.support = ygAdvise;
        param.yuanYongResJson = {};
        param.yinXingResJson = {};
        param.jinYongResJson = {};
        param.jianJinDuoJiaoDianResJson = {};
        param.yuanYongResJson.rightResItem = {};
        param.yuanYongResJson.leftResItem = {};
        param.yinXingResJson.rightResItem = {};
        param.yinXingResJson.leftResItem = {};
        param.jinYongResJson.rightResItem = {};
        param.jinYongResJson.leftResItem = {};
        param.jianJinDuoJiaoDianResJson.rightResItem = {};
        param.jianJinDuoJiaoDianResJson.leftResItem = {};
        $('.yuan-table input').each(function (index, item) {
            if (item.value) {
                param.yuanYongResJson[$(item).attr('data-attr1')][$(item).attr('data-attr2')] = item.value;
            }
        });
        $('.yin-table input').each(function (index, item) {
            if (item.value) {
                param.yinXingResJson[$(item).attr('data-attr1')][$(item).attr('data-attr2')] = item.value;
            }
        });
        $('.jin-table input').each(function (index, item) {
            if (item.value) {
                param.jinYongResJson[$(item).attr('data-attr1')][$(item).attr('data-attr2')] = item.value;
            }
        });
        $('.jian-table input').each(function (index, item) {
            if (item.value) {
                param.jianJinDuoJiaoDianResJson[$(item).attr('data-attr1')][$(item).attr('data-attr2')] = item.value;
            }
        });
        param.yuanYongResJson = JSON.stringify(param.yuanYongResJson);
        param.yinXingResJson = JSON.stringify(param.yinXingResJson);
        param.jinYongResJson = JSON.stringify(param.jinYongResJson);
        param.jianJinDuoJiaoDianResJson = JSON.stringify(param.jianJinDuoJiaoDianResJson);
        if (ygSaveBtn == true) {
            quakooData.ajaxGetData(config.getUrl_optometryinfo_add(), param, function (ret) {
                if (ret && ret.success) {
                    ygInfo.now = ret.data;
                    layer.msg('验光信息已保存', {icon: 1});
                    ygSaveBtn = false;
                    ygNowStatus = false;
                } else {
                    layer.msg(ret.data)
                }
            })
        } else {
            quakooData.ajaxGetData(config.getUrl_optometryinfo_update(), param, function (ret) {
                if (ret && ret.success) {
                    layer.msg("验光信息已修改", {icon: 1});
                } else {
                    layer.msg(ret.data);
                }
            })
        }
    }

    /**接口——获取验光记录*/
    function getYgInfo(cusId) {
        ygSaveBtn = true;
        ygNowStatus = true;
        clearYgInfo(true);
        var param = {};
        if (quakooUtils.isBlack(cusId)) {
            // layer.msg("请完善用户信息");
            return;
        }
        param.uid = cusId;
        quakooData.ajaxGetData(config.getUrl_optometryinfo_getList(), param, function (ret) {
            if (ret && ret.success) {
                if(quakooUtils.isNotBlack(ret.data)){
                    console.log("获取验光信息",ret.data);
                    //tab切换
                    var html = "";
                    var data = [];
                    //两条以上右侧下拉框
                    var selHtml = "";
                    var selData = [];
                    for (var i = 0; i < ret.data.length; i++) {
                        ret.data[i].showTime = quakooUtils.formatTimeToDateDianLY(ret.data[i].optTime);
                        ygInfo[ret.data[i].optTime] = ret.data[i];
                        var str = [];
                        if (quakooUtils.isNotBlack(ret.data[i].yuanYongRes) && (quakooUtils.isNotBlack(ret.data[i].yuanYongRes.leftResItem) || quakooUtils.isNotBlack(ret.data[i].yuanYongRes.rightResItem))) {
                            str.push('<span>远用</span>')
                        }
                        if (quakooUtils.isNotBlack(ret.data[i].jinYongRes) && (quakooUtils.isNotBlack(ret.data[i].jinYongRes.leftResItem) || quakooUtils.isNotBlack(ret.data[i].jinYongRes.rightResItem))) {
                            str.push('<span>近用</span>')
                        }
                        if (quakooUtils.isNotBlack(ret.data[i].yinXingRes) && (quakooUtils.isNotBlack(ret.data[i].yinXingRes.leftResItem) || quakooUtils.isNotBlack(ret.data[i].yinXingRes.rightResItem))) {
                            str.push('<span>隐形</span>')
                        }
                        if (quakooUtils.isNotBlack(ret.data[i].jianJinDuoJiaoDianRes) && (quakooUtils.isNotBlack(ret.data[i].jianJinDuoJiaoDianRes.leftResItem) || quakooUtils.isNotBlack(ret.data[i].jianJinDuoJiaoDianRes.rightResItem))) {
                            str.push('<span>渐进多焦点</span>')
                        }
                        ret.data[i].span = str.join('');
                        if (i < 2) {
                            data.push(ret.data[i]);
                        }
                        if (i >= 2) {
                            selData.push(ret.data[i]);
                        }
                    }
                    html = template("tagDateList", {list: data});
                    $("#tagDataBox").html(html);
                    if (quakooUtils.isNotBlack(selData)) {
                        selHtml = template("ygRecord", {list: selData});
                        $("#moreYgList").html(selHtml);
                        selectTag($("#optometrySelect"),function (ret) {
                        })
                    }
                }
            }
        })
    }

    /**保存表格信息为本地对象*/
    function savaTableToObj(time) {
        ygInfo[time].optUid = optUid;
        var t = $("#tests2").val();
        if (quakooUtils.isNotBlack(t)) {
            var year = t.substring(0, 4);
            var month = t.substring(5, 7) - 1;
            var day = t.substring(8, 10);
            var hour = t.substring(t.length - 5, t.length - 3);
            ygInfo[time].optTime = new Date(year, month, day, hour).getTime();
        }
        ygInfo[time].desc = $("#optometryRemarks").val();
        ygInfo[time].farPd = $(".rightFooterBox .companyBox input.text").val();
        ygInfo[time].res = ygResults;
        ygInfo[time].support = ygAdvise;
        ygInfo[time].yuanYongRes = {};
        ygInfo[time].yinXingRes = {};
        ygInfo[time].jinYongRes = {};
        ygInfo[time].jianJinDuoJiaoDianRes = {};
        ygInfo[time].yuanYongRes.rightResItem = {};
        ygInfo[time].yuanYongRes.leftResItem = {};
        ygInfo[time].yinXingRes.rightResItem = {};
        ygInfo[time].yinXingRes.leftResItem = {};
        ygInfo[time].jinYongRes.rightResItem = {};
        ygInfo[time].jinYongRes.leftResItem = {};
        ygInfo[time].jianJinDuoJiaoDianRes.rightResItem = {};
        ygInfo[time].jianJinDuoJiaoDianRes.leftResItem = {};
        $('.yuan-table input').each(function (index, item) {
            if (item.value) {
                ygInfo[time].yuanYongRes[$(item).attr('data-attr1')][$(item).attr('data-attr2')] = item.value;
            }
        });
        $('.yin-table input').each(function (index, item) {
            if (item.value) {
                ygInfo[time].yinXingRes[$(item).attr('data-attr1')][$(item).attr('data-attr2')] = item.value;
            }
        });
        $('.jin-table input').each(function (index, item) {
            if (item.value) {
                ygInfo[time].jinYongRes[$(item).attr('data-attr1')][$(item).attr('data-attr2')] = item.value;
            }
        });
        $('.jian-table input').each(function (index, item) {
            if (item.value) {
                ygInfo[time].jianJinDuoJiaoDianRes[$(item).attr('data-attr1')][$(item).attr('data-attr2')] = item.value;
            }
        });
    }

    /**根据本地时间下标对象回显验光数据*/
    function renderYgInfo(type, time, _self) {
        savaTableToObj(presubTime); //保存上一个时间下标的数据到本地
        presubTime = time;
        if (type === 1 && ygNowStatus) {
            ygSaveBtn = true;
        }
        if (type === 2) {
            ygSaveBtn = false;
        }
        $('#tableContent input').val('');
        $(_self).addClass('active').siblings().removeClass('active');
        if (_self == "select") {
            $("#tagDataBox li").removeClass('active');
        }
        var data = ygInfo[time];
        //验光师
        if (data.optUserName) {
            $("#optometristName .text").html(data.optUserName);
        }
        //验光时间
        if (data.optTime) {
            $("#tests2").val(quakooUtils.formatTimeToDateDian(data.optTime));
        } else {
            $('#tests2').val('');
        }
        //验光备注
        if (data.desc) {
            $("#optometryRemarks").val(data.desc);
        } else {
            $('#optometryRemarks').val('');
        }
        //远用瞳距
        if (data.farPd) {
            $(".rightFooterBox .companyBox input.text").val(data.farPd);
        } else {
            $(".rightFooterBox .companyBox input.text").val('');
        }
        //结果和建议
        if (data.res) {
            $("#result .text").html(data.res);
        }
        if (data.support) {
            $("#proposal .text").html(data.support);
        }
        if (quakooUtils.isNotBlack(data.yuanYongRes)) {
            for (var i in data.yuanYongRes) {
                for (var j in data.yuanYongRes[i]) {
                    $(".yuan-table input[data-attr1=" + i + "][data-attr2=" + j + "]").val(data.yuanYongRes[i][j]);
                }
            }
        }
        if (quakooUtils.isNotBlack(data.jinYongRes)) {
            for (var i in data.jinYongRes) {
                for (var j in data.jinYongRes[i]) {
                    $(".jin-table input[data-attr1=" + i + "][data-attr2=" + j + "]").val(data.jinYongRes[i][j]);
                }
            }
        }
        if (quakooUtils.isNotBlack(data.yinXingRes)) {
            for (var i in data.yinXingRes) {
                for (var j in data.yinXingRes[i]) {
                    $(".yin-table input[data-attr1=" + i + "][data-attr2=" + j + "]").val(data.yinXingRes[i][j]);
                }
            }
        }
        if (quakooUtils.isNotBlack(data.jianJinDuoJiaoDianRes)) {
            for (var i in data.jianJinDuoJiaoDianRes) {
                for (var j in data.jianJinDuoJiaoDianRes[i]) {
                    $(".jian-table input[data-attr1=" + i + "][data-attr2=" + j + "]").val(data.jianJinDuoJiaoDianRes[i][j]);
                }
            }
        }
    }

    /**清空验光信息*/
    function clearYgInfo(type) {
        $('#tableContent input').val('');
        $('#tests2').val('');
        $('#optometryRemarks').val('');
        $(".rightFooterBox .companyBox input.text").val('');
        if (!type) {
            setTimeout(function () {
                layer.msg('验光信息已清空', {icon: 1});
            }, 100);
        }
    }

    /**渲染表格信息*/
    function renderYgTable(data, eleId, defShow) {
        data.data.defShow = defShow;
        var html = template("ygTmp", {list: data.data, className: data.class});
        var oldHtml = $(eleId).html();
        $(eleId).html(oldHtml + html);
        relevancePd()//关联瞳距
    }

    /**接口——获取用户列表(根据职位)*/
    function getUsersByJob(job, userType, index) {
        //index:1=>验光师；index:2=>销售员；index:3=>加工师
        quakooData.ajaxGetData(config.getUrl_user_getUsersByJob(), {job: job, userType: userType}, function (ret) {
            if (ret && ret.success) {
                if (index === 1) {
                    //验光师下拉框
                    if (quakooUtils.isNotBlack(ret.data)) {
                        document.querySelector("#optometristName .text").innerHTML = ret.data[0].name;
                        optUid = ret.data[0].id;
                        var html = "";
                        for (var i = 0; i < ret.data.length; i++) {
                            html += '<li value="' + ret.data[i].id + '">' + ret.data[i].name + '</li>'
                        }
                        document.querySelector("#optometristList").innerHTML = html;
                        selectTag($("#optometristName"), function (ret) {
                            optUid = ret.value;
                        })
                    } else {
                        document.querySelector("#optometristName .text").innerHTML = "验光师";
                    }
                }
                if (index === 2) {
                    //销售员下拉框
                    if (quakooUtils.isNotBlack(ret.data)) {
                        // document.querySelector("#salePeople .text").innerHTML = ret.data[0].name;
                        // locShopCart.saleUid = ret.data[0].id;
                        document.querySelector("#salePeople .text").innerHTML = "销售员";
                        var html = "";
                        for (var i = 0; i < ret.data.length; i++) {
                            html += '<li value="' + ret.data[i].id + '">' + ret.data[i].name + '</li>'
                        }
                        document.querySelector("#saleUl").innerHTML = html;
                        selectTag($("#salePeople"), function (ret) {
                            locShopCart.saleUid = ret.value;
                        })
                    } else {
                        document.querySelector("#salePeople .text").innerHTML = "销售员";
                    }
                }
                if (index === 3) {
                    //加工师下拉框
                    if (quakooUtils.isNotBlack(ret.data)) {
                        // document.querySelector("#machiningPeople .text").innerHTML = ret.data[0].name;
                        //locShopCart.machinistId = ret.data[0].id;
                        document.querySelector("#machiningPeople .text").innerHTML = "加工师";
                        var html = "";
                        for (var i = 0; i < ret.data.length; i++) {
                            html += '<li value="' + ret.data[i].id + '">' + ret.data[i].name + '</li>'
                        }
                        document.querySelector("#processUl").innerHTML = html;
                        selectTag($("#machiningPeople"), function (ret) {
                            locShopCart.machinistId = ret.value;
                        })
                    } else {
                        document.querySelector("#machiningPeople .text").innerHTML = "加工师";
                    }
                }

            }
        })
    }

    /**接口——获取验光结果建议*/
    function getResult() {
        //查结果
        quakooData.ajaxGetData(config.getUrl_optometryinfo_getResult(), {type: 1}, function (ret) {
            if (ret && ret.success) {
                if (quakooUtils.isNotBlack(ret.data)) {
                    var html = "";
                    for (var i = 0; i < ret.data.length; i++) {
                        html += '<li value="' + ret.data[i] + '">' + ret.data[i] + '</li>';
                    }
                    $("#result .text").html(ret.data[0]);
                    ygResults = ret.data[0];
                    $("#resultList").html(html);
                    selectTag($("#result"), function (ret) {
                        ygResults = ret.value;
                    });
                } else {
                    $("#result .text").html("结果");
                }
            }
        });
        //建议
        quakooData.ajaxGetData(config.getUrl_optometryinfo_getResult(), {type: 2}, function (ret) {
            if (ret && ret.success) {
                if (quakooUtils.isNotBlack(ret.data)) {
                    var html = "";
                    for (var i = 0; i < ret.data.length; i++) {
                        html += '<li value="' + ret.data[i] + '">' + ret.data[i] + '</li>';
                    }
                    $("#proposal .text").html(ret.data[0]);
                    ygAdvise = ret.data[0];
                    $("#proposalList").html(html);
                    selectTag($("#proposal"), function (ret) {
                        ygAdvise = ret.value;
                    });
                } else {
                    $("#proposal .text").html("建议");
                }
            }
        });
    }

    /**表单滚动条*/
    var type = true;
    $('#tableContent').hover(function () {
        $(this).addClass('active');
        type = false;
    }, function () {
        $(this).removeClass('active');
    });
    /**验光Tag*/
    $("#ygType li").click(function () {
        $(this).addClass('active').siblings().removeClass('active');
        $('#tableContent>table').eq($(this).index()).removeClass('hide').siblings().addClass('hide');
        if($(this).index()===1){
            $(".companyBox")[0].style.display='none';
        }else{
            $(".companyBox")[0].style.display='inline-block';
        }
    });
    mainEye = 1;
    selectTag($("#maineye"), function (ret){
        mainEye = ret.value;
    });

    /***************************************************验光模块结束*****************************************************/
    /***************************************************订单信息开始*****************************************************/
    /**加减
     * type 1(加) 2（减）
     * */
    function addSub(type,index) {
        if(type==1){
            locShopCart.skuidsList[index].num++;
        }else if(type == 2){
            if(locShopCart.skuidsList[index].num < 2){
                layer.msg("数量不能小于1");
                return;
            }else{
                locShopCart.skuidsList[index].num--;
            }
        }
        countOrder()
    }
    /**商品数量加减*/
    function goodsNumChange(index) {
        var num = $('.goods-item .goods-number').eq(index).val();
        if(num<1){
            layer.msg('非法输入');
            $('.goods-item .goods-number').eq(index).val(locShopCart.skuidsList[index].num);
        }else{
            locShopCart.skuidsList[index].num = num;
        }
        countOrder();
    }
    /**商品折扣改变*/
    function goodsDiscountChange(index){
        var discount = $(".goods-discount").eq(index).val();
        if(0<discount<=10){
            locShopCart.skuidsList[index].discount = discount;
        }else{
            layer.msg("非法输入");
            $(".goods-item .goods-discount").eq(index).val(locShopCart.skuidsList[index].discount);
        }
        countOrder();
    }
    /**最终折扣编辑*/
    function discountChange() {
        var discount = $("#bossDiscount").val()*1;
        if(discount > 0 && discount <= 10){
            locShopCart.bossDiscount = discount.toFixed(1);
            for(var i=0;i<locShopCart.skuidsList.length;i++){
                locShopCart.skuidsList[i].discount = discount;
            }
            countOrder()
        }else{
            layer.msg("非法输入");
            $("#bossDiscount").val(locShopCart.bossDiscount);
        }
    }
    /**获取附加费用*/
    function getExtraCharges(){
        quakooData.ajaxGetData(config.getUrl_order_getSurcharge(),{},function(ret){
            var data = {list:ret.data};
            var html = template("extraTmp",data);
            $("#costAdditional").html(html);
            selectTag($("#costAdditional"), function (ret) {
                // $('#costAdditional .text').html(ret.value);
                $("#extraCharges").attr("readonly","readonly").removeClass("active");
                if(ret.value!=="附加费用"){
                    $("#extraCharges").attr("readonly",false).addClass("active");
                }
            });
        })
    }
    /**添加附加费*/
    function addExtra() {
        var $extra = $("#extraCharges");
        if($extra.attr("readonly")){
            layer.msg("请选择附加费用类型");
            return;
        }
        if (quakooUtils.isBlack($extra.val())) {
            layer.msg("请填写价格");
            return;
        }
        var obj = {};
        obj.name = $('#costAdditional .text').html();
        obj.price = $extra.val()*100;
        locShopCart.surchargesJson.push(obj);
        $extra.val("");
        countOrder();
    }
    /**储值卡充值*/
    function rechargeCard(){
        layer.open({
            type: 1,
            shade:0.01,
            title: '储值卡充值',
            skin:'layer-recharge',
            anim: 0,
            area: ['240px','150px'],
            closeBtn: 0,
            resize: false,
            shadeClose: true,
            content: $('#recharge'),
            btn:['充值','取消'],
            yes: function (index,layero) {
                topUp(index);//充值
            },
            btn2: function (index,layero){
            },
            success: function(layero,index){
                $("#chuNum").val("");
/*
                layui.use('form', function(){
                    var form = layui.form;
                    //监听提交
                    form.on('submit(formDemo)', function(data){
                        layer.msg(JSON.stringify(data.field));
                        return false;
                    });
                });
*/
            }

        });
        function topUp(index) {
            var $chuNum = $("#chuNum");
            var num = $chuNum.val()*100;
            if(num<=0){
                layer.msg("输入非法");
                $chuNum.val("");
                return;
            }
            if(quakooUtils.isBlack(num)){
                layer.msg("请输入充值金额");
                return;
            }
            var obj = {};
            obj.name = "储值卡";
            obj.price = num;
            locShopCart.valueCard = [];
            locShopCart.valueCard.push(obj);
            console.log(locShopCart)
            countOrder();
            layer.close(index);
        }

    }
    /**改变实收金额*/
    function paidInChange() {
        var collectPrice = $("#PaidMoney").val()*100;
        if(collectPrice<0){
            layer.msg("不能小于0");
            $("#PaidMoney").val((locShopCart.collectPrice/100).toFixed(2));
            return;
        }else if(collectPrice>locShopCart.originalPrice){
            layer.msg("实收金额不能大于原价");
            $("#PaidMoney").val((locShopCart.collectPrice/100).toFixed(2));
            return;
        }else{
            realpriceChange = collectPrice;
        }
        countOrder();
    }
    /**删除订单信息
     * type:1(附加费用)，2(促销方式),3(常规商品),4(积分商品),5(储值卡充值)
     * index 对应的list的索引
     * */
    function removeItem(type,index) {
        if(type == 1){
            locShopCart.surchargesJson.splice(index,1);
        }else if(type == 2){
            locShopCart.couponArr.splice(index,1);
        }else if(type == 3){
            locShopCart.skuidsList.splice(index,1);
        }else if(type == 4){

        }else if(type == 5){
            locShopCart.valueCard.splice(index,1);
        }
        if(quakooUtils.isBlack(locShopCart.skuidsList)&&quakooUtils.isBlack(locShopCart.valueCard)&&quakooUtils.isBlack(locShopCart.surchargesJson)){
            initOrderData();
            renderList()
        }else{
            countOrder()
        }
    }
    /**渲染表格数据*/
    function renderList(){
        console.log("本地订单数据",locShopCart);
        var data = {list:locShopCart};
        var html = template("orderFormList",data);
        $("#orderForm").html(html);
        /**折扣*/
/*
        if(quakooUtils.isNotBlack(locShopCart.skuidsList)){
            $("#bossDiscount").bind("input propertychange",function(){
                var timer = null;
                var discount = $(this).val()*1;
                if(!timer){
                    timer = setTimeout(function(){
                        if(discount > 0 && discount <= 10){
                            locShopCart.bossDiscount = discount.toFixed(1);
                            for(var i=0;i<locShopCart.skuidsList.length;i++){
                                locShopCart.skuidsList[i].discount = discount;
                            }
                            countOrder()
                        }else if(discount<0||discount>10){
                            layer.msg("非法输入");
                        }
                    },800);
                }
            })
        }else{
            $("#bossDiscount").attr("readonly","readonly")
        }
*/
        /**实收金额*/
/*
        $("#PaidMoney").bind("input propertychange",function(){
            var timer = null;
            var collectPrice = $(this).val()*100;
            if(!timer){
                timer = setTimeout(function(){
                    if(collectPrice<0){
                        layer.msg("不能小于0");
                        $("#PaidMoney").val((locShopCart.collectPrice/100).toFixed(2));
                        return;
                    }else if(collectPrice>locShopCart.originalPrice){
                        layer.msg("实收金额不能大于原价");
                        $("#PaidMoney").val((locShopCart.collectPrice/100).toFixed(2));
                        return;
                    }else{
                        realpriceChange = collectPrice;
                        countOrder();
                    }
                },1000)
            }
        })
*/
    }
    /**添加常规商品*/
    function addPro(type) {
        var index = layer.open({
            type: 1,
            skin: 'layui-layer-demo', //样式类名
            area: ['960px','400px'],
            anim: 0,
            closeBtn: 0,
            title: '',
            shade: 0.1,
            shadeClose: true, //开启遮罩关闭
            scrollbar: false,
            content: $('.addRoutineCommodityPop'),
            resize: false,
            btn: '关闭窗口',
            move: $('.addRoutineCommodityPop h3'),
            yes: function (index) {
                layer.close(index)
            },
            success: function (layero) {
                if (type == 0) {
                    $('.addRoutineCommodityPop h3').html("选择常规商品");
                } else if (type == 1) {
                    $('.addRoutineCommodityPop h3').html("选择积分商品");
                }
                locOrder.type = type;
                getSPU();                       //获取类目和品牌下的SPU
/*
                if(quakooUtils.isNotBlack(cusLocInfo.userGradeId)){
                    getMemberInfo();            //获取会员信息
                }else{
                    layer.msg("非会员无折扣");
                }
*/
            },
        });
    }
    /**获取商品SPU*/
    function getSPU() {
        $("#spuTable").bootstrapTable('destroy');
        $("#spuTable").bootstrapTable({
            url: config.getUrl_product_getSaleSPUBackPager(),
            method: 'get',
            classes: "table",
            pagination: true,                     //是否显示分页
            sidePagination: "server",             //分页方式：client客户端分页，server服务端分页（*）
            pageNumber: 1,                        //初始化加载第一页，默认第一页
            pageSize: 8,
            pageList: [5, 10, 15, 20],
            sortable: false,
            sortOrder: "asc",
            showColumns: true,
            strictSearch: true,
            locale: "zh-CN",
            paginationHAlign: "center",
            clickToSelect: true,
            columns: [
                {field: "seriesName", title: "系列", align: "left", valign: "middle"},
                {field: "canUseNum", title: "库存", align: "left", valign: "middle"},
                {field: "providerName", title: "来源", align: "left", valign: "middle"},
                {
                    field: "", title: "操作", align: "left", valign: "middle", formatter: function (value, row, index) {
                        var html;
                        if (locOrder.type == 0) {
                            html = "<div class='btnSeeHistory' onclick='getSKU(" + JSON.stringify(row.id) + "," + JSON.stringify(row.seriesName) + "," + JSON.stringify(row.categoryName) + ")'>选择</div>";
                        } else if (locOrder.type == 1) {
                            html = "<div class='btnSeeHistory' onclick='getSKU(" + JSON.stringify(row.id) + "," + JSON.stringify(row.seriesName) + "," + JSON.stringify(row.categoryName) + "," + JSON.stringify(row.integralNum) + ")'>选择</div>";
                        }
                        return html;
                    }
                },
            ],
            queryParams: function (params) {
                params.page = this.pageNumber;
                params.size = this.pageSize;
                params.token = quakooUser.getUserInfo().token;
                params.subid = subid;                                 //门店ID
                params.cid = locOrder.class;
                params.bid = locOrder.brand;
                params.type = locOrder.type;
                return params;
            },
            success: function () {
            },
            onLoadSuccess: function (data) {
            }
        });
    }
    /**获取SKU
     * spuName:系列名字
     * categoryName:类目名字
     * integralNum:编码
     * */
    function getSKU( spuid, spuName, categoryName, integralNum) {
        locOrder.series = spuName || "";
        var title = "";
        if (locOrder.type == 0) {
            title = '添加常规商品';
        } else if (locOrder.type == 1) {
            title = '添加积分商品';
        }
        var index = layer.open({
            type: 1,
            skin: 'layui-layer-demo', //样式类名
            area: '800px',
            anim: 0,
            closeBtn: 0,
            title: title,
            shade: 0.1,
            shadeClose: true, //开启遮罩关闭
            scrollbar: false,
            content: $('.addRoutineCommodityPro'),
            resize: false,
            btn: '关闭窗口',
            move: ".layui-layer-title",
            yes: function (index) {
                layer.close(index)
            },
            success: function () {
                renderSku( spuid, categoryName, integralNum);
            },
        });
    }
    /**渲染SKU*/
    function renderSku(spuid, categoryName, integralNum) {
        quakooData.ajaxGetData(config.getUrl_product_getSaleSKUAllList(), {subid: subid,spuid: spuid}, function (ret) {
            if (ret && ret.success) {
                var column;
                if (ret.data) {
                    if (locOrder.type == 0) {
                        if (categoryName === '镜片') {
                            column = [
                                {field: 'code', title: '产品编码'},
                                {
                                    field: 'properties', title: '球', formatter: function (value) {
                                        return value[15];
                                    }
                                },
                                {
                                    field: 'properties', title: '柱', formatter: function (value) {
                                        return value[16];
                                    }
                                },
                                {
                                    field: 'costPrice', title: '成本价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {
                                    field: 'retailPrice', title: '零售价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {field: 'num', title: '备货量'},
                                {
                                    field: 'canUseNum', title: '库存', formatter: function (value) {
                                        return '<span class="inventory" >' + value + '</span>';
                                    }
                                },
                                {
                                    field: '', title: '数量', formatter: function (value, row, index) {
                                        return '<input type="number" class="in-yj-input" placeholder="数量" value="1">';
                                    }
                                },
                                {
                                    field: '', title: '来源', formatter: function (value, row, index) {
                                        return '<div>本店</div>'
                                    }
                                },
                                {
                                    field: '', title: '操作', formatter: function (value, row, index) {
                                        return '<div class="btnSeeHistory" onclick=\'addConventionalProducts(' + spuid + ',' + JSON.stringify(row) + ','+index+')\'>添加</div>';
                                    }
                                }
                            ]
                        } else if (categoryName === '镜架' || categoryName === '太阳镜') {
                            column = [
                                {field: 'code', title: '产品编码'},
                                /*{field: '', title: '型号'  , formatter: function (value,row,index) {
                                            return '<input type="text" class="in-yj-input-xinghao" data-index="'+index+'" placeholder="型号">';
                                        }
                                    },
                                    {field: '', title: '色号'  , formatter: function (value,row,index) {
                                            return '<input type="text" class="in-yj-input-sehao" data-index="'+index+'" placeholder="色号">';
                                        }
                                    },*/
                                {
                                    field: 'costPrice', title: '成本价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {
                                    field: 'retailPrice', title: '零售价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {field: 'num', title: '备货量'},
                                {
                                    field: 'canUseNum', title: '库存', formatter: function (value) {
                                        return '<span class="inventory" >' + value + '</span>';
                                    }
                                },
                                {
                                    field: '', title: '数量', formatter: function (value, row, index) {
                                        return '<input type="number" class="in-yj-input" placeholder="数量" value="1">';
                                    }
                                },
                                {
                                    field: '', title: '来源', formatter: function (value, row, index) {
                                        return '<div>本店</div>'
                                    }
                                },
                                {
                                    field: '', title: '操作', formatter: function (value, row, index) {
                                        return '<div class="btnSeeHistory" onclick=\'addConventionalProducts(' + spuid + ',' + JSON.stringify(row) + ','+index+')\'>添加</div>';
                                    }
                                }
                            ]
                        } else if (categoryName === '隐形眼镜') {
                            column = [
                                {field: 'code', title: '产品编码'},
                                {
                                    field: 'properties', title: '球', formatter: function (value) {
                                        return value[15];
                                    }
                                },
                                {
                                    field: 'properties', title: '柱', formatter: function (value) {
                                        return value[16];
                                    }
                                },
                                /* {field: '', title: '生产批号'  , formatter: function (value,row,index) {
                                             return '<input type="number" class="in-yj-input-shengchanpihao" data-index="'+index+'" placeholder="生产批号">';
                                         }
                                     },
                                     {field: '', title: '保质期'  , formatter: function (value,row,index) {
                                             return '<input type="number" class="in-yj-input-time yj-date" readonly="readonly" onfocus="selectTime(this)" data-index="'+index+'" placeholder="保质期">';
                                         }
                                     },*/
                                {
                                    field: 'costPrice', title: '成本价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {
                                    field: 'retailPrice', title: '零售价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {field: 'num', title: '备货量'},
                                {
                                    field: 'canUseNum', title: '库存', formatter: function (value) {
                                        return '<span class="inventory" >' + value + '</span>';
                                    }
                                },
                                {
                                    field: '', title: '数量', formatter: function (value, row, index) {
                                        return '<input type="number" class="in-yj-input" placeholder="数量" value="1">';
                                    }
                                },
                                {
                                    field: '', title: '来源', formatter: function (value, row, index) {
                                        return '<div>本店</div>'
                                    }
                                },
                                {
                                    field: '', title: '操作', formatter: function (value, row, index) {
                                        return '<div class="btnSeeHistory" onclick=\'addConventionalProducts(' + spuid + ',' + JSON.stringify(row) + ','+index+')\'>添加</div>';
                                    }
                                }
                            ]
                        } else if (categoryName === '护理产品') {
                            column = [
                                {field: 'code', title: '产品编码'},
                                /*{field: '', title: '生产批号'  , formatter: function (value,row,index) {
                                            return '<input type="text" class="in-yj-input-shengchanpihao" data-index="'+index+'" placeholder="生产批号">';
                                        }
                                    },
                                    {field: '', title: '保质期'  , formatter: function (value,row,index) {
                                            return '<input type="text" class="in-yj-input-time yj-date" readonly="readonly" onfocus="selectTime(this)" data-index="'+index+'" placeholder="保质期">';
                                        }
                                    },*/
                                {
                                    field: 'costPrice', title: '成本价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {
                                    field: 'retailPrice', title: '零售价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {field: 'num', title: '备货量'},
                                {
                                    field: 'canUseNum', title: '库存', formatter: function (value) {
                                        return '<span class="inventory" >' + value + '</span>';
                                    }
                                },
                                {
                                    field: '', title: '数量', formatter: function (value, row, index) {
                                        return '<input type="number" class="in-yj-input" placeholder="数量" value="1">';
                                    }
                                },
                                {
                                    field: '', title: '来源', formatter: function (value, row, index) {
                                        return '<div>本店</div>'
                                    }
                                },
                                {
                                    field: '', title: '操作', formatter: function (value, row, index) {
                                        return '<div class="btnSeeHistory" onclick=\'addConventionalProducts(' + spuid + ',' + JSON.stringify(row) + ','+index+')\'>添加</div>';
                                    }
                                }
                            ]
                        } else if (categoryName === '其它商品') {
                            column = [
                                {field: 'code', title: '产品编码'},
                                /* {field: '', title: '型号'  , formatter: function (value,row,index) {
                                             return '<input type="text" class="in-yj-input-xinghao" data-index="'+index+'" placeholder="型号">';
                                         }
                                     },*/
                                {
                                    field: 'costPrice', title: '成本价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {
                                    field: 'retailPrice', title: '零售价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {field: 'num', title: '备货量'},
                                {
                                    field: 'canUseNum', title: '库存', formatter: function (value) {
                                        return '<span class="inventory" >' + value + '</span>';
                                    }
                                },
                                {
                                    field: '', title: '数量', formatter: function (value, row, index) {
                                        return '<input type="number" class="in-yj-input" placeholder="数量" value="1">';
                                    }
                                },
                                {
                                    field: '', title: '来源', formatter: function (value, row, index) {
                                        return '<div>本店</div>'
                                    }
                                },
                                {
                                    field: '', title: '操作', formatter: function (value, row, index) {
                                        return '<div class="btnSeeHistory" onclick=\'addConventionalProducts(' + spuid + ',' + JSON.stringify(row) + ','+index+')\'>添加</div>';
                                    }
                                }
                            ]
                        } else if (categoryName === '特殊商品') {
                            column = [
                                {field: 'code', title: '产品编码'},
                                /* {field: '', title: '型号'  , formatter: function (value,row,index) {
                                             return '<input type="text" class="in-yj-input-xinghao" data-index="'+index+'" placeholder="型号">';
                                         }
                                     },*/
                                {
                                    field: 'costPrice', title: '成本价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {
                                    field: 'retailPrice', title: '零售价', formatter: function (value) {
                                        return "¥" + (value / 100).toFixed(2);
                                    }
                                },
                                {field: 'num', title: '备货量'},
                                {
                                    field: 'canUseNum', title: '库存', formatter: function (value) {
                                        return '<span class="inventory" >' + value + '</span>';
                                    }
                                },
                                {
                                    field: '', title: '数量', formatter: function (value, row, index) {
                                        return '<input type="number" class="in-yj-input" placeholder="数量" value="1">';
                                    }
                                },
                                {
                                    field: '', title: '来源', formatter: function (value, row, index) {
                                        return '<div>本店</div>'
                                    }
                                },
                                {
                                    field: '', title: '操作', formatter: function (value, row, index) {
                                        return '<div class="btnSeeHistory" onclick=\'addConventionalProducts(' + spuid + ',' + JSON.stringify(row) + ','+index+')\'>添加</div>';
                                    }
                                }
                            ]
                        }
                    } else if (locOrder.type == 1) {
                        column = [
                            {field: 'code', title: '产品编码'},
                            {
                                field: 'integralPrice', title: '积分价', formatter: function (value) {
                                    return '<span><i class="jfPrice">' + value + '</i>积分</span>';
                                }
                            },
                            {
                                field: 'canUseNum', title: '库存', formatter: function (value) {
                                    return '<span class="inventory" >' + value + '</span>';
                                }
                            },
                            {
                                field: '', title: '上限', formatter: function () {
                                    return '<span class="shangxian" >' + integralNum + '</span>';
                                }
                            },
                            {
                                field: '', title: '可用积分', formatter: function () {
                                    if (userScore) {
                                        return '<span><i class="jifen">' + userScore + '</i>积分</span>';
                                    } else {
                                        return '<span><i class="jifen">0</i>积分</span>';
                                    }
                                }
                            },
                            {
                                field: '', title: '数量', formatter: function (value, row, index) {
                                    return '<input type="number" class="in-yj-input" placeholder="数量" value="1">';
                                }
                            },
                            {
                                field: '', title: '来源', formatter: function (value, row, index) {
                                    return '<div>本店</div>'
                                }
                            },
                            {
                                field: '', title: '操作', formatter: function (value, row, index) {
                                    return '<div class="btnSeeHistory" onclick=\'addConventionalProducts(' + spuid + ',' + JSON.stringify(row) + ','+index+')\'>添加</div>';
                                    /*
                                                                        if (type == 0) {
                                                                            return '<div class="btnSeeHistory" onclick="addConventionalProducts(' + spuid + ',' + row.id + ',' + row.code + ',' + row.retailPrice + ',' + index + ')">添加</div>';
                                                                        } else if (type == 1) {
                                                                            return '<div class="btnSeeHistory" onclick="addConventionalProducts(' + spuid + ',' + row.id + ',' + row.code + ',' + row.integralPrice + ',' + index + ')">添加</div>';
                                                                        }
                                    */
                                }
                            }
                        ]
                    }
                    $("#skuTable").bootstrapTable('destroy');
                    $("#skuTable").bootstrapTable({
                        data: ret.data,                 //被加载的数据。
                        classes: "table",
                        sortable: false,
                        sortOrder: "asc",
                        showColumns: true,
                        strictSearch: true,
                        locale: "zh-CN",
                        paginationHAlign: "center",
                        clickToSelect: true,
                        columns: column
                    });
                }
            } else {
                layer.msg(ret.data)
            }
        })
    }
    /**获取会员信息*/
    function getMemberInfo() {
        locMember = {};//initialize 会员信息
        quakooData.ajaxGetData(config.getUrl_usergrade_load(),{
            id:cusLocInfo.userGradeId
        },function (ret) {
            if(ret&&ret.success){
                for(var i in ret.data){
                    locMember[i] = ret.data[i];
                }
                console.log("会员信息",locMember)
            }
        })
    }
    /**促销方式*/
    function getListPromotions() {
        quakooData.ajaxGetData(config.getUrl_marketingcoupon_getCanUseList(), {subid:psid}, function (ret) {
            if (ret && ret.success) {
                if (quakooUtils.isNotBlack(ret.data)) {
                    var html = '';
                    for (var i = 0; i < ret.data.length; i++) {
                        couponData[ret.data[i].id] = ret.data[i];
                        html += '<li value="' + ret.data[i].id + '">' + ret.data[i].title + '</li>'
                    }
                    $("#ListPromotions").html(html);
                    selectTag($("#promotion"), function (ret) {
                        if(quakooUtils.isNotBlack(locShopCart.skuidsList)){
                            locShopCart.couponId = ret.value;
                            countOrder();
                        }else{
                            layer.msg('请选择常规商品')
                        }
/*
                        quakooData.ajaxGetData(config.getUrl_marketingcoupon_calculateMoney(),{mcId:ret.value,num:locShopCart.goodsNumber,money:locShopCart.dicountPrice},function(ret){
                            console.log("cuxiaojianmian",ret)
                        })
*/
                    });
                } else {
                    $("#ListPromotions").html("暂无促销方式");
                }
            }
        })
    }
    /**接口——获取企业类目列表*/
    function getListClass() {
        quakooData.ajaxGetData(config.getUrl_productCategory_getSubAllList(), {subid: psid}, function (ret) {
            if (ret && ret.success) {
                if (quakooUtils.isNotBlack(ret.data)) {
                    locOrder.class = ret.data[0].id;
                    locOrder.className = ret.data[0].name;
                    var html = "";
                    for (var i = 0; i < ret.data.length; i++) {
                        html += '<li onclick="selClass(this,' + ret.data[i].id + ',\'' + ret.data[i].name + '\')">' + ret.data[i].name + '</li>';
                    }
                    $("#listClass").html(html);
                    $("#listClass li").first().addClass("active");
                } else {
                    layer.msg("没有类目");
                }
            }
        })
    }
    /**接口——获取企业品牌列表*/
    function getListBrand() {
        quakooData.ajaxGetData(config.getUrl_productBrand_getSubAllList(), {subid: psid}, function (ret) {
            if (ret && ret.success) {
                if (quakooUtils.isNotBlack(ret.data)) {
                    locOrder.brand = ret.data[0].id;
                    locOrder.brandName = ret.data[0].name;
                    var html = "";
                    for (var i = 0; i < ret.data.length; i++) {
                        html += '<li onclick="selBrand(this,' + ret.data[i].id + ',\'' + ret.data[i].name + '\')"><span>' + ret.data[i].name + '</span></li>';
                    }
                    $("#listBrand").html(html);
                    $("#listBrand li").first().addClass("active");
                } else {
                    layer.msg("没有品牌");
                }
            }
        })
    }
    /**选择商品类目*/
    function selClass(_self, id, name) {
        $(_self).addClass("active").siblings().removeClass("active");
        locOrder.class = id;
        locOrder.className = name;
        getSPU();
    }
    /**选择商品品牌*/
    function selBrand(_self, id, name) {
        $(_self).addClass("active").siblings().removeClass("active");
        locOrder.brand = id;
        locOrder.brandName = name;
        getSPU();
    }
    /**添加常规商品到订单*/
    function addConventionalProducts(spuid,skuData,index) {
        var quantity = $("#skuTable tr[data-index='" + index + "'] input").val() * 1; //数量
        if (quakooUtils.isBlack(quantity)) {
            layer.msg("请输入添加数量");
            return
        }
        var obj = {};
        obj.spuid = spuid;
        obj.id = skuData.id;
        obj.code = skuData.code;
        obj.num = quantity;
        obj.retailPrice = skuData.retailPrice;
        obj.canUseNum = skuData.canUseNum;
        if(checkList(locShopCart.skuidsList,obj.id).flag){
            locShopCart.skuidsList[checkList(locShopCart.skuidsList,obj.id).index].num += obj.num;
        }else{
            locShopCart.skuidsList.push(obj);
        }
        countOrder()
    }
    /**计算金额接口*/
    function countOrder(){
        var params = {};
        if(quakooUtils.isNotBlack(realpriceChange)){
            params.realPrice = realpriceChange;
            realpriceChange = "";
        }
        params.desc = locShopCart.desc;
        if(quakooUtils.isNotBlack(cusLocInfo.id)){
            params.uid = cusLocInfo.id;
        }
        if(quakooUtils.isNotBlack(locShopCart.saleUid)){
            params.staffId = locShopCart.saleUid;
        }
        if(quakooUtils.isNotBlack(locShopCart.machinistId)){
            params.machinistId = locShopCart.machinistId;
        }
        console.log("params",params);
        if(quakooUtils.isNotBlack(ygInfo.now.id)){
            params.oiId = ygInfo.now.id;
        }
        if(quakooUtils.isNotBlack(locShopCart.bossDiscount)){
            params.discount = String(Number(locShopCart.bossDiscount));
        }else{
            params.discount = String(10);
        }
        if(quakooUtils.isNotBlack(locShopCart.couponId)){
            params.couponId = locShopCart.couponId;
        }
        if(locShopCart.valueCard.length>0){
            params.rechargePrice = locShopCart.valueCard[0].price;
        }
        if(locShopCart.skuidsList.length>0){
            params.skuJson = [];
            for(var i=0;i<locShopCart.skuidsList.length;i++){
                var skuobj = {};
                skuobj.skuId = locShopCart.skuidsList[i].id;
                skuobj.spuId = locShopCart.skuidsList[i].spuid;
                skuobj.num = locShopCart.skuidsList[i].num;
                if(quakooUtils.isNotBlack(locShopCart.skuidsList[i].discount)){
                    skuobj.discount = String(Number(locShopCart.skuidsList[i].discount));
                }
                params.skuJson.push(skuobj);
            }
        }
        if(locShopCart.surchargesJson.length>0){
            params.surchargesJson = [];
            for(var i=0;i<locShopCart.surchargesJson.length;i++){
                params.surchargesJson.push(locShopCart.surchargesJson[i]);
            }
        }
        params.skuJson = JSON.stringify(params.skuJson);
        params.surchargesJson = JSON.stringify(params.surchargesJson);
        quakooData.ajaxGetData(config.getUrl_businessOrder_currentCalculate(),params,function (ret) {
            if(ret&&ret.success){
                if(quakooUtils.isNotBlack(ret.data)){
                    getOrderInfoToLoc(ret.data);
                    renderList();
                }
            }else{
                initOrderData();
                renderList();
                layer.msg(ret.data);
            }
        })

    }
    /**获取订单数据保存为本地对象*/
    function getOrderInfoToLoc(orderData){
        locShopCart = {};
        locShopCart.skuidsList = []; //常规商品
        locShopCart.valueCard = []; //储值卡
        locShopCart.couponArr = []; //优惠券
        locShopCart.surchargesJson = [];//附加费用
        if(orderData.staffId){
            locShopCart.saleUid = orderData.staffId;
        }
        if(orderData.machinistId){
            locShopCart.machinistId = orderData.machinistId;
        }
        if(orderData.desc){
            locShopCart.desc = orderData.desc;
        }
        locShopCart.bossDiscount = orderData.discount;
        locShopCart.originalPrice = orderData.originalPrice;
        locShopCart.discountPrice = orderData.discountPrice;
        locShopCart.collectPrice = orderData.realPrice;
        locShopCart.totalPrice = orderData.totalPrice;
        if(orderData.rechargePrice > 0){
            locShopCart.valueCard[0] = {};
            locShopCart.valueCard[0].name = "储值卡";
            locShopCart.valueCard[0].price = orderData.rechargePrice;
        }
        if(orderData.oddsPrice){
            locShopCart.reductionPrice = orderData.oddsPrice;
        }
        //附加费用
        for(var i = 0;i < orderData.surcharges.length;i++){
            locShopCart.surchargesJson.push(orderData.surcharges[i]);
        }
        if(quakooUtils.isNotBlack(orderData.couponId)){
            locShopCart.couponId = orderData.couponId;
        }
        if(quakooUtils.isNotBlack(orderData.coupon)){
            locShopCart.couponArr[0] = {};
            locShopCart.couponArr[0].id = orderData.coupon.id;
            locShopCart.couponArr[0].name = orderData.coupon.title;
            locShopCart.couponArr[0].price = orderData.coupon.descSubtract;
        }
        for(var i = 0;i < orderData.skuList.length;i++){
            locShopCart.skuidsList[i] = {};
            locShopCart.skuidsList[i].spuid = orderData.skuList[i].spuId;
            locShopCart.skuidsList[i].id = orderData.skuList[i].skuId;
            locShopCart.skuidsList[i].code = orderData.skuList[i].code;
            locShopCart.skuidsList[i].subtotal = orderData.skuList[i].subtotal;
            locShopCart.skuidsList[i].num = orderData.skuList[i].num;
            locShopCart.skuidsList[i].retailPrice = orderData.skuList[i].price;
            locShopCart.skuidsList[i].discount = orderData.skuList[i].discount;
            locShopCart.skuidsList[i].canUseNum = orderData.skuList[i].canUseNum;
        }
    }

    /**检查list是否包含某一项*/
    function checkList(arr,id) {
        var obj={};
        obj.flag = false;
        for(var i=0;i<arr.length;i++){
            if(arr[i].id == id){
                obj.flag = true;
                obj.index = i;
                break;
            }
        }
        return obj;
    }
    /**查看历史记录*/
    function hisOrder() {
        var index = layer.open({
            type: 1,
            skin: '',
            area: ['720px', '500px'],
            anim: 0,
            closeBtn: 0,
            title: '历史消费记录',
            shade: 0.1,
            shadeClose: true,
            scrollbar: false,
            content: $('.historyRecord'),
            resize: false,
            btn: '关闭窗口',
            move: '.layui-layer-title',
            yes: function (index, layero) {
                layer.close(index);
            },
            success: function (layero) {
                renderHistory()
            },
        });

        function renderHistory() {
            //历史消费记录
            $("#cmMain-table1").bootstrapTable('destroy');
            $("#cmMain-table1").bootstrapTable({
                url: config.getUrl_order_getAllOrder(),
                method: 'get',
                classes: "table",
                pagination: true,                     //是否显示分页
                sidePagination: "server",             //分页方式：client客户端分页，server服务端分页（*）
                pageNumber: 1,                        //初始化加载第一页，默认第一页
                pageSize: 8,
                pageList: [5, 10, 15, 20],
                sortable: false,
                sortOrder: "asc",
                showColumns: true,
                strictSearch: true,
                locale: "zh-CN",
                paginationHAlign: "center",
                clickToSelect: true,
                columns: [
                    {field: "payTime", title: "时间", align: "left", valign: "middle"},
                    {field: "subName", title: "门店", align: "left", valign: "middle"},
                    {field: "personnelName", title: "销售员", align: "left", valign: "middle"},
                    {field: "title", title: "订单明细", align: "left", valign: "middle", width: '31.5%'},
                    {field: "priceYuan", title: "消费金额", align: "left", valign: "middle"},
                    {
                        field: "btn", title: "操作", align: "left", valign: "middle", formatter: function () {
                            return '<div class="btnSeeHistory">查看</div>'
                        }
                    }
                ],
                queryParams: function (params) {
                      params.page = this.pageNumber;
                    params.size = this.pageSize;
                    params.token = quakooUser.getUserInfo().token;
                    params.uid = cusLocInfo.id;
                    params.subId = subid;
                    return params;
                },
                success: function () {

                },
                onLoadSuccess: function (data) {
                }
            });

        }
    }
    /**保存订单*/
    function saveOrder(type) {
        var params = {};
        if(quakooUtils.isNotBlack(cusLocInfo.id)){
            params.uid = cusLocInfo.id;
        }
        if(quakooUtils.isBlack(locShopCart.saleUid)){
            layer.msg("请选择销售员");
            return;
        }
        if(quakooUtils.isBlack(locShopCart.surchargesJson)&&quakooUtils.isBlack(locShopCart.skuidsList)&&quakooUtils.isBlack(locShopCart.valueCard)){
            layer.msg("订单不能为空");
            return
        }
        params.subId = subid;
        if(ygInfo.now.id){
            params.oiId = ygInfo.now.id;
        }
        params.staffId = locShopCart.saleUid;
        params.machinistId = locShopCart.machinistId;
        params.desc = locShopCart.desc;
        params.originalPrice = locShopCart.originalPrice;
        params.discountPrice = locShopCart.discountPrice;
        params.realPrice = locShopCart.collectPrice;
/*
        if(type != true){//提交订单的时候不传
            params.totalPrice = locShopCart.totalPrice;
        }else{
        }
*/
        params.totalPrice = locShopCart.totalPrice;
        params.oddsPrice = locShopCart.reductionPrice;
        params.discount = locShopCart.bossDiscount;
        if(locShopCart.valueCard.length>0){
            params.rechargePrice = locShopCart.valueCard[0].price;
        }
        if (type){
            params.makeStatus = 8;
        }else{
            params.makeStatus = 6;
        }
        if(quakooUtils.isNotBlack(locShopCart.couponId)&&quakooUtils.isNotBlack(locShopCart.couponArr)){
            params.couponId = locShopCart.couponArr[0].id;
            params.couponFee = locShopCart.couponArr[0].price;
        }
        if(locShopCart.skuidsList.length>0){
            params.skuJson = [];
            for(var i=0;i<locShopCart.skuidsList.length;i++){
                params.skuJson[i] = {};
                params.skuJson[i].skuId = locShopCart.skuidsList[i].id;
                params.skuJson[i].spuId = locShopCart.skuidsList[i].spuid;
                params.skuJson[i].num = locShopCart.skuidsList[i].num;
                params.skuJson[i].price = locShopCart.skuidsList[i].retailPrice;
                params.skuJson[i].code = locShopCart.skuidsList[i].code;
                params.skuJson[i].subtotal = locShopCart.skuidsList[i].code;
            }
        }
        if(locShopCart.surchargesJson.length>0){
            params.surchargesJson=[];
            for(var i=0;i<locShopCart.surchargesJson.length;i++){
                params.surchargesJson[i] = {};
                params.surchargesJson[i].name = locShopCart.surchargesJson[i].name;
                params.surchargesJson[i].price = locShopCart.surchargesJson[i].price;
            }
        }
        params.skuJson = JSON.stringify(params.skuJson);
        params.surchargesJson = JSON.stringify(params.surchargesJson);
        quakooData.ajaxGetData(config.getUrl_businessOrder_saveOrder(),params,function (ret) {
            if(ret&&ret.success){
                if(type){//提交订单
                    /*结算清单初始化*/
                    settlementList.noPayNum = ret.data.realPrice;
                    settlementList.total = 0;
                    settlementList.integral = {};
                    settlementList.valueCard = {};
                    settlementList.integral.hasNum = ret.data.score;
                    settlementList.valueCard.hasNum = ret.data.money;
                    settlementList.otherValue = {};
                    settlementList.otherValue.type = 1;
                    for(var i in ret.data){
                        receiptInfo[i] = ret.data[i];
                    }
                    submitOrder();
                }else{//保存订单
                    layer.msg("订单已保存")
                }
            }else{
                layer.msg(ret.data)
            }
        })

    }
    /**提交订单*/
    function submitOrder() {
        printId = 0;
        layer.open({
            type: 1,
            skin: 'submit-Payment', //样式类名
            area: ['600px', '560px'],
            anim: 0,
            closeBtn: 0,
            title: false,
            shade: 0.01,
            shadeClose: true, //开启遮罩关闭
            scrollbar: false,
            content: $('.wholeParagraph '),
            resize: false,
            btn: ['结算并打印小票', '取消'],
            move: $('.title'),
            yes: function (index, layero) {
                if (printId) {
                    printReceipts();
                } else {
                    layer.msg("请先完成支付");
                }
            },
            btn2: function (index, layero) {
            },
            success: function (layero, index) {
                //底部取货勾选框
//                        $('.layui-layer-btn').prepend('<div class="noPickUp"><input type="checkbox" id="week" /><label for="week">未取货</label></div>')
                //渲染订单数据
                renderSubmit();
            }

        });
    }
    /**渲染提交订单信息*/
    function renderSubmit() {
        var html = template('payDiaVerticalList', {orderInfo: locShopCart,settlement:settlementList});
        //var printHtml = template('printTicketTmp', {orderInfo: locOrderData});
       //printContent = printHtml;
        $('#payDiaVertical').html(html);
        //$('#printTicketUl').html(printHtml);
    }
    /**获取订单详情*/
    function getOrderInfo(orderId){
        quakooData.ajaxGetData(config.getUrl_order_loadOrder(),{id:orderId},function (ret) {
            console.log("订单详情",ret);
        })
    }
    /**线上付款*/
    function payDialog(type) {//前端定type：1 => 支付宝，2 => 微信
        // var paymentNote = $('#paymentNote').val();
        // if (quakooUtils.isBlack(paymentNote)) {
        //     layer.msg('请输入小票备注');
        //     return;
        // }
        payType = type;
        var title;
        if (type == 1) {
            title = '<h3 class="set-title">支付宝支付</h3>';
        } else if (type == 2) {
            title = '<h3 class="set-title">微信支付</h3>';
        }
        layer.open({
            type: 1,
            skin: '', //样式类名
            area: '600px',
            anim: 0,
            closeBtn: 0,
            title: title,
            shade: 0.1,
            shadeClose: true, //开启遮罩关闭
            scrollbar: false,
            content: $('.paymentPopup'),
            resize: false,
            btn: false,
            move: $('.title'),
            success: function (layero, index) {
                payDialogIndex = index;
                redraw();
            }
        });
    }
    function closePay() {
        layer.close(payDialogIndex);
    }
    //重绘
    function redraw() {
        $('.paymentPopup .speedProgress li').removeClass("active").eq(0).addClass("active");
        $('.paymentPopup .payContent .content-item').removeClass('active');
        $('.paymentPopup .payContent .content-item.first').addClass('active');
        $('.paymentPopup .payContent input').val('');
    }
    //btn——输入金额下一步
    function firstNext() {
        onlinePayMoney = $('#payNum').val()*100;
        if (quakooUtils.isBlack(onlinePayMoney)) {
            layer.msg("请输入金额");
            return;
        }
        $('.paymentPopup .speedProgress li').removeClass("active").eq(1).addClass("active");
        $('.paymentPopup .payContent .content-item').removeClass('active');
        $('.paymentPopup .payContent .content-item.second').addClass('active');
        $('.paymentPopup .payContent .content-item.second input').val('');
    }

    //btn——扫码支付上一步
    function secondPre() {
        $('.paymentPopup .speedProgress li').removeClass("active").eq(0).addClass("active");
        $('.paymentPopup .payContent .content-item').removeClass('active');
        $('.paymentPopup .payContent .content-item.first').addClass('active');
    }

    //btn——扫码支付下一步
    function secondNext() {
        var param = {};
        var authCode = $('#testCode').val();
        if (quakooUtils.isBlack(authCode)) {
            layer.msg('请输入条形码', {icon: 1});
            return;
        }
        param.boId = receiptInfo.id;
        param.price = onlinePayMoney.toFixed(0);
        param.authCode = authCode;
        param.type = 1;
        if (payType == 1) {
            quakooData.ajaxGetData(config.getUrl_order_handleAliBarcodeOrder(), param, function (ret) {
                if(ret&&ret.success){
                    settlementList.ali={};
                    settlementList.ali.money = ret.data.price;
                    settlementList.ali.id = ret.data.id;
                    settlementList.ali.status = 1;
                    settlementList.noPayNum = settlementList.noPayNum - settlementList.ali.money;
                    settlementList.total = settlementList.total + settlementList.ali.money;
                    $('.paymentPopup .speedProgress li').removeClass("active").eq(2).addClass("active");
                    $('.paymentPopup .payContent .content-item').removeClass('active');
                    $('.paymentPopup .payContent .content-item.third').addClass('active');
                    renderSubmit();
                    layer.msg("支付成功");
                }else{
                    if(quakooUtils.isNotBlack(ret.data)){
                        layer.msg(ret.data);
                    }else{
                        layer.msg("支付失败",{icon:1})
                    }
                }
            });
        } else if (payType == 2) {
            quakooData.ajaxGetData(config.getUrl_order_handleWxBarcodeOrder(), param, function (ret) {
                if(ret&&ret.success){
                    settlementList.weixin={};
                    settlementList.weixin.money = ret.data.price;
                    settlementList.weixin.id = ret.data.id;
                    settlementList.weixin.status = 1;
                    settlementList.noPayNum = settlementList.noPayNum - settlementList.weixin.money;
                    settlementList.total = settlementList.total + settlementList.weixin.money;
                    $('.paymentPopup .speedProgress li').removeClass("active").eq(2).addClass("active");
                    $('.paymentPopup .payContent .content-item').removeClass('active');
                    $('.paymentPopup .payContent .content-item.third').addClass('active');
                    renderSubmit();
                    layer.msg("支付成功");
                }else{
                    if(quakooUtils.isNotBlack(ret.data)){
                        layer.msg(ret.data);
                    }else{
                        layer.msg("支付失败",{icon:1})
                    }
                }
            })
        }
    }

    //btn——完成支付
    function finish() {
        closePay();
    }

    /**
     * 线下支付
     * @param type:1（现金）；2（储值卡）；3（他人储值卡）
     */
    function countOffline(_self,type){
        console.log(23);
        var price = _self.value * 100;
        if(price<0){
            layer.msg("非法输入");
            return;
        }
        if(type == 1){
            settlementList.cash = price;
        }else if(type == 2){
            if(price>settlementList.valueCard.hasNum){
                layer.msg("储值卡余额不足");
                return;
            }
            settlementList.valueCard.usedNum = price;
        }else if(type == 3){
            if(settlementList.otherValue.type==1){
                layer.msg("未验证");
                return;
            }
            if(price>settlementList.otherValue.hasNum){
                layer.msg("储值卡余额不足");
                return;
            }
            settlementList.otherValue.usedNum = price;
        }
        settlementList.noPayNum = Number(settlementList.noPayNum) - price;
        settlementList.total = Number(settlementList.total) + price;
        renderSubmit()
     }

    /**退款弹窗*/
    function reimburse(type) {
        var price;
        type = type||payType;
        if(type == 1){
            price = settlementList.ali.money;
        }else if(type == 2){
            price = settlementList.weixin.money;
        }
        layer.open({
            type: 1,
            shade: 0.01,
            title: '确定退款？',
            skin: 'layui-layer-removeStaff-tan', //样式类名
            anim: 0,
            area: ['240px', '130px'],
            closeBtn: 0, //不显示关闭按钮
            resize: false,
            shadeClose: true, //开启遮罩关闭
            content: $('.content-view-removeStaff'),
            btn: ['确定', '取消'],
            yes: function (index) {
                if (type == 1) {
                    quakooData.ajaxGetData(config.getUrl_order_createAliRefundOrder(), {oid: settlementList.ali.id}, function (ret) {
                        if (ret && ret.data) {
                            quakooData.ajaxGetData(config.getUrl_order_handleAliRefundOrder(), {roid: ret.data.id}, function (ret) {
                                if (ret && ret.success && ret.data) {
                                    settlementList.ali.status = 2;
                                    renderSubmit();
                                    layer.msg("退款成功", {icon: 1});
                                    layer.close(index);
                                    if(payDialogIndex){
                                        layer.close(payDialogIndex);
                                    }
                                } else {
                                    layer.msg("退款失败");
                                }
                            })
                        }else{
                            layer.msg(ret.data)
                        }
                    })
                } else if (type == 2) {
                    quakooData.ajaxGetData(config.getUrl_order_createWxRefundOrder(), {oid: oid}, function (ret) {
                        if (ret && ret.data) {
                            quakooData.ajaxGetData(config.getUrl_order_handleWxRefundOrder(), {roid: ret.data.id}, function (ret) {
                                if (ret && ret.success && ret.data) {
                                    settlementList.weixin.status = 2;
                                    renderSubmit();
                                    layer.msg("退款成功", {icon: 1});
                                    layer.close(index);
                                    if(payDialogIndex){
                                        layer.close(payDialogIndex);
                                    }
                                } else {
                                    layer.msg("退款失败");
                                }
                            })
                        } else {
                            layer.msg("退款失败");
                            layer.close(index);
                        }
                    })
                }
            },
            btn2: function (index) {

            },
            success:function (layero, index) {
                $('.content-view-removeStaff p').html("确定退款"+ (price/100).toFixed(2) +"元？");
            }

        });
    }

    /**结算并打印小票*/
    function printReceipts() {
        var index = layer.open({
            type: 1,
            shade: 0.01,
            title: '',
            skin: '', //样式类名
            anim: 0,
            area: ['270px', '500px'],
            closeBtn: 0, //不显示关闭按钮
            resize: false,
            shadeClose: true, //开启遮罩关闭
            content: $('#printBox'),
            btn: '',
            success: function () {
                $('#printBox').html(printContent);
                $('#smallTicketBg').css("display", 'none')
            }
        })
    }

    /***************************************************订单信息结束*****************************************************/

</script>
</body>

</html>